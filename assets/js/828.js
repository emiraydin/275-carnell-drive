(self.webpackChunkmp_webgl=self.webpackChunkmp_webgl||[]).push([[828],{79966:(e,t,s)=>{"use strict";s.r(t),s.d(t,{BatchToggleBlurVisibilityCommand:()=>c,BlurToolChangeCommand:()=>a,BlurToolState:()=>i,HideBlursCommand:()=>u,NavigateToBlurCommand:()=>o,SetBlurBrushScaleCommand:()=>r,ShowBlursCommand:()=>d,ToggleBlurVisibilityCommand:()=>l,default:()=>ps});var i,n=s(19663);class a extends n.m{constructor(e){super(),this.id="BLUR_TOOL_CHANGE",this.payload={state:e}}}class r extends n.m{constructor(e){super(),this.id="SET_BLUR_BRUSH_SCALE",this.payload={scale:e}}}class o extends n.m{constructor(e,t=!1){super(),this.id="NAVIGATE_TO_BLUR",this.payload={blur:e,resetBlurTool:t}}}class l extends n.m{constructor(e){super(),this.id="TOGGLE_BLUR_VISIBILITY",this.payload={id:e}}}class d extends n.m{constructor(...e){super(),this.id="SHOW_BLURS",this.payload={ids:e}}}class u extends n.m{constructor(...e){super(),this.id="HIDE_BLURS",this.payload={ids:e}}}class c extends n.m{constructor(e){super(),this.id="BATCH_TOGGLE_BLUR_VISIBILITY",this.payload={ids:e}}}!function(e){e.OFF="off",e.IDLE="idle",e.PAINTING="painting",e.SUGGESTING="suggesting"}(i||(i={}));var h,m=s(81396),g=s(97542),p=s(69170),b=s(35895),f=s(53954),v=s(86819),S=s(67678),B=s(89553),w=s(66222),C=s(98333),y=s(13117),E=s(66310),T=s(9037),x=s(38987),I=s(34956),D=s(85992),_=s(23254),P=s(95882),k=s(12039),O=s(64918),R=s(90304),A=s(2569),N=s(76631),L=s(89549),M=s(40964),G=s(91380),U=s(50892),j=s(17878),F=s(12529),z=s(49827),V=s(97998),H=s(80592),Q=s(59370),W=s(92826),Y=s(89570),q=s(37082);!function(e){e.DISABLED="disabled",e.IDLE="idle",e.PAINTING="painting"}(h||(h={}));class $ extends m.Object3D{constructor(){super(),this._radius=.1,this._thickness=.005,this.name="SphereBrushCursor";const e=new m.MeshBasicMaterial({color:16777215,side:m.DoubleSide,depthTest:!1,transparent:!0}),t=this.getGeometry();this.mesh=new m.Mesh(t,e),this.mesh.renderOrder=F.z.reticule,this.add(this.mesh)}getGeometry(){return new m.RingGeometry(this._radius,this._radius+this._thickness,64)}updateCursorMesh(){this.mesh.geometry.dispose(),this.mesh.geometry=this.getGeometry()}get radius(){return this._radius}set radius(e){this._radius=e,this.updateCursorMesh()}dispose(){this.mesh.material.dispose(),this.mesh.geometry.dispose()}}const Z=new V.Z("pano-brush");class K{constructor(e,t,s,i,n=j.o.ALL){this.sweepData=e,this.cameraData=t,this.scene=s,this.input=i,this.cameraVector=new m.Vector3,this.lastPaint=new m.Vector3,this.mouseCursorEnabled=!1,this.needsUpdate=!0,this.observables={size:new q.f(.1),scale:new q.f(.2),feather:new q.f(.1),pressure:new q.f(.1),opacity:new q.f(1),state:new q.f(h.DISABLED)},this.position=new m.Vector3,this.direction=new m.Vector3,this.sizeRange=[.1,.5],this.featherRange=[.005,.125],this.pressureRange=[.0063,.0125],this.onPointerButton=e=>e.down?this.startPainting():this.stopPainting(),this.onPointerMove=e=>{const t=(0,Q.st)(this.cameraData,e.position);if(this.setPosition(t),this.state===h.PAINTING&&this.onPaint){const e=(0,A.et)(this.observables.size.value,this.sizeRange[0],this.sizeRange[1],.005,.03);if(this.lastPaint.length()>0){const t=this.direction.clone().sub(this.lastPaint).setLength(e),s=this.lastPaint.clone();for(;s.angleTo(this.direction)>e;)s.add(t).normalize(),this.lastPaint.copy(s),this.onPaint(s,this.observables.size.value,this.observables.feather.value,this.observables.pressure.value)}else this.lastPaint.copy(this.direction),this.onPaint(this.direction,this.observables.size.value,this.observables.feather.value,this.observables.pressure.value)}},this.onClick=e=>{const t=(0,Q.st)(this.cameraData,e.position);this.setPosition(t),this.onPaint&&this.onPaint(this.direction,this.observables.size.value,this.observables.feather.value,this.observables.pressure.value)},this.onMouseMove=e=>{const{tagName:t}=e.target||{},s=this.mouseCursorEnabled||!t||"CANVAS"!==t?null:I.C.NONE;s!==this.mouseCursor&&(this.engine.commandBinder.issueCommand(new x.u(s)),this.mouseCursor=s)},this.brushCursor=new $,this.brushCursor.renderOrder=F.z.reticule,this.brushCursor.layers.mask=n.mask}init(){this.bindings=new Y.V(this.input.registerPriorityHandler(H._t,m.Mesh,(()=>!0)),this.input.registerHandler(S.mE,this.onPointerMove),this.input.registerHandler(S.er,this.onPointerButton),this.input.registerUnfilteredHandler(v.R,this.onClick),new W.r(document.body,"mousemove",this.onMouseMove)),this.bindings.cancel()}render(){this.state!==h.DISABLED&&this.needsUpdate&&(this.brushCursor.position.copy(this.position),this.brushCursor.lookAt(this.scene.camera.getWorldPosition(this.cameraVector)),this.needsUpdate=!1)}dispose(){this.brushCursor.dispose()}activate(e){this.engine=e}deactivate(e){this.disable()}enable(){Z.debug("Enabled"),this.observables.state.value=h.IDLE,this.bindings.renew(),this.scene.add(this.brushCursor)}disable(){Z.debug("Disabled"),this.observables.state.value=h.DISABLED,this.bindings.cancel(),this.scene.remove(this.brushCursor),this.engine.commandBinder.issueCommand(new x.u(null))}onPropertyChanged(e,t){return this.observables[e].onChanged(t)}getSizeRange(){return this.sizeRange}setSizeRange(e,t){this.sizeRange=[e,t],this.scale=this.observables.scale.value}get scale(){return this.observables.scale.value}set scale(e){const t=(0,z.uZ)(e,0,1),s=(0,A.dS)(t,0,1,this.sizeRange[0],this.sizeRange[1]),i=(0,A.dS)(t,0,1,this.featherRange[0],this.featherRange[1]),n=(0,A.dS)(t,0,1,this.pressureRange[0],this.pressureRange[1]);this.brushCursor.radius=s,this.observables.size.value=s,this.observables.scale.value=t,this.observables.feather.value=i,this.observables.pressure.value=n,Z.debug(`Set brush scale to ${100*t}% (${s})`)}get state(){return this.observables.state.value}get size(){return this.observables.size.value}set size(e){const t=(0,z.uZ)(e,this.sizeRange[0],this.sizeRange[1]),s=(0,A.dS)(t,this.sizeRange[0],this.sizeRange[1],0,1),i=(0,A.dS)(t,this.sizeRange[0],this.sizeRange[1],this.featherRange[0],this.featherRange[1]),n=(0,A.dS)(t,this.sizeRange[0],this.sizeRange[1],this.pressureRange[0],this.pressureRange[1]);this.brushCursor.radius=t,this.observables.size.value=t,this.observables.scale.value=s,this.observables.feather.value=i,this.observables.pressure.value=n,Z.debug(`Set brush size to ${t} (${100*s}%)`)}toggleMouseCursor(e){this.mouseCursorEnabled=e}startPainting(){this.observables.state.value=h.PAINTING}stopPainting(){this.observables.state.value=h.IDLE,this.lastPaint.set(0,0,0)}setPosition(e){const t=this.sweepData.currentSweepObject;if(!t)return;const s=e.clone().sub(t.position).normalize(),i=t.position.clone().add(s);this.position.copy(i),this.direction.copy(s),this.needsUpdate=!0}}class J extends m.InstancedMesh{}var X=s(947),ee=s(58611),te=s(41187),se=s(18923);const ie={brush:{uniforms:{opacity:{type:"v3",value:new m.Vector3(1,1,1)},color:{type:"c",value:new m.Color},radius:{type:"v3",value:new m.Vector3(.1,.1,.1)},feather:{type:"v3",value:new m.Vector3(0,0,0)}},vertexShader:s(59285),fragmentShader:s(65794)},combineBlurs:{uniforms:{maskMatrix:{type:"m4",value:new m.Matrix4},maskTexture:{type:"t",value:null},panoMatrix1:{type:"m4",value:new m.Matrix4},panoMatrix2:{type:"m4",value:new m.Matrix4},panoBlurredMap0:{type:"t",value:null},panoBlurredMap1:{type:"t",value:null},panoBlurredMap2:{type:"t",value:null},panoBlurredMap3:{type:"t",value:null}},vertexShader:s(77288),fragmentShader:s(34468)}};var ne=s(36074);const ae=new m.Matrix4;function re(e){const t=new m.WebGLCubeRenderTarget(e,{format:m.RGBAFormat,generateMipmaps:!1,depthBuffer:!1,stencilBuffer:!1});return t.texture.image={},t.texture.image.width=e,t.texture.image.height=e,t}class oe{constructor(e,t,s){this.inputSize=e,this.outputSize=t,this.sigma=s,this.input=re(e),this.output=re(t)}get texture(){return this.output.texture}}class le{constructor(e,t){this.renderToTexture=e,this.renderer=t,this.renderTarget=new m.WebGLCubeRenderTarget(2048,{format:m.RGBAFormat,generateMipmaps:!1,depthBuffer:!1,stencilBuffer:!1}),this.camera=new m.PerspectiveCamera,this.blurRTs=ne.TW.map((e=>((e,t,s)=>{const i=new oe(e,t,s);return{renderTarget:i,cubeCamera:new m.CubeCamera(.1,1e3,i.output)}})(e.size,2*e.size,e.sigma))),this.debug={};const s=m.UniformsUtils.clone(ie.combineBlurs.uniforms);this.material=new m.RawShaderMaterial({fragmentShader:ie.combineBlurs.fragmentShader,vertexShader:ie.combineBlurs.vertexShader,uniforms:s,side:m.DoubleSide,name:"CubemapRendererMaterial"}),this.mesh=new m.Mesh(new m.BoxGeometry(100,100,100),this.material),this.material.uniforms.panoBlurredMap0.value=this.blurRTs[0].renderTarget.texture,this.material.uniforms.panoBlurredMap1.value=this.blurRTs[1].renderTarget.texture,this.material.uniforms.panoBlurredMap2.value=this.blurRTs[2].renderTarget.texture,this.material.uniforms.panoBlurredMap3.value=this.blurRTs[3].renderTarget.texture,this.renderTarget.texture.image={},this.renderTarget.texture.image.height=2048,this.renderTarget.texture.image.width=2048}setDebug(e,t){t?this.debug[e]=!0:this.debug[e]&&delete this.debug[e],this.material.defines=this.debug,this.material.needsUpdate=!0,this.render()}render(){this.renderToTexture.render(this.renderTarget,this.mesh,this.camera)}get texture(){return this.renderTarget.texture}setMaskTexture(e,t=ae){this.material.uniforms.maskTexture.value=e,this.material.uniforms.maskMatrix.value.copy(t)}setPano(e,t,s=ae,i=ae){if(e!==this.currentSweepId||this.currentPanoTexture!==t){this.currentSweepId=e,this.currentPanoTexture=t;for(const e of this.blurRTs){const s=e.renderTarget,i=.5/s.input.width;this.renderer.copyCubemap(t,s.input),this.renderer.blurCubemap(s.input.texture,e.cubeCamera,s.sigma,i)}this.material.uniforms.panoMatrix1.value.copy(s),this.material.uniforms.panoMatrix2.value.copy(i)}}reset(){this.currentSweepId=null,this.currentPanoTexture=null}}class de extends m.RawShaderMaterial{constructor(e,t,s,i){const n=m.UniformsUtils.clone(ie.brush.uniforms);n.radius.value.copy(e),n.feather.value.copy(t),n.opacity.value.copy(s),n.color.value.set(1,0,0),super(Object.assign(Object.assign({},i),{fragmentShader:ie.brush.fragmentShader,vertexShader:ie.brush.vertexShader,uniforms:n,side:m.FrontSide,transparent:!0,blending:m.AdditiveBlending,name:"brushMaterial"}))}get color(){return this.uniforms.color.value}set color(e){this.uniforms.color.value=e}}var ue=s(56512),ce=s(92901);const he=new m.Color(16711680),me=new m.Color(65280),ge=new m.Color(255);class pe{constructor(e,t,s,i,n,a,r){this.sweepData=e,this.blurEditorData=t,this.scene=s,this.input=i,this.panoRenderer=r,this.root=new m.Group,this.meshes={},this.maskRenderTarget=new m.WebGLCubeRenderTarget(1024,{format:m.RGBAFormat,generateMipmaps:!1}),this.maskCamera=new m.PerspectiveCamera,this.maskBackground=new m.Mesh(new m.BoxGeometry(10,10,10),new m.MeshBasicMaterial({color:0,side:m.DoubleSide})),this.maskVisible=!1,this.dirty=!0,this.updating=!1,this.bindings=[],this.blurs=[],this.renderBlurredOverlay=(()=>{const e=new m.Matrix4,t=new m.Matrix4,s=new m.Quaternion;return async i=>{this.maskCamera.position.copy(i.position),this.maskBackground.position.copy(i.position),await this.engine.commandBinder.issueCommand(new te.sp(this.maskRenderTarget,this.root,this.maskCamera));const n=this.maskRenderTarget.texture,a=this.panoRenderer.useTexture(i.id);e.makeRotationFromQuaternion(s.copy(i.rotation).invert()),t.makeScale(-1,1,1),this.overlayRenderer.setPano(i.id,a,e,t),this.overlayRenderer.setMaskTexture(n),this.overlayRenderer.render(),this.panoRenderer.freeTexture(i.id),await this.engine.after(X.A.Begin),await this.engine.commandBinder.issueCommand(new ee.M(i.id,this.overlayRenderer.texture,new m.Quaternion))}})(),this.currentSweep=this.sweepData.currentSweepObject||null,this.overlayRenderer=new le(n,a)}setBlurs(e){this.blurs!==e&&(this.blurs=e,this.dirty=!0)}init(){this.root.add(this.maskBackground)}async activate(e){const[t]=await Promise.all([e.getModuleBySymbol(p.y.SETTINGS)]);this.engine=e,this.meshes={},this.bindings.push(this.blurEditorData.onChanged((()=>this.dirty=!0)),e.subscribe(se.Z,(e=>{this.currentSweep=this.sweepData.getSweep(e.toSweep),this.dirty=!0})),e.subscribe(ce.Xq,(()=>{this.overlayRenderer.reset(),this.currentSweep&&this.renderBlurredOverlay(this.currentSweep)}))),t.registerButton("Blur Debug","Toggle blur level coloration",(()=>{this.overlayRenderer.setDebug("DEBUG_BLUR_COLORS",!this.overlayRenderer.debug.DEBUG_BLUR_COLORS),this.currentSweep&&this.renderBlurredOverlay(this.currentSweep)})),t.registerButton("Blur Debug","Toggle blur test",(()=>{this.overlayRenderer.setDebug("DEBUG_BLUR_LEVELS",!this.overlayRenderer.debug.DEBUG_BLUR_LEVELS),this.currentSweep&&this.renderBlurredOverlay(this.currentSweep)})),this.maskRenderTarget.texture.image={},this.maskRenderTarget.texture.image.width=1024,this.maskRenderTarget.texture.image.height=1024}dispose(){this.root.traverse((e=>{e instanceof m.Mesh&&e.geometry.dispose()}))}render(){this.dirty&&!this.updating&&(this.updating=!0,this.dirty=!1,this.update().finally((()=>{this.updating=!1})))}deactivate(e){for(const e of this.bindings)e.cancel();this.bindings.length=0}getBlursForSweep(e){return this.blurs.filter((t=>t.sweepId===e))}async update(){var e,t;if(!this.currentSweep)return;const s=this.currentSweep,n=this.getBlursForSweep(s.id),a={};for(const e of n)for(const[t,s]of e.dots.entries())a[`${e.id}-${t}`]=s;let r=!1;for(const e in this.meshes){const t=this.meshes[e];a[e]&&a[e].directions.length===t.count||(this.root.remove(t),this.input.unregisterMesh(t),delete this.meshes[e],r=!0)}const o=new m.Vector3,l=new m.Vector3,d=new m.Vector3,u=new m.Matrix4,c=new m.Vector3;for(const e of n)for(const[t,i]of e.dots.entries()){const n=`${e.id}-${t}`;if(0===i.directions.length||this.meshes[n])continue;o.set(i.radius,i.radius-i.feather,i.radius),l.set(i.feather,i.feather,i.feather),d.set(i.strength,1,i.strength);const a=new de(o,l,d,{defines:{USE_INSTANCING:!0},depthTest:!1,depthWrite:!1}),h=new J((0,ue.fc)(),a,i.directions.length);h.blurId=e.id,i.directions.forEach(((e,t)=>{const n=2*(i.radius+i.feather),a=be(e,s);u.lookAt(s.position,a,R.fU.UP),u.scale(c.set(n,n,n)),u.setPosition(a),h.setMatrixAt(t,u)})),h.computeBoundingSphere(),this.meshes[n]=h,this.root.add(h),this.input.registerMesh(h,!1),r=!0}const h=new m.Color,{toolState:g,selectedBlur:p,hoveredBlur:b}=this.blurEditorData;for(const s in this.meshes){const n=this.meshes[s],a=n.material;h.copy(he);let o=F.z.reticule+.1;const l=null===(e=null==b?void 0:b.editable)||void 0===e||e,d=null===(t=null==p?void 0:p.editable)||void 0===t||t;g!==i.PAINTING&&(l&&n.blurId===(null==b?void 0:b.id)&&(h.add(ge),o=F.z.reticule+.2),d&&n.blurId===(null==p?void 0:p.id)&&(h.add(me),o=F.z.reticule+.3)),a.color.equals(h)&&n.renderOrder===o||(a.color.copy(h),n.renderOrder=o,r=!0)}r&&await this.renderBlurredOverlay(s)}setMaskVisibility(e){this.maskVisible!==e&&(e?this.scene.add(this.root):this.scene.remove(this.root),this.maskVisible=e)}}function be(e,t){const s=e.clone().applyQuaternion(t.rotation).normalize();return t.position.clone().add(s)}var fe=s(67992),ve=s(75287),Se=s(15637);class Be extends ve.T{constructor(){super(...arguments),this.selected=!1,this.hovered=!1}}class we extends ve.T{constructor(){super(...arguments),this.openedTool=!1,this.createdBlur=!1}}class Ce extends fe.V{constructor(){super(...arguments),this.name="blur-editor",this.toolState=i.IDLE,this.brushCursorVisibility=!1,this.interactions=new we,this.showMouseCursor=!1,this.states=new Se.v,this._selectedBlur=null,this._hoveredBlur=null}getState(e){let t=this.states.get(e);return t||(t=new Be,this.states.set(e,t)),t}get selectedBlur(){return this._selectedBlur}set selectedBlur(e){if(this.selectedBlur===e)return;const t=this.selectedBlur;if(this._selectedBlur=e,this.commit(),e){const t=this.getState(e.id);t.selected=!0,t.commit()}if(t){const e=this.getState(t.id);e.selected=!1,e.commit()}}onSelectedBlurChanged(e){return this.onPropertyChanged("_selectedBlur",e)}get hoveredBlur(){return this._hoveredBlur}set hoveredBlur(e){if(this.hoveredBlur===e)return;const t=this.hoveredBlur;if(this._hoveredBlur=e,this.commit(),e){const t=this.getState(e.id);t.hovered=!0,t.commit()}if(t){const e=this.getState(t.id);e.hovered=!1,e.commit()}}onHoveredBlurChanged(e){return this.onPropertyChanged("_hoveredBlur",e)}}var ye=s(6667),Ee=s(32597),Te=s(44109),xe=s(60975),Ie=s(19077),De=s(79727),_e=s(23037),Pe=s(38399),ke=s(71776),Oe=s(39693),Re=s(43736),Ae=s(92001),Ne=s(21973),Le=s(41326),Me=s(80361),Ge=s(22645),Ue=s(91443),je=s(17176),Fe=s(92290),ze=s(85893),Ve=s(66102),He=s(47457);const{BLURS:Qe,SCANS:We,MODAL:Ye}=Pe.Z.WORKSHOP;function qe({sweepCount:e,blurCount:t,failedBlurCount:s,nudge:i}){const n=(0,Ve.b)(),a=n.t(We.NUM_TYPE,e),r=n.t(Qe.NUM_TYPE,t),o=n.t(Qe.APPLY_MODAL_MESSAGE,{scans:a,blurs:r}),l=n.t(Qe.APPLY_MODAL_WARNING),d=n.t(Qe.APPLY_MODAL_NUDGE_MESSAGE);let u;s>0&&(u=n.t(Qe.APPLY_MODAL_RETRY));const c=t>ne.Dr&&n.t(Qe.APPLY_MODAL_TRUNCATED,{blurs:r,maxBlurs:ne.Dr});return(0,ze.jsxs)("div",{children:[i&&(0,ze.jsx)("p",{children:d}),(0,ze.jsx)("p",{dangerouslySetInnerHTML:{__html:o}}),(0,ze.jsx)("p",{dangerouslySetInnerHTML:{__html:l}}),u&&(0,ze.jsx)("p",{dangerouslySetInnerHTML:{__html:u}}),c&&(0,ze.jsx)("p",{dangerouslySetInnerHTML:{__html:c}})]})}const $e=async(e,t,s)=>{if(!e.hasUnappliedBlurs())return!1;const i=e.getByStatus(E.Q.PENDING,E.Q.FAILED),n=e.getByStatus(E.Q.FAILED),a=new Set(i.map((e=>e.sweepId))),r=s?Qe.APPLY_MODAL_NUDGE_TITLE:Qe.APPLY_MODAL_TITLE,o=s?Qe.APPLY_MODAL_NUDGE_CANCEL:Ye.NO,l={title:r,message:(0,ze.jsx)(qe,{sweepCount:a.size,blurCount:i.length,failedBlurCount:n.length,nudge:s}),cancellable:!0,confirmPhraseKey:Qe.APPLY_MODAL_CONFIRM,cancelPhraseKey:o,cancelVariant:s?He.Wu.TERTIARY:He.Wu.SECONDARY,modalClass:"blur-tool-modal full-modal"};return await t.issueCommand(new Fe.EW(Fe.Rx.DISPLAY,l))===Fe.Uc.CONFIRM},{SUGGESTIONS:Ze}=Pe.Z.WORKSHOP;class Ke{constructor(e,t){this.engine=e,this.settingsData=t,this.initialized=!1,this.toggledAssets={[Ae.U]:!1,[ke.re]:!1,[Oe.Mp]:!1,[_e.Nj]:!1,[Re.s]:!1},this.navigateToNextSuggestion=(e,t)=>{let s;for(let i=0;i<e.length;i++){const n=e[i],a=n.items.indexOf(t);if(-1!==a){const t=a+1;t<n.items.length?s=n.items[t]:e[i+1]&&e[i+1].items.length&&(s=e[i+1].items[0]);break}}s&&this.engine.commandBinder.issueCommand(new o(s,!1))},this.debouncedNavigateToNextSuggestion=(0,Me.D)(this.navigateToNextSuggestion,500),this.settingsToggler=new xe.u(this.settingsData,this.toggledAssets)}async activate(){var e;if(!this.initialized){this.initialized=!0;const{market:e}=this.engine,[t,s,i,n,a]=await Promise.all([e.waitForData(y.f),e.waitForData(Ce),e.waitForData(De.c),e.waitForData(Ne.D),e.waitForData(_.O)]),r=new Ie.Q(t.blurs);r.sort(((e,t)=>e.index-t.index)),r.priority=Ie.K.LOW;const o=await e.waitForData(Ge.a),l=new Ie.Q(o.suggestions);l.setFilter("accepted",(e=>null===e.accepted)),l.sort(((e,t)=>t.index-e.index)),this.dataMap={blurData:t,blurEditorData:s,blurList:r,floorsViewData:i,settings:this.settingsData,suggestionData:o,suggestionList:l,sweepViewData:n,viewmodeData:a}}const t=null===(e=this.dataMap.sweepViewData.data.currentSweepObject)||void 0===e?void 0:e.isAligned(),s=this.dataMap.viewmodeData.canStartTransition()&&this.dataMap.viewmodeData.currentMode!==P.Ey.Panorama;s&&!t&&await this.engine.commandBinder.issueCommand(new Le._i(Le.BD.INSIDE)),this.settingsToggler.toggle(!0),this.toggleBlurTool(i.IDLE),s&&t&&await this.engine.commandBinder.issueCommand(new Le._i(Le.BD.INSIDE))}async deactivate(){const{blurData:e}=this.dataMap;if(!e.hasProcessingBlurs()&&e.hasUnappliedBlurs()){await $e(this.dataMap.blurData,this.engine.commandBinder,!0)&&this.engine.commandBinder.issueCommand(new w.Mh)}this.settingsToggler.toggle(!1),await this.toggleBlurTool(i.OFF)}async hasPendingEdits(){return this.dataMap.blurEditorData.toolState===i.PAINTING}async toggleBlurTool(e){await this.engine.commandBinder.issueCommand(new a(e))}async rejectAllSuggestions(){const{suggestionData:e}=this.dataMap;if(!e)return!1;const t=e.getByAccepted(null).map((e=>e.id));if(!t.length)return!1;const s=(0,je.P)(t.length,Ze.TYPE);return await this.engine.commandBinder.issueCommand(new Fe.EW(Fe.Rx.DISPLAY,s))!==Fe.Uc.CLOSE&&(this.engine.commandBinder.issueCommand(new Ue.oA(...t)),!0)}}var Je=s(67294),Xe=s(28538),et=s(94184),tt=s.n(et),st=s(33558),it=s(38772),nt=s(3773),at=s(26158),rt=s(92795),ot=s(60770);const{BLURS:lt}=Pe.Z.WORKSHOP;function dt({canAdd:e,selectedBlur:t,onClickAdd:s,onDelete:n,toolState:a,nudgeDisabled:r}){const o=(0,Ve.b)(),l=o.t(lt.CREATE_TOOLTIP_TITLE),d=o.t(lt.CREATE_TOOLTIP_MESSAGE);let u=ot.d.ADD;a===i.PAINTING&&(u=t?ot.d.CONFIRM:ot.d.CANCEL);const c=t&&t.editable?(0,ze.jsx)(He.zx,{className:"action-button-outer",variant:He.Wu.FAB,theme:"overlay",icon:"delete",onClick:n}):void 0;return(0,ze.jsx)(rt.o,Object.assign({outerRight:c},{children:(0,ze.jsx)(ot.H,{addIcon:u,onClick:s,disabled:!e,nudgeMessage:d,nudgeTitle:l,nudgeLocalStorage:at.F.BlursAddNudgeSeen})}))}var ut,ct=s(31362);!function(e){e.size="size",e.scale="scale",e.feather="feather",e.pressure="pressure",e.opacity="opacity",e.state="state"}(ut||(ut={}));var ht=s(75043),mt=function(e,t,s,i){var n,a=arguments.length,r=a<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,s):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(e,t,s,i);else for(var o=e.length-1;o>=0;o--)(n=e[o])&&(r=(a<3?n(r):a>3?n(t,s,r):n(t,s))||r);return a>3&&r&&Object.defineProperty(t,s,r),r};const{BLURS:gt}=Pe.Z.WORKSHOP;let pt=class extends Je.Component{constructor(e){super(e),this.bindings=[],this.onToolStateChange=e=>{let{creating:t}=this.state;e===i.IDLE?t=!1:e===i.PAINTING&&(t=!0),this.setState({toolState:e,creating:t})},this.onBrushStateChange=e=>{this.setState({brushState:e})},this.onSelectedBlurChange=e=>{this.setState({selectedBlur:e})},this.onBrushSizeChange=e=>{const t=Math.round((0,A.et)(e,0,1,1,100));this.setState({brushSize:t})},this.onBrushSizeSliderChange=e=>{const{commandBinder:t}=this.context;this.dismissTooltip();const s=(0,A.et)(e,1,100,0,1);t.issueCommand(new r(s))},this.onDeleteClick=async()=>{const{toolState:e}=this.state;await this.deleteSelectedBlur(),e===i.PAINTING&&this.context.commandBinder.issueCommand(new a(i.IDLE))},this.onCreateClick=()=>{let e=i.IDLE;this.state.toolState===i.IDLE&&(e=i.PAINTING),this.context.commandBinder.issueCommand(new a(e))},this.dismissTooltip=()=>{this.setState({showBrushSizeTooltip:!1})};const{viewmodeData:t}=this.props.manager.dataMap;this.state={toolState:i.IDLE,brushState:h.DISABLED,viewmode:t.currentMode,brushSize:20,selectedBlur:null,showHints:!0,creating:!1,showBrushSizeTooltip:!0}}componentDidMount(){const{blurEditorData:e,viewmodeData:t}=this.props.manager.dataMap;this.bindings.push(e.onPropertyChanged("toolState",this.onToolStateChange),e.onSelectedBlurChanged(this.onSelectedBlurChange),e.brush.onPropertyChanged(ut.scale,this.onBrushSizeChange),e.brush.onPropertyChanged(ut.state,this.onBrushStateChange),e.interactions.onPropertyChanged("createdBlur",(()=>{this.setState({showHints:!1})})),t.makeModeChangeSubscription((e=>{this.setState({viewmode:e})}))),this.onBrushSizeChange(e.brush.scale)}componentWillUnmount(){for(const e of this.bindings)e.cancel();this.bindings=[]}deleteSelectedBlur(){const{selectedBlur:e}=this.state,{commandBinder:t}=this.context;if(!e)throw new Error("Cannot delete, no Blur selected");t.issueCommand(new w.TL(e.id))}renderOverlayMessage(){const{locale:e}=this.context,{toolState:t,showHints:s}=this.state;if(!s||t!==i.PAINTING)return null;const n=e.t((0,ct.Jm)()?gt.OVERLAY_MESSAGE_TOUCH:gt.OVERLAY_MESSAGE);return(0,ze.jsxs)("div",Object.assign({className:"overlay-message"},{children:[(0,ze.jsx)("div",{className:"icon icon-brush-outline"}),(0,ze.jsx)("span",Object.assign({className:"message"},{children:n}))]}))}renderBrushControls(){const{brushSize:e,toolState:t}=this.state;return t!==i.PAINTING?null:(0,ze.jsxs)("div",Object.assign({className:"brush-controls"},{children:[this.renderBrushSizeTooltip(),(0,ze.jsx)("div",Object.assign({className:"brush-size-control"},{children:(0,ze.jsx)(Xe.ZP,{min:1,max:100,step:1,included:!0,dots:!1,value:e,onChange:this.onBrushSizeSliderChange})}))]}))}renderBrushSizeTooltip(){const{showBrushSizeTooltip:e}=this.state;if(!e)return null;const t=this.context.locale.t(gt.BRUSH_TOOLTIP_TITLE),s=this.context.locale.t(gt.BRUSH_TOOLTIP_MESSAGE);return(0,ze.jsx)(nt.u,{className:"tooltip-simple-medium",open:!0,closeButton:!0,title:t,onClose:()=>this.dismissTooltip(),message:(0,ze.jsx)("div",Object.assign({className:"message"},{children:s})),arrowPos:nt.x.BOTTOM_CENTER})}render(){const{locale:e}=this.context,{blurList:t}=this.props.manager.dataMap,{brushState:s,toolState:n,selectedBlur:a,viewmode:r}=this.state,o=tt()("blur-tool-overlay","overlay","grid-overlay",{painting:s===h.PAINTING}),l=n===i.SUGGESTING,d=a&&e.t(l?gt.SUGGESTED_BLUR:gt.DEFAULT_BLUR_NAME,{number:a.index}),u=t.length>0;return(0,ze.jsxs)("div",Object.assign({className:o},{children:[a&&(0,ze.jsx)(ht.u,{children:d}),!l&&(0,ze.jsxs)(ze.Fragment,{children:[this.renderOverlayMessage(),(0,ze.jsx)(dt,{toolState:n,nudgeDisabled:u,canAdd:r===P.Ey.Panorama,selectedBlur:a,onClickAdd:this.onCreateClick,onDelete:this.onDeleteClick}),this.renderBrushControls()]})]}))}};pt.contextType=st.I,pt=mt([it.Z],pt);var bt,ft=s(72801),vt=s(11889),St=s(40763),Bt=s(29708),wt=s(33057);!function(e){e.SCANS="scans",e.FLOORS="floors"}(bt||(bt={}));const{BLURS:Ct}=Pe.Z.WORKSHOP,yt=({value:e,onChange:t})=>{const s=(0,Ve.b)(),i=[{text:s.t(Ct.BLUR_STATUS_ALL),value:"all",selected:"all"===e},{text:s.t(Ct.BLUR_STATUS_PENDING),value:E.Q.PENDING,selected:e===E.Q.PENDING},{text:s.t(Ct.BLUR_STATUS_APPLIED),value:E.Q.APPLIED,selected:e===E.Q.APPLIED},{text:s.t(Ct.BLUR_STATUS_FAILED),value:E.Q.FAILED,selected:e===E.Q.FAILED}];return(0,ze.jsx)(wt.S,{className:"blur-filter blur-filter-status",menuStyle:wt.K.DROPDOWN,onChange:t,options:i,placeholder:s.t(Ct.STATUS)})},Et=({value:e,onChange:t})=>{const s=(0,Ve.b)(),i=[{text:s.t(Ct.GROUP_BY_SCAN),value:bt.SCANS,selected:e===bt.SCANS},{text:s.t(Ct.GROUP_BY_FLOOR),value:bt.FLOORS,selected:e===bt.FLOORS}];return(0,ze.jsx)(wt.S,{className:"blur-filter blur-filter-groupby",menuStyle:wt.K.DROPDOWN,onChange:t,options:i,placeholder:s.t(Ct.GROUP_BY)})},Tt=({value:e,onChange:t})=>{const s=(0,Ve.b)(),i=[{text:s.t(Ct.SORT_CREATED_DESC),value:"CREATED_DESC",selected:"CREATED_DESC"===e},{text:s.t(Ct.SORT_CREATED_ASC),value:"CREATED_ASC",selected:"CREATED_ASC"===e}];return(0,ze.jsx)(wt.S,{className:"blur-filter blur-filter-sort",menuStyle:wt.K.DROPDOWN,onChange:t,options:i,placeholder:s.t(Ct.SORT)})};var xt=s(19564),It=s(72400),Dt=s(45755);const _t=(0,Dt.u)(Ce);function Pt(){const[e,t]=(0,Je.useState)(null),s=_t();return(0,Je.useEffect)((()=>{const e=[];return s&&(e.push(s.onSelectedBlurChanged((e=>t(e)))),t(s.selectedBlur)),()=>{e.forEach((e=>e.cancel()))}}),[s]),e}function kt(){const[e,t]=(0,Je.useState)(null),s=_t();return(0,Je.useEffect)((()=>{const e=[];return s&&(e.push(s.onHoveredBlurChanged((e=>t(e)))),t(s.hoveredBlur)),()=>{e.forEach((e=>e.cancel()))}}),[s]),e}const{BLURS:Ot}=Pe.Z.WORKSHOP;function Rt({blur:e}){const{commandBinder:t}=(0,Je.useContext)(st.I),s=_t(),i=Pt(),n=kt(),a=(0,Ve.b)(),r=(0,xt.z)(),l=(0,Je.useCallback)((()=>{t.issueCommand(new o(e,!0))}),[t,e]),c=(0,Je.useCallback)((()=>{const s=e.visible;s?t.issueCommand(new u(e.id)):t.issueCommand(new d(e.id)),r.trackToolGuiEvent("blur","blur_list_click_"+(s?"hide":"show"))}),[t,e,r]),h=(0,Je.useCallback)((()=>{t.issueCommand(new w.TL(e.id)),r.trackToolGuiEvent("blur","blur_list_click_delete")}),[t,e,r]),m=(0,Je.useCallback)((()=>{s&&(s.hoveredBlur=e)}),[e,s]),g=(0,Je.useCallback)((()=>{s&&(s.hoveredBlur=null)}),[s]),p=e.status!==E.Q.PENDING,b=(0,ze.jsxs)("span",{children:[a.t(Ot.DEFAULT_BLUR_NAME,{number:e.index}),p&&(0,ze.jsx)("span",Object.assign({className:"blur-status"},{children:e.status}))]}),f=e.status!==E.Q.APPLIED&&e.status!==E.Q.PROCESSING,v=a.t(Ot.DELETE_BLUR_CTA),S=(0,ze.jsx)(He.hE,{children:f&&(0,ze.jsxs)(ze.Fragment,{children:[(0,ze.jsx)(It.Z,{id:e.id,visible:e.visible,showTooltip:Ot.SHOW_LIST_ITEM_TOOLTIP_MESSAGE,hideTooltip:Ot.HIDE_LIST_ITEM_TOOLTIP_MESSAGE,onClick:c}),(0,ze.jsx)(He.xz,Object.assign({icon:"more-vert",menuArrow:!0,menuClassName:"search-result-menu"},{children:(0,ze.jsx)(He.zx,{className:"menu-delete-btn",label:v,size:He.qE.SMALL,variant:He.Wu.TERTIARY,onClick:h})}))]})}),B=tt()("blur-list-item",{active:i&&i.id===e.id},{hover:n&&n.id===e.id});return(0,ze.jsx)(He.HC,{className:B,onClick:l,onMouseEnter:m,onMouseLeave:g,actions:S,title:b,id:e.id})}const At="other",{BLURS:Nt,SCANS:Lt,VIEWS_360:Mt}=Pe.Z.WORKSHOP;function Gt(e,t){const[s,i]=(0,Je.useState)(bt.SCANS),[n,a]=(0,Je.useState)([]),r=(0,Ve.b)(),o=(0,Je.useCallback)((()=>{const{sweepViewData:s}=t.dataMap,i=s.getAlignedSweeps(!1),n={};if(e){const t=e.groupBy("sweepId");for(const e in t){const a=s.getSweep(e);let o=r.t(Lt.LIST_ITEM_TEXT,a.index+1);if(!a.isAligned()){const e=i.findIndex((e=>e.id===a.id))||0;o=a.name||r.t(Mt.DEFAULT_NAME,{index:e+1})}n[e]={id:`sweep-${a.id}`,data:a,title:o,items:t[e]}}}return n}),[e,r,t.dataMap]),l=(0,Je.useCallback)((()=>{const{floorsViewData:s}=t.dataMap,i={};if(e){const t=e.groupBy("floorId");s.floors.iterate((e=>{i[e.id]={id:e.id,data:e,title:e.name,items:t[e.id]||[]}})),t.null&&(i.other={id:At,title:r.t(Nt.OTHER_GROUP_LABEL),items:t.null})}return i}),[e,r,t.dataMap]),d=(0,Je.useCallback)((()=>{const e=s===bt.SCANS?o():l(),t=Object.values(e).sort(((e,t)=>e.title.localeCompare(t.title,void 0,{numeric:!0})));a(t)}),[o,l,s]);return(0,Je.useEffect)((()=>{const t=[e.onChanged((()=>{d()}))];return d(),()=>{t.forEach((e=>e.cancel()))}}),[e,s,r,t.dataMap,d]),{groups:n,groupBy:s,setGroupBy:i}}const Ut=(0,Dt.u)(Ge.a);const{BLURS:jt}=Pe.Z.WORKSHOP;let Ft=!1;const zt=()=>{const e=function(){const e=Ut(),[t,s]=(0,Je.useState)(0);return(0,Je.useEffect)((()=>{if(!e)return()=>{};const t=()=>{s(e.getByAccepted(null).length)},i=e.onChanged(t);return t(),()=>i.cancel()}),[e]),t}(),{commandBinder:t}=(0,Je.useContext)(st.I),s=(0,Ve.b)(),n=(0,xt.z)(),r=(0,Je.useCallback)((()=>{n.trackToolGuiEvent("blur","blur_click_view_suggestions"),t.issueCommand(new a(i.SUGGESTING))}),[t,n]);if(!e)return null;const o=s.t(jt.SUGGESTIONS_AVAILABLE_MESSAGE,e),l=(0,ze.jsxs)(He.zx,Object.assign({size:He.qE.SMALL,variant:He.Wu.SECONDARY,onClick:r},{children:[(0,ze.jsx)(He.o3,{}),(0,ze.jsx)("span",{children:s.t(jt.VIEW_SUGGESTIONS)})]}));return Ft||(Ft=!0,n.trackToolGuiEvent("blur","blur_suggestions_banner_shown")),(0,ze.jsx)(He.jL,{layout:"horizontal",text:o,actions:l,className:"blur-list-banner"})};var Vt=s(82513);const{BLURS:Ht}=Pe.Z.WORKSHOP,Qt=({group:e})=>{const{id:t,items:s}=e;return(0,ze.jsx)(Vt.J,{id:t,numItems:s.length})},Wt=({group:e})=>{const{id:t,title:s,items:i}=e;return(0,ze.jsx)(He._m,{id:t,title:s,decals:(0,ze.jsx)("span",Object.assign({className:"mp-list-item-text"},{children:`(${i.length})`}))})},Yt=({item:e})=>{const t=(0,Ve.b)();if(!e){const e=t.t(Ht.MULTI_FLOOR_EMPTY_MESSAGE);return(0,ze.jsx)(He.gQ,{message:e})}return(0,ze.jsx)(Rt,{blur:e})},qt=({className:e="",manager:t})=>{const{blurList:s}=t.dataMap,i=(0,Ve.b)(),n=(0,xt.z)(),[a,r]=(0,Je.useState)(null),{groups:o,groupBy:l,setGroupBy:d}=Gt(s,t),u=(0,Je.useCallback)((e=>{(0,Bt.p)(E.Q,e)?s.setFilter("status",(t=>t.status===e)):s.clearFilter("status"),null!==e&&n.trackToolGuiEvent("blur",`blur_list_filter_by_${e}`),r(e)}),[s,n]),[c,h]=(0,Je.useState)(null),m=(0,Je.useCallback)((e=>{switch(e){case"CREATED_DESC":s.sort(((e,t)=>e.created.getTime()-t.created.getTime()||e.index-t.index));break;case"CREATED_ASC":s.sort(((e,t)=>t.created.getTime()-e.created.getTime()||t.index-e.index))}null!==e&&n.trackToolGuiEvent("blur",`blur_list_sort_by_${e.toLowerCase()}`),h(e)}),[s,n]),g=(0,Je.useCallback)((e=>{n.trackToolGuiEvent("blur",`blur_list_group_by_${e.toLowerCase()}`),d(e)}),[d,n]),p=tt()(e,"blur-list"),b=i.t(Ht.NO_BLURS);return(0,ze.jsxs)("div",Object.assign({className:p},{children:[(0,ze.jsxs)("header",Object.assign({className:"blur-list-header"},{children:[(0,ze.jsx)(zt,{}),(0,ze.jsxs)(He.w0,{children:[(0,ze.jsx)(Et,{value:l,onChange:g}),(0,ze.jsx)(yt,{value:a,onChange:u}),(0,ze.jsx)(Tt,{value:c,onChange:m})]})]})),(0,ze.jsx)("div",Object.assign({className:"blur-list-content"},{children:0===o.length?(0,ze.jsx)(He.gQ,{message:b,itemHeight:60}):(0,ze.jsx)(He.UQ,{data:o,itemHeight:60,renderItem:Yt,renderGroup:l===bt.FLOORS?Qt:Wt})}))]}))};function $t(){const e=_t(),[t,s]=(0,Je.useState)(i.OFF);return(0,Je.useEffect)((()=>{const t=[];if(e){const i=()=>{s(e.toolState)};t.push(e.onPropertyChanged("toolState",i)),i()}return()=>{t.forEach((e=>e.cancel()))}}),[e]),t}const{BLURS:Zt}=Pe.Z.WORKSHOP,Kt=({suggestion:e,onResolved:t})=>{const{commandBinder:s}=(0,Je.useContext)(st.I),i=(0,xt.z)(),n=(0,Ve.b)(),a=_t(),r=kt(),l=Pt(),[d,u]=(0,Je.useState)(null),c=(0,Je.useCallback)((()=>{s.issueCommand(new Ue.rf(e.id)),i.trackToolGuiEvent("blur","blur_suggestion_list_click_accept"),t(e,!0)}),[i,s,e,t]),h=(0,Je.useCallback)((()=>{s.issueCommand(new Ue.oA(e.id)),i.trackToolGuiEvent("blur","blur_suggestion_list_click_reject"),t(e,!1)}),[i,s,e,t]),m=(0,Je.useCallback)((e=>{d||(u("accepted"),setTimeout(c,500),e.stopPropagation())}),[c,d]),g=(0,Je.useCallback)((e=>{d||(u("rejected"),setTimeout(h,500),e.stopPropagation())}),[h,d]),p=(0,Je.useCallback)((t=>{const n=e.visible;n?s.issueCommand(new Ue.mA(e.id)):s.issueCommand(new Ue.ee(e.id)),i.trackToolGuiEvent("blur","blur_suggestion_list_click_"+(n?"hide":"show")),t.stopPropagation()}),[i,s,e]),b={placement:"top"},f=(0,Je.useCallback)((()=>{a&&(a.hoveredBlur=e)}),[e,a]),v=(0,Je.useCallback)((()=>{a&&(a.hoveredBlur=null)}),[a]),S=(0,ze.jsxs)(He.hE,{children:[(0,ze.jsx)(He.zx,{icon:e.visible?"eye-show":"eye-hide",onClick:p,tooltip:e.visible?n.t(Zt.HIDE_LIST_ITEM_TOOLTIP_MESSAGE):n.t(Zt.SHOW_LIST_ITEM_TOOLTIP_MESSAGE),tooltipOptions:b}),(0,ze.jsx)(He.zx,{icon:"checkmark",onClick:m,tooltip:n.t(Zt.ACCEPT_SUGGESTION_TOOLTIP),tooltipOptions:b}),(0,ze.jsx)(He.zx,{icon:"close",onClick:g,tooltip:n.t(Zt.REJECT_SUGGESTION_TOOLTIP),tooltipOptions:b})]}),B=n.t(Zt.SUGGESTED_BLUR,{number:e.index}),w=tt()("blur-suggestion-list-item",{active:l&&l.id===e.id,hover:r&&r.id===e.id,accepted:"accepted"===d,rejected:"rejected"===d});return(0,ze.jsx)(He.HC,{actions:S,className:w,title:B,id:e.id,onClick:()=>{s.issueCommand(new o(e,!1))},onMouseEnter:f,onMouseLeave:v})},{BLURS:Jt}=Pe.Z.WORKSHOP,Xt=({onClose:e,manager:t})=>{const s=(0,Ve.b)(),i=(0,xt.z)(),{commandBinder:n}=(0,Je.useContext)(st.I),{suggestionList:a}=t.dataMap,r=(0,Je.useCallback)((()=>{n.issueCommand(new Ue.rf),i.trackToolGuiEvent("blur","blur_suggestion_list_click_accept_all"),e()}),[n,e,i]),o=(0,Je.useCallback)((async()=>{await t.rejectAllSuggestions()&&(i.trackToolGuiEvent("blur","blur_suggestion_list_click_reject_all"),e())}),[t,e,i]);if(!(null==a?void 0:a.length))return null;const l=a.length,d=s.t(Jt.SUGGESTIONS_FOUND_MESSAGE,l),u=(0,ze.jsxs)(He.hE,Object.assign({spacing:"small"},{children:[(0,ze.jsx)(He.zx,{variant:He.Wu.PRIMARY,size:He.qE.SMALL,onClick:r,label:s.t(Jt.ACCEPT_ALL_SUGGESTIONS)}),(0,ze.jsx)(He.zx,{variant:He.Wu.TERTIARY,size:He.qE.SMALL,onClick:o,label:s.t(Jt.REJECT_ALL_SUGGESTIONS)})]})),c=(0,ze.jsx)(He.zx,{size:He.qE.LARGE,variant:He.Wu.TERTIARY,onClick:e,className:"blur-banner-exit",icon:"back",label:s.t(Jt.CLOSE_SUGGESTIONS)});return(0,ze.jsx)("div",Object.assign({className:"suggestion-list-header"},{children:(0,ze.jsx)(He.jL,{text:d,actions:u,header:c})}))},{BLURS:es}=Pe.Z.WORKSHOP,ts=({group:e})=>{const{id:t,title:s,items:i}=e;return(0,ze.jsx)(He._m,{id:t,title:s,decals:(0,ze.jsx)("span",Object.assign({className:"mp-list-item-text"},{children:`(${i.length})`}))})},ss=({group:e})=>{const{id:t,items:s}=e;return(0,ze.jsx)(Vt.J,{id:t,numItems:s.length})},is=({item:e,onResolved:t})=>{const s=(0,Ve.b)();if(!e){const e=s.t(es.NO_SUGGESTIONS_ON_FLOOR);return(0,ze.jsx)(He.gQ,{message:e})}return(0,ze.jsx)(Kt,{suggestion:e,onResolved:t})},ns=({className:e,manager:t,onClose:s})=>{const{suggestionList:i}=t.dataMap,n=(0,xt.z)(),a=(0,Ve.b)(),{groups:r,groupBy:o,setGroupBy:l}=Gt(i,t),d=(0,Je.useCallback)((e=>{n.trackToolGuiEvent("blur",`blur_suggestion_list_group_by_${e.toLowerCase()}`),l(e)}),[n,l]),u=(0,Je.useCallback)(((e,s)=>{t.debouncedNavigateToNextSuggestion(r,e)}),[t,r]);if(!i)return null;const c=tt()(e,"suggestion-list"),h=a.t(es.NO_SUGGESTIONS);return(0,ze.jsxs)("div",Object.assign({className:c},{children:[(0,ze.jsxs)("header",Object.assign({className:"suggestion-list-header"},{children:[(0,ze.jsx)(Xt,{manager:t,onClose:s}),(0,ze.jsx)(He.w0,{children:(0,ze.jsx)(Et,{value:o,onChange:d})})]})),(0,ze.jsx)("div",Object.assign({className:"suggestion-list-content"},{children:0===r.length?(0,ze.jsx)(He.gQ,{message:h,itemHeight:42}):(0,ze.jsx)(He.UQ,{data:r,itemHeight:42,renderItem:is,renderItemProps:{onResolved:u},renderGroup:o===bt.FLOORS?ss:ts})}))]}))},as=(0,Dt.u)(y.f);const{BLURS:rs}=Pe.Z.WORKSHOP;function os(){const{analytics:e,commandBinder:t}=(0,Je.useContext)(st.I),[s,n]=(0,Je.useState)(!1),a=as(),r=(0,Ve.b)(),o=function(){var e;const t=as(),[s,i]=(0,Je.useState)((null===(e=null==t?void 0:t.getByStatus(E.Q.PROCESSING))||void 0===e?void 0:e.length)||0);return(0,Je.useEffect)((()=>{if(!t)return()=>{};function e(){t&&i(t.getByStatus(E.Q.PROCESSING).length)}const s=t.makeProcessingSubscription(e);return e(),()=>s.cancel()}),[t]),s}(),l=function(){var e;const t=as(),[s,i]=(0,Je.useState)((null===(e=null==t?void 0:t.getByStatus(E.Q.PENDING,E.Q.FAILED))||void 0===e?void 0:e.length)||0);return(0,Je.useEffect)((()=>{if(!t)return()=>{};function e(){t&&i(t.getByStatus(E.Q.PENDING,E.Q.FAILED).length)}const s=[t.makeUnappliedSubscription(e),t.blurs.onElementChanged({onAdded:e,onRemoved:e})];return e(),()=>{s.forEach((e=>e.cancel()))}}),[t]),s}(),d=$t(),u=(0,Je.useCallback)((async()=>{if(!a||0===l)return;n(!0),e.trackToolGuiEvent("blur","blur_click_apply");if(await $e(a,t,!1))return t.issueCommand(new w.Mh).finally((()=>{n(!1)}));n(!1)}),[l,a,e,t]),c=o>0,h=l>0,m=d===i.PAINTING,g=h&&!c&&!s&&!m,p=c?r.t(rs.APPLYING,o):r.t(rs.APPLY_BLURS_CTA,l);return(0,ze.jsx)(He.zx,Object.assign({className:"apply-blurs-button",variant:He.Wu.TERTIARY,disabled:!g,size:He.qE.SMALL,onClick:u},{children:p}))}const{BLURS:ls}=Pe.Z.WORKSHOP;function ds({manager:e,className:t}){const s=(0,vt.m)(e.dataMap.blurList),n=(0,vt.m)(e.dataMap.suggestionList),{commandBinder:r}=(0,Je.useContext)(st.I),o=(0,Ve.b)(),l=$t()===i.SUGGESTING,d=tt()(t,"blurs-panel"),u=(0,Je.useCallback)((e=>{const t=l?i.IDLE:i.SUGGESTING;r.issueCommand(new a(t)),e&&e.stopPropagation()}),[l,r]);if(!s||!n)return null;const c=l?o.t(ls.NUM_BLUR_SUGGESTIONS,n.length):o.t(ls.NUM_TYPE,s.length),h=l?void 0:(0,ze.jsx)(os,{}),m=l?void 0:(0,ze.jsx)(St.z,{toolId:N.w1.BLUR});return(0,ze.jsxs)(ft.L,Object.assign({toolId:N.w1.BLUR,className:d,title:c,controls:h,subheader:m},{children:[l&&(0,ze.jsx)(ns,{className:"blurs-panel-contents",manager:e,onClose:u}),!l&&(0,ze.jsx)(qt,{className:"blurs-panel-contents",manager:e})]}))}class us{constructor(e,t){this.renderPanel=()=>(0,ze.jsx)(ds,{manager:this.manager}),this.renderOverlay=()=>(0,ze.jsx)(pt,{manager:this.manager}),this.manager=e}}var cs=s(34029),hs=s(90632),ms=s(45905),gs=s(63252);class ps extends g.Y{constructor(){super(...arguments),this.name="blur_editor",this.activeBindings=[],this.setMeshCursorVisibility=()=>!this.data.hoveredBlur&&this.data.toolState!==i.PAINTING,this.changeToolState=async e=>{const t=this.data.toolState;e!==t&&(this.data.toolState=e,this.data.commit(),await this.onToolStateChange(e,t))},this.navigateToBlur=(e,t)=>{if(!e)throw new Error("Cannot navigate to non-existant blur");let s;const n=this.getFocalPoint(e.dots);if(n){const t=this.sweepData.getSweep(e.sweepId);n.applyQuaternion(t.rotation),s=(0,A.Z)((new m.Quaternion).setFromUnitVectors(R.fU.FORWARD,n))}let r=O.n.Interpolate;const o=this.sweepData.currentSweepObject;if(o){const t=this.sweepData.getSweep(e.sweepId);o.neighbours.includes(t.id)||(r=O.n.FadeToBlack)}const l=new k.ju({transition:r,sweep:e.sweepId,rotation:s}),d=this.engine.commandBinder.issueCommand(l).then((()=>{this.data.selectedBlur=e||null}));return t&&this.engine.commandBinder.issueCommand(new a(i.IDLE)),this.toolData.toolPanelLayout===N.wS.BOTTOM_PANEL&&this.engine.commandBinder.issueCommand(new L.Fg(!0)),d},this.onToolStateChange=async(e,t)=>{const{brush:s}=this.data;t===i.PAINTING&&await this.engine.commandBinder.issueCommand(new w.o8),e===i.PAINTING?(s.enable(),this.engine.broadcast(new M.ps(!1))):(s.disable(),this.engine.broadcast(new M.ps(!0))),e===i.OFF?(this.activeBindings.forEach((e=>e.cancel())),this.data.selectedBlur=null,this.data.hoveredBlur=null,this.data.interactions.openedTool=!1,this.data.interactions.commit(),this.renderer.setBlurs([])):this.activeBindings.forEach((e=>e.renew())),e!==i.OFF&&(this.data.selectedBlur=null,this.data.hoveredBlur=null,this.data.interactions.openedTool||(this.data.interactions.openedTool=!0,this.data.interactions.commit()),e===i.SUGGESTING?this.renderSuggestions():this.renderBlurs()),this.updatePolling()},this.checkForUpdates=()=>{let e;return(0,b.k1)((()=>{clearInterval(e),e=window.setInterval((()=>{this.log.debug("Polling..."),this.engine.commandBinder.issueCommand(new w.s$)}),1e3*Te.F8)}),(()=>{window.clearInterval(e)}),!1)},this.onViewmodeChange=e=>{const{toolState:t}=this.data;e!==P.Ey.Panorama&&t===i.PAINTING&&this.changeToolState(i.IDLE),e===P.Ey.Panorama?this.clickHandler.renew():this.clickHandler.cancel()},this.onSweepChange=e=>{const{selectedBlur:t}=this.data;t&&(this.onDeselectBlur(t),this.data.selectedBlur=null)},this.onBlursChanged=()=>{const{selectedBlur:e}=this.data;e&&!this.blurData.isEditable(e.id)&&(this.data.selectedBlur=null);const{toolState:t}=this.data;t!==i.SUGGESTING&&this.renderBlurs()},this.onSuggestionsChanged=()=>{const e=this.toolData.getTool(N.w1.BLUR);if(e){const t=this.suggestionData.getByAccepted(null).length>0;e.hasUpdates!==t&&(e.hasUpdates=t,e.commit())}if(!this.data)return;const{toolState:t}=this.data;t===i.SUGGESTING&&this.renderSuggestions()},this.onPointerButton=e=>{const{toolState:t}=this.data,{hit:s}=this.raycasterData;e.down&&t===i.PAINTING&&this.updateSelectedBlur(s?s.object:null)},this.onKeyEvent=e=>{const{selectedBlur:t}=this.data;if(t&&e.state===ye.M.PRESSED)switch(e.key){case Ee.R.ESCAPE:this.engine.commandBinder.issueCommand(new a(i.IDLE));break;case Ee.R.DELETE:this.data.selectedBlur&&this.engine.commandBinder.issueCommand(new w.TL(t.id))}},this.onClick=(e,t)=>{const{toolState:s}=this.data;return s===i.PAINTING||!!(t instanceof J||this.data.selectedBlur)&&(this.updateSelectedBlur(t),!0)},this.onPaint=(e,t,s,i)=>{const n=this.sweepData.currentSweepObject;if(!n)return;let a=this.data.selectedBlur instanceof C.x?this.data.selectedBlur:null;const r=a?a.dotCount:0;(!a||r>Te.Vw)&&(a=new C.x({sweepId:n.id}),n.placementType!==gs.hU.UNPLACED&&(a.floorId=n.floorId,a.roomId=n.roomId),this.blurData.add(a),this.data.selectedBlur=a);const o=e.clone().applyQuaternion(n.rotation.clone().invert()).normalize();a.add(o,t,s,i)},this.updateHoveredBlur=()=>{const{toolState:e}=this.data,t=this.raycasterData.hit&&this.raycasterData.hit.object,s=e===i.PAINTING?null:this.getBlurFromMesh(t);if(s!==this.data.hoveredBlur&&(this.data.hoveredBlur=s,this.data.toolState!==i.PAINTING)){const e=s?I.C.FINGER:null;this.engine.commandBinder.issueCommand(new x.u(e))}}}async init(e,t){this.log.debug("Module config",e),this.engine=t,this.config=e,[this.blurData,this.cameraData,this.cursorController,this.raycasterData,this.settings,this.storageData,this.sweepData,this.toolData,this.viewmodeData]=await Promise.all([t.market.waitForData(y.f),t.market.waitForData(T.M),t.getModuleBySymbol(p.y.CURSOR_CONTROLLER),t.market.waitForData(D.P),t.getModuleBySymbol(p.y.SETTINGS),t.market.waitForData(hs.Q),t.market.waitForData(f.Z),t.market.waitForData(G.t),t.market.waitForData(_.O)]);const[s,n,h,g]=await Promise.all([t.getModuleBySymbol(p.y.INPUT),t.getModuleBySymbol(p.y.RENDER_TO_TEXTURE),t.market.waitForData(_.O),t.getModuleBySymbol(p.y.WEBGL_RENDERER)]);this.suggestionData=await t.market.waitForData(Ge.a),this.bindings.push(this.toolData.onChanged(this.onSuggestionsChanged),this.suggestionData.onChanged(this.onSuggestionsChanged));const b=(await t.getModuleBySymbol(p.y.SWEEP_PANO)).getRenderer();this.data=new Ce,t.market.register(this,Ce,this.data),this.cursorController.addVisibilityRule(this.setMeshCursorVisibility);const w=g.getScene();this.renderer=new pe(this.sweepData,this.data,w,s,n,g.cwfRenderer,b),t.addComponent(this,this.renderer);const C=new K(this.sweepData,this.cameraData,w,s);C.setSizeRange(Te.oR,Te.rC),C.onPaint=this.onPaint,t.addComponent(this,C),this.data.brush=C,this.registerSettings(),this.registerTool(),this.clickHandler=s.registerPriorityHandler(v.R,m.Mesh,this.onClick),this.bindings.push(t.commandBinder.addBinding(a,(async e=>this.changeToolState(e.state))),t.commandBinder.addBinding(r,(async e=>this.data.brush.scale=e.scale)),t.commandBinder.addBinding(o,(async({blur:e,resetBlurTool:t})=>this.navigateToBlur(e,t))),t.commandBinder.addBinding(d,(({ids:e})=>this.showBlurs(...e))),t.commandBinder.addBinding(u,(({ids:e})=>this.hideBlurs(...e))),t.commandBinder.addBinding(l,(async({id:e})=>this.batchToggleVisibility([e]))),t.commandBinder.addBinding(c,(async({ids:e})=>this.batchToggleVisibility(e)))),this.pollingSubscription=this.checkForUpdates(),this.updatePolling(),this.activeBindings.push(h.makeModeChangeSubscription(this.onViewmodeChange),this.sweepData.makeSweepChangeSubscription(this.onSweepChange),this.blurData.blurs.onChanged(this.onBlursChanged),s.registerHandler(S.er,this.onPointerButton),s.registerHandler(B.e,this.onKeyEvent),this.raycasterData.onChanged(this.updateHoveredBlur),this.clickHandler,this.storageData.onPropertyChanged("transactionState",(()=>this.updatePolling())),this.blurData.makeProcessingSubscription((()=>this.updatePolling()))),this.changeToolState(i.OFF),this.viewmodeData.currentMode&&this.onViewmodeChange(this.viewmodeData.currentMode),this.activeBindings.forEach((e=>e.cancel())),e.debug&&this.log.info("DEBUG mode enabled")}dispose(e){super.dispose(e),this.pollingSubscription&&this.pollingSubscription.cancel(),this.activeBindings.forEach((e=>e.cancel())),e.disposeRenderLayer(this.name),this.data&&e.market.unregister(this,Ce),this.cursorController.removeVisibilityRule(this.setMeshCursorVisibility)}renderBlurs(){const e=this.blurData.getByStatus(E.Q.PENDING,E.Q.PROCESSING,E.Q.FAILED).filter((e=>e.visible));this.renderer.setBlurs(e)}renderSuggestions(){const e=this.suggestionData.getByAccepted(!0,null).filter((e=>e.visible));this.renderer.setBlurs(e)}getFocalPoint(e){if(!e.length)return null;let t=0;const s=e.reduce(((e,s)=>{for(const i of s.directions)e.x+=i.x,e.y+=i.y,e.z+=i.z,t++;return e}),{x:0,y:0,z:0});return new m.Vector3(s.x/t,s.y/t,s.z/t)}async showBlurs(...e){this.blurData.setVisibility(!0,...e)}async hideBlurs(...e){this.blurData.setVisibility(!1,...e)}batchToggleVisibility(e){this.blurData.batchToggleVisibility(e)}updatePolling(){const{toolState:e}=this.data,{transactionState:t}=this.storageData,s=e!==i.OFF,n=t===ms.g.IDLE;return s&&n?(this.pollingSubscription.renew(),this.log.debug("Polling enabled"),!0):(this.log.debug("Polling disabled"),this.pollingSubscription.cancel(),!1)}onDeselectBlur(e){const{toolState:t}=this.data;e&&t===i.PAINTING&&this.engine.commandBinder.issueCommand(new w.o8)}getBlurFromMesh(e){if(e&&e instanceof J){const t=this.data.toolState===i.SUGGESTING,s=t?this.suggestionData.get(e.blurId):this.blurData.get(e.blurId);if(t||(null==s?void 0:s.status)===E.Q.PENDING)return s}return null}updateSelectedBlur(e){const t=this.getBlurFromMesh(e);t!==this.data.selectedBlur&&(this.onDeselectBlur(this.data.selectedBlur),this.data.selectedBlur=t,t&&this.log.debug(`Selected blur ${t.id}`))}registerSettings(){const e="Blur Tool",{brush:t}=this.data,{debug:s,meshBlurEnabled:i,pipelineEnabled:n}=this.config;[{header:e,setting:"blur/brush_size",range:[Te.oR,Te.rC],initialValue:()=>t.size,onChange:e=>t.size=e},{header:e,setting:"blur/brush_scale",range:[0,1],initialValue:()=>t.scale,onChange:e=>t.scale=e},{header:e,setting:"blur/tool_enabled",initialValue:()=>this.settings.tryGetProperty(Te.x3,!1),onChange:e=>this.settings.updateSetting(Te.x3,e)},{header:e,setting:"blur/mask",initialValue:()=>!1,onChange:e=>{this.renderer&&this.renderer.setMaskVisibility(e)}},{header:e,setting:"blur/show_cursor",initialValue:()=>!1,onChange:e=>{this.log.debug("Brush mouse cursor "+(e?"enabled":"disabled")),t.toggleMouseCursor(e)}},{header:e,setting:Te.Vk,initialValue:()=>s,onChange:e=>{this.settings.updateSetting(Te.Vk,e)}},{header:e,setting:ne.pv,initialValue:()=>!1,onChange:e=>{this.settings.updateSetting(ne.pv,e)}},{header:e,setting:ne.n5,initialValue:()=>n,onChange:e=>{this.settings.updateSetting(ne.n5,e)}},{header:e,setting:ne.i7,initialValue:()=>i,onChange:e=>{this.settings.updateSetting(ne.i7,e)}}].forEach((e=>this.settings.registerMenuEntry(e)))}async registerTool(){const e=await this.engine.market.waitForData(cs.e),t=new Ke(this.engine,e),s=new U.U({id:N.w1.BLUR,namePhraseKey:Pe.Z.TOOLS.BLUR,panel:!0,icon:"icon-blur-outline",analytic:"blur",palette:N.$r.MODEL_BASED,allViewsPhraseKey:Pe.Z.WORKSHOP.LAYERS.APPLY_TO_ALL_VIEWS_BLURS,order:90,dimmed:!1,enabled:e.tryGetProperty(Te.x3,!1),manager:t,ui:new us(t,e),featureFlag:Te.x3,helpMessagePhraseKey:Pe.Z.TOOLS.BLUR_HELP_MESSAGE,helpHref:"https://support.matterport.com/hc/en-us/articles/1500003156162-How-to-use-Manual-Blur-Brush"});this.engine.commandBinder.issueCommand(new L.MV([s]))}}},22645:(e,t,s)=>{"use strict";s.d(t,{a:()=>r});var i=s(67992),n=s(15637),a=s(39880);class r extends i.V{constructor(e){super(),this.name="blur-suggestion-data",this.suggestions=new n.v,e&&this.add(...e)}add(...e){this.suggestions.atomic((()=>{for(const t of e)t.atomic((()=>{for(;!t.id||this.suggestions.has(t.id);)t.id=(0,a.O1)(11),t.commit();if(-1===t.index||this.hasIndex(t.index)){const e=this.suggestions.values.map((e=>e.index)).filter((e=>"number"==typeof e)),s=e.length?Math.max(...e):0;t.index=s+1,t.commit()}})),this.suggestions.set(t.id,t)})),this.commit()}has(e){return this.suggestions.has(e)}hasIndex(e){return!!this.suggestions.values.find((t=>t.index===e))}get(e){return this.suggestions.get(e)}getByAccepted(...e){return this.suggestions.values.filter((t=>e.includes(t.accepted)))}accept(...e){return this.updateAll(e,{accepted:!0})}reject(...e){return this.updateAll(e,{accepted:!1})}reset(...e){return this.updateAll(e,{accepted:null})}show(...e){return this.updateAll(e,{visible:!0})}hide(...e){return this.updateAll(e,{visible:!1})}updateAll(e,t){const s=e.length?e:this.suggestions.keys;this.atomic((()=>{this.suggestions.atomic((()=>{for(const e of s)if(this.has(e)){const s=this.get(e);Object.assign(s,t),s.commit()}})),this.commit()}))}}},91443:(e,t,s)=>{"use strict";s.d(t,{ee:()=>a,mA:()=>r,oA:()=>l,qY:()=>n,rf:()=>o});var i=s(19663);class n extends i.m{constructor(){super(...arguments),this.id="SAVE_BLUR_SUGGESTIONS"}}class a extends i.m{constructor(...e){super(),this.id="SHOW_BLUR_SUGGESTIONS",this.payload={ids:e}}}class r extends i.m{constructor(...e){super(),this.id="HIDE_BLUR_SUGGESTIONS",this.payload={ids:e}}}class o extends i.m{constructor(...e){super(),this.id="ACCEPT_BLUR_SUGGESTIONS",this.payload={ids:e}}}class l extends i.m{constructor(...e){super(),this.id="REJECT_BLUR_SUGGESTIONS",this.payload={ids:e}}}},15984:(e,t,s)=>{"use strict";s.r(t),s.d(t,{BlurSuggestionData:()=>i.a,default:()=>O});var i=s(22645),n=s(97542),a=s(69170),r=s(2541),o=s(71954),l=s(64567),d=s(13117),u=s(98333),c=s(66222),h=s(79728),m=s(635);class g{constructor(e){this.config=e}async read(){const{url:e,deserializer:t,format:s,queue:i}=this.config;let n=await i.get(e);return"json"===s&&(n=JSON.parse(n)),t?t(n):n}}var p=s(53954),b=s(53261),f=s(62285),v=s(91443),S=s(3907),B=s(75287),w=s(39880);class C extends B.T{constructor(e){super(),this.accepted=null,this.index=-1,this.classification=[],this.visible=!0,this.id=(0,w.O1)(11),e&&Object.assign(this,e)}}var y=s(73635),E=s(97998),T=s(9133);const x=new E.Z("blurSuggestionDeserializer");function I(e){const t=function(e){return function(t){const s=(0,y.LB)(null==t?void 0:t.dots),i=e.getSweepByUuid(null==t?void 0:t.sweepId);if(!(t&&s&&s.length&&i))return x.debug("Deserialized invalid Blur suggestion",t),null;const n=!0===t.accepted||!1===t.accepted?t.accepted:null;return new C({id:t.sid,accepted:n,dots:s,index:t.index,floorId:i.floorId,roomId:i.roomId,sweepId:i.id,classification:t.tags||[],visible:!0,created:(0,T.p)(t.created),modified:(0,T.p)(t.modified)})}}(e);return function(e){const s={};for(const i in e){const n=t(e[i]);n&&(s[i]=n)}return s}}var D=s(50257);function _(e){const t=function(e){return function(t){const s=e.getSweep(t.sweepId),i=(0,D.o_)(t.dots);return s&&(null==i?void 0:i.length)?{sid:t.id,accepted:t.accepted,dots:i,index:t.index,sweepId:s.uuid,tags:t.classification,visible:t.visible,created:(0,T.U)(t.created),modified:(0,T.U)(t.modified)}:null}}(e);return function(e){const s={};for(const i in e){const n=t(e[i]);n&&(s[i]=n)}return s}}class P extends S.MU{constructor(e){const{queue:t,baseUrl:s,modelId:i,sweepData:n}=e;super({queue:t,path:`${s}/api/v1/jsonstore/model/blur-suggestions/${i}`,batchUpdate:!0,deserialize:I(n),serialize:_(n)}),this.baseUrl=s,this.modelId=i}async read(){const e=await super.read();return Object.values(e||{})}async reset(){var e;const{queue:t}=this.config,s=`${this.baseUrl}/api/v1/jsonstore/model/blur-suggestions/${this.modelId}`;if(!(null===(e=this.modelId)||void 0===e?void 0:e.length))throw new Error(`Refusing to DELETE ${s}`);if(window.confirm("Are you sure you want to reset all suggestions? This cannot be undone."))return t.delete(s,this.options).then((()=>{window.location.reload()}))}}function k(e){return t=>{const s=[];if(!(null==t?void 0:t.blurs))return[];const i=Object.values(t.blurs).filter((e=>!e.blurEnabled));for(const t of i){const i=e.getSweepByUuid(t.sweepId),n=(0,y.LB)(t.dots);if(!(null==n?void 0:n.length)||!i||!Array.isArray(null==t?void 0:t.dots))continue;const a=new C({accepted:null,sweepId:i.id,dots:n,classification:["face"],floorId:i.floorId||void 0,visible:!0});s.push(a)}return s}}class O extends n.Y{constructor(){super(...arguments),this.name="blur-suggestions"}async init(e,t){this.engine=t,this.config=e,await this.load(),await this.registerSettings()}async load(){const{baseUrl:e,modelId:t,queue:s,readonly:n}=this.config,{market:o,commandBinder:u}=this.engine,[c,g]=await Promise.all([o.waitForData(d.f),o.waitForData(p.Z)]);this.blurData=c,this.store=new P({queue:s,baseUrl:e,modelId:t,sweepData:g}),this.data=new i.a;const b=this.store.read();if(this.log.debug("Loaded existing suggestions",b),b&&b.then((async e=>{if(this.data)if(0===e.length){const e=await this.getSuggestionsFromVision();if(!this.data||0===e.length)return;this.data.add(...e),this.log.debug(`Importing ${e.length} suggestions from Vision...`),u.issueCommand(new v.qY)}else this.data.add(...e||[])})),!n){const e=await this.engine.getModuleBySymbol(a.y.STORAGE);this.bindings.push(u.addBinding(v.qY,(()=>u.issueCommand(new m.VQ({dataTypes:[h.g.BLUR_SUGGESTIONS]})))),u.addBinding(v.rf,(({ids:e})=>this.accept(...e))),u.addBinding(v.oA,(({ids:e})=>this.reject(...e))),u.addBinding(v.ee,(({ids:e})=>this.show(...e))),u.addBinding(v.mA,(({ids:e})=>this.hide(...e))),e.onSave((()=>this.save()),{dataType:h.g.BLUR_SUGGESTIONS}))}o.register(this,i.a,this.data),n||(this.monitor=new l.c(this.data.suggestions,{aggregationType:r.E.Manual}))}dispose(e){super.dispose(e),e.market.unregister(this,i.a),this.data=void 0}async accept(...e){const{commandBinder:t}=this.engine,s=e.length?e.map((e=>this.data.get(e))):this.data.getByAccepted(null),i=s.map((e=>u.x.from(e)));return this.blurData.add(...i),this.data.accept(...s.map((e=>e.id))),Promise.all([t.issueCommand(new c.o8),t.issueCommand(new v.qY)]).then((()=>{}))}async reject(...e){const{commandBinder:t}=this.engine,s=e.length?e:this.data.getByAccepted(null).map((e=>e.id));return this.data.reject(...s),t.issueCommand(new v.qY)}async show(...e){this.data.show(...e)}async hide(...e){this.data.hide(...e)}async save(){const{readonly:e}=this.config;if(e||!this.monitor)return;this.monitor.commitChanges();const t=this.monitor.getDiffRecord();if(this.monitor.clearDiffRecord(),!t.length)return;const s={};for(const e of t)switch(e.action){case o.KI.added:case o.KI.updated:s[e.index]=this.data.get(e.index);break;case o.KI.removed:s[e.index]=null}return this.store.update(s).catch((e=>{this.log.error(e)}))}async getSuggestionsFromVision(){const{market:e}=this.engine,[t,s]=await Promise.all([e.waitForData(f.R),e.waitForData(p.Z)]);let i=null;const n=t.objectBlur;if(null==n?void 0:n.url){const e=new g({url:n.url,queue:this.config.queue||new b.gO,format:"json",deserializer:k(s)});i=await e.read()}return i||[]}async registerSettings(){const e=await this.engine.getModuleBySymbol(a.y.SETTINGS),{debug:t}=this.config;t&&e.registerMenuButton({header:"Blur Suggestions",buttonName:"Reset Suggestions",callback:()=>{this.store.reset()}})}}},62285:(e,t,s)=>{"use strict";s.d(t,{R:()=>n});var i=s(67992);class n extends i.V{constructor(e=[]){super(),this.catalog=e}get objectAnnotations(){return this.catalog.find((e=>"objectAnnotations"===e.name))}get semantic(){return this.catalog.find((e=>"semantic"===e.name))}get detectedObjects(){return this.catalog.find((e=>"detectedObjects"===e.name))}get objectBlur(){return this.catalog.find((e=>"objectBlur"===e.name))}getCatalog(){return this.catalog}getAsset(e){return this.catalog.find((t=>t.name===e))}findFilename(e){return this.catalog.find((t=>t.url.includes(e)))}}},47018:(e,t,s)=>{"use strict";s.r(t),s.d(t,{default:()=>c});var i=s(97542),n=s(62285),a=s(5244),r=s(2942),o=s(17788),l=s(9133);class d extends o.u{constructor(e,t=!1){super(e),this.loadCatalog=t}async read(){return this._readAssets().then((e=>!e.length||this.loadCatalog?this._readCatalog():e))}_readAssets(){const e={modelId:this.getViewId()};return this.query(a.GetVisionAssets,e).then((e=>{var t,s;const i=[],n=null===(s=null===(t=null==e?void 0:e.data)||void 0===t?void 0:t.model)||void 0===s?void 0:s.objectBlur;return(null==n?void 0:n.url)&&i.push({name:"objectBlur",contentType:n.contentType||"unknown",format:n.format,url:n.url,validUntil:(0,l.p)(n.validUntil)}),i}))}_readCatalog(){const e={modelId:this.getViewId()};return this.query(r.GetVisionCatalog,e).then((e=>{var t,s,i;const n=(null===(i=null===(s=null===(t=null==e?void 0:e.data)||void 0===t?void 0:t.model)||void 0===s?void 0:s.assets)||void 0===i?void 0:i.catalog)||[],a=[];return n.forEach((e=>{if(null==e?void 0:e.url){let t=e.type||"unknown";"unknown"===t&&e.url.match(/object\//i)&&(t="objectAnnotations"),"unknown"===t&&e.url.match(/blur/i)&&(t="objectBlur"),"unknown"===t&&e.url.match(/detected/i)&&(t="detectedObjects"),"unknown"===t&&e.url.includes("semantic/room_boundaries.json")&&(t="room-bounds"),a.push({name:t,format:e.format,url:e.url,contentType:e.format,validUntil:(0,l.p)(e.validUntil)})}})),a}))}}var u=s(80742);class c extends i.Y{constructor(){super(...arguments),this.name="vision-catalog"}async init(e,t){const s=await t.market.waitForData(u.R),i=new d({context:s.mdsContext,readonly:!0,viewId:e.baseModelId},e.loadCatalog),a=await i.read().catch((e=>(this.log.info("Failed to load Vision Catalog"),[])));this.data=new n.R(a),t.market.register(this,n.R,this.data)}dispose(e){super.dispose(e),e.market.unregister(this,n.R)}}},98333:(e,t,s)=>{"use strict";s.d(t,{x:()=>r});var i=s(75287),n=s(39880),a=s(66310);class r extends i.T{constructor(e){super(),this.dots=[],this.status=a.Q.PENDING,this.floorId=null,this.roomId=null,this.visible=!0,this.created=new Date,this.modified=new Date,this.id=(0,n.O1)(11),this.index=-1,e&&Object.assign(this,e)}get editable(){return r.editableStatus.includes(this.status)}add(e,t,s,i){let n=this.dots.find((e=>e.radius===t&&e.feather===s&&e.strength===i));n||(n={radius:t,feather:s,strength:i,directions:[]},this.dots.push(n)),n.directions.push(e),this.modified.setTime(Date.now()),this.commit()}static from(e){return new r({status:a.Q.PENDING,dots:e.dots,sweepId:e.sweepId,floorId:e.floorId||null})}get dotCount(){return this.dots.reduce(((e,t)=>e+t.directions.length),0)}get sid(){return this.id}}r.editableStatus=[a.Q.FAILED,a.Q.PENDING]},13117:(e,t,s)=>{"use strict";s.d(t,{f:()=>d});var i=s(67992),n=s(15637),a=s(37082),r=s(39880),o=s(97998),l=s(66310);new o.Z("BlurData");class d extends i.V{constructor(e){super(),this.name="blur-data",this.blurs=new n.v,this._hasProcessing=new a.f(!1),this._hasUnapplied=new a.f(!1),e&&this.add(...Object.values(e))}add(...e){this.atomic((()=>{this.blurs.atomic((()=>{for(const t of e)t.atomic((()=>{for(;!t.id||this.blurs.has(t.id);)t.id=(0,r.O1)(11),t.commit();if(-1===t.index||this.hasIndex(t.index)){const e=this.blurs.values.map((e=>e.index)).filter((e=>"number"==typeof e)),s=e.length?Math.max(...e):0;t.index=s+1,t.commit()}})),this.blurs.set(t.id,t)})),this.update(),this.commit()}))}delete(...e){return this.atomic((()=>{this.blurs.atomic((()=>{e.filter((e=>this.isEditable(e)&&this.blurs.delete(e)))})),this.update(),this.commit()})),e.length}get(e){return this.blurs.get(e)}getEditable(){return this.blurs.values.filter((e=>e.editable))}getBySweepId(e,t=null){return this.blurs.values.filter((s=>s.sweepId===e&&(null===t||s.visible===t)))}getByStatus(...e){return e.length?this.blurs.values.filter((t=>e.includes(t.status))):this.blurs.values}batchToggleVisibility(e){const t=e.some((e=>{const t=this.blurs.get(e);return!!t&&!t.visible}));for(const s of e){const e=this.blurs.get(s);e&&(e.visible=t,e.commit())}}has(e){return this.blurs.has(e)}hasIndex(e){return!!this.blurs.values.find((t=>t.index===e))}hasStatus(e){return this.blurs.values.some((t=>t.status===e))}hasUnappliedBlurs(){return this.blurs.values.some((e=>e.status===l.Q.PENDING||e.status===l.Q.FAILED))}hasAppliedBlurs(){return this.blurs.values.some((e=>e.status===l.Q.PROCESSING||e.status===l.Q.APPLIED||e.status===l.Q.FAILED))}hasProcessingBlurs(){return this.hasStatus(l.Q.PROCESSING)}setVisibility(e,...t){this.atomic((()=>{this.blurs.atomic((()=>{for(const s of t)if(this.has(s)){const t=this.blurs.get(s);t.visible=e,t.modified.setTime(Date.now()),t.commit()}})),this.commit()}))}setStatus(e,...t){this.atomic((()=>{this.blurs.atomic((()=>{for(const s of t)if(this.has(s)){const t=this.blurs.get(s);t.status=e,t.modified.setTime(Date.now()),t.commit()}})),this.update(),this.commit()}))}isEditable(e){if(!this.has(e))return!1;return this.get(e).editable}makeProcessingSubscription(e){return this._hasProcessing.onChanged(e)}makeUnappliedSubscription(e){return this._hasUnapplied.onChanged(e)}update(){let e=!1;const t=this.hasProcessingBlurs();t!==this._hasProcessing.value&&(this._hasProcessing.value=t,e=!0);const s=this.hasUnappliedBlurs();s!==this._hasUnapplied.value&&(this._hasUnapplied.value=s,e=!0),e&&this.commit()}onChanged(e){return super.onChanged(e)}}},66310:(e,t,s)=>{"use strict";var i;s.d(t,{Q:()=>i}),function(e){e.PENDING="pending",e.PROCESSING="processing",e.APPLIED="applied",e.FAILED="failed"}(i||(i={}))},66222:(e,t,s)=>{"use strict";s.d(t,{Mh:()=>l,TL:()=>n,ie:()=>r,o8:()=>a,s$:()=>o});var i=s(19663);class n extends i.m{constructor(...e){super(),this.id="DELETE_BLURS",this.payload={ids:e}}}class a extends i.m{constructor(){super(...arguments),this.id="SAVE_BLURS"}}class r extends i.m{constructor(){super(...arguments),this.id="PUBLISH_BLURS_COMMAND"}}class o extends i.m{constructor(){super(...arguments),this.id="REFRESH_BLURS_COMMAND"}}class l extends i.m{constructor(){super(...arguments),this.id="APPLY_BLURS_COMMAND"}}},81702:(e,t,s)=>{"use strict";s.r(t),s.d(t,{ApplyBlursCommand:()=>i.Mh,Blur:()=>r.x,BlurData:()=>n.f,BlurStatus:()=>a.Q,DeleteBlursCommand:()=>i.TL,PublishBlursCommand:()=>i.ie,RefreshBlursCommand:()=>i.s$,SaveBlursCommand:()=>i.o8,default:()=>y});var i=s(66222),n=s(13117),a=s(66310),r=s(98333),o=s(97542),l=s(69170),d=s(2541),u=s(71954),c=s(64567),h=s(79728),m=s(635),g=s(53954),p=s(3907),b=s(39880),f=s(97998),v=s(36074),S=s(73635),B=s(50257);const w=new f.Z("BlurStore");class C extends p.MU{constructor(e){const{baseUrl:t,modelId:s,queue:i,sweepData:n}=e;super({queue:i,path:`${t}/api/v1/jsonstore/model/blurs/${s}`,batchUpdate:!0,deserialize:(0,S.B4)(n),serialize:(0,B.fM)(n)}),this.queue=i,this.baseUrl=t,this.modelId=s,this.serialize=(0,B.o2)(n)}async apply(e,{useChunks:t,meshBlurEnabled:s,pipelineEnabled:i}){if(!i)return void w.info("Pipeline disabled, no blurs will be applied to the model");const n={enableMeshBlur:s,levels:v.TW.map((e=>({size:e.size,sigmaRadians:.5*e.sigma/e.size})))},a={};for(const s of e){const e=t?s.sweepId:0,i=this.serialize(s);i&&(a[e]||(a[e]={}),a[e][s.id]=i)}const r=Object.keys(a).length,o=[];for(const e in a){const s=a[e];t&&w.debug(`Applying ${Object.values(s).length} blurs to Sweep ${e}`);const i=this.queue.post(`${this.baseUrl}/api/v2/pano-edit/${this.modelId}/blur-panos`,{withCredentials:!0,body:{blurs:s,options:n}});o.push(i),r>o.length&&(w.debug("waiting 100ms"),await(0,b.gw)(250))}return Promise.all(o)}}class y extends o.Y{constructor(){super(...arguments),this.name="blur_data",this.refreshPromise=null,this.saveBlurs=async()=>{const{commandBinder:e}=this.engine;return e.issueCommand(new m.VQ({dataTypes:[h.g.BLURS]}))},this.onApplyBlursCommand=()=>this.applyBlurs()}async init(e,t){this.engine=t,this.config=e,await this.load(t)}dispose(e){super.dispose(e),e.market.unregister(this,n.f),this.data=void 0}async configureStorage(){if(this.store)return;const{baseUrl:e,modelId:t,queue:s,readonly:n}=this.config,{commandBinder:a,market:r}=this.engine,o=await r.waitForData(g.Z);this.store=new C({baseUrl:e,modelId:t,queue:s,sweepData:o}),n||(this.bindings.push(a.addBinding(i.s$,(()=>this.refresh())),a.addBinding(i.Mh,this.onApplyBlursCommand),a.addBinding(i.o8,this.saveBlurs),a.addBinding(i.TL,(async({ids:e})=>this.deleteById(...e)))),this.engine.getModuleBySymbol(l.y.STORAGE).then((e=>{this.bindings.push(e.onSave((()=>this.save()),{dataType:h.g.BLURS}))})))}async load(e){await this.configureStorage(),this.settings=await e.getModuleBySymbol(l.y.SETTINGS),this.data=new n.f,e.market.register(this,n.f,this.data);const t=await this.store.read();this.data.add(...Object.values(t||{})),this.monitor=new c.c(this.data.blurs,{aggregationType:d.E.Manual})}async refresh(){if(this.refreshPromise)return;if(!this.data.hasAppliedBlurs())return;const e=this.store.read().then((e=>{this.updateBlursFrom(...Object.values(e||{}))})).finally((()=>{this.refreshPromise=null}));return this.refreshPromise=e,e}async save(){if(!this.monitor||this.config.readonly)return void this.log.warn("Blur changes will NOT be saved");await this.refresh(),this.monitor.commitChanges();const e=this.monitor.getDiffRecord().filter((({index:e,action:t})=>t===u.KI.removed||this.data.has(e)&&this.data.get(e).editable));if(this.monitor.clearDiffRecord(),!e.length)return;const t={};for(const s of e)switch(s.action){case u.KI.added:case u.KI.updated:t[s.index]=this.data.get(s.index);break;case u.KI.removed:t[s.index]=null}return this.store.update(t)}async applyBlurs(){var e,t,s;if(this.data.hasProcessingBlurs())return;await this.save();const i=this.data.getByStatus(a.Q.PENDING,a.Q.FAILED);if(!i.length)return;i.length>v.Dr&&(this.log.info(`Applying Blurs: Truncating request to the maximum of ${v.Dr} Blurs. Total Pending: ${i.length}`),i.length=v.Dr),this.data.setStatus(a.Q.PROCESSING,...i.map((e=>e.id))),this.log.info(`Applying ${i.length} blurs...`);const n=null===(e=this.settings)||void 0===e?void 0:e.tryGetProperty(v.n5,!1),r=null===(t=this.settings)||void 0===t?void 0:t.tryGetProperty(v.i7,!1),o=null===(s=this.settings)||void 0===s?void 0:s.tryGetProperty(v.pv,!1);return this.store.apply(i,{useChunks:o,meshBlurEnabled:r,pipelineEnabled:n})}async deleteById(...e){if(this.data.delete(...e))return this.save()}updateBlursFrom(...e){this.data.atomic((()=>{e.forEach((e=>{if(this.data.has(e.id)){const t=this.data.get(e.id);e.status!==t.status&&(t.status=e.status,t.modified.setTime(e.modified.getTime()),t.commit())}}))}))}}},73635:(e,t,s)=>{"use strict";s.d(t,{B4:()=>h,LB:()=>m});var i=s(9133),n=s(97998),a=s(2569),r=s(98333),o=s(66310),l=s(36074),d=s(92542),u=s(63252);const c=new n.Z("blurDeserializer");function h(e){const t=function(e){return function(t){var s;const n=m(null==t?void 0:t.dots),a=e.getSweepByUuid(null===(s=null==t?void 0:t.sweepId)||void 0===s?void 0:s.replace(/-/g,""));if(!(t&&n&&n.length&&a))return c.debug("Deserialized invalid Blur",t),null;const d=new r.x({id:t.sid,index:"number"==typeof t.index?t.index:-1,status:t.status,sweepId:a.id,created:(0,i.p)(t.created)});return a.placementType!==u.hU.UNPLACED&&(d.floorId=a.floorId,d.roomId=a.roomId),n.forEach((e=>{e.directions.forEach((t=>{d.add(t,e.radius,e.feather,e.strength)}))})),d.modified=(0,i.p)(t.modified),d.status===o.Q.PROCESSING&&Date.now()-d.modified.getTime()>l.gJ&&(d.status=o.Q.FAILED),d}}(e);return function(e){const s={};for(const i of Object.values(e)){const e=t(i);e&&(s[e.id]=e)}return s}}function m(e){if(!e||!Array.isArray(e))return null;const t=[];for(const s of e)if(g(s)){const e=s.unitVectors.map((e=>a.ep.fromVisionVector({x:"string"==typeof e.x?parseFloat(e.x):e.x,y:"string"==typeof e.y?parseFloat(e.y):e.y,z:"string"==typeof e.z?parseFloat(e.z):e.z})));t.push({directions:e,radius:(0,d.d)(s.radius),feather:"string"==typeof s.feather?parseFloat(s.feather):s.feather,strength:"string"==typeof s.strength?parseFloat(s.strength):s.strength})}return t}function g(e){return["unitVectors","radius","strength","feather"].every((t=>t in e))}},50257:(e,t,s)=>{"use strict";s.d(t,{fM:()=>l,o2:()=>o,o_:()=>d});var i=s(9133),n=s(2569),a=s(59296),r=s(92542);function o(e){return function(t){if(!t)return null;const s=e.getSweep(t.sweepId),n=d(t.dots);if(!s||!(null==n?void 0:n.length))return null;return{sid:t.id,index:t.index,sweepId:s.uuid,status:t.status,dots:n,visible:t.visible,created:(0,i.U)(t.created),modified:(0,i.U)(t.modified)}}}function l(e){const t=o(e);return function(e){const s={};for(const i of Object.values(e)){const e=t(i);e&&(s[i.id]=e)}return s}}function d(e){if(!e)return null;return function(e,t=5){return e.map((e=>({unitVectors:e.unitVectors.map((e=>({x:(0,n.Zd)(e.x,t),y:(0,n.Zd)(e.y,t),z:(0,n.Zd)(e.z,t)}))),radius:(0,n.Zd)(e.radius,t),feather:(0,n.Zd)(e.feather,t),strength:(0,n.Zd)(e.strength,3)})))}(e.map((e=>({unitVectors:e.directions.map((e=>(0,a.m)(n.ep.toVisionVector(e)))),radius:(0,r.t)(e.radius),feather:e.feather,strength:e.strength}))))}},92542:(e,t,s)=>{"use strict";s.d(t,{d:()=>a,t:()=>n});var i=s(36074);function n(e){return Math.atan(e/i.U_)}function a(e){return i.U_*Math.tan(e)}},58611:(e,t,s)=>{"use strict";s.d(t,{M:()=>n});var i=s(19663);class n extends i.m{constructor(e,t,s){super(),this.id="SET_PANO_OVERLAY",this.payload={sweepId:e,texture:t,quaternion:s}}}},3907:(e,t,s)=>{"use strict";s.d(t,{MU:()=>o});var i,n=s(39880),a=s(44584);!function(e){e.GET="GET",e.POST="POST",e.PATCH="PATCH",e.PUT="PUT",e.DELETE="DELETE",e.OPTIONS="OPTIONS"}(i||(i={}));class r extends class{constructor(){this._options={responseType:"json"}}get options(){const e=this._options;return e.headers=(0,a.m)(this.url,this._options.headers||{}),e}}{constructor(e){super(),this.config=e,this.url=e.path}async read(){const{deserialize:e}=this.config;let t=null;return this.config.cachedData&&this.config.cachedData.data?t=this.config.cachedData.data:(t=await this.config.queue.get(this.config.path,this.options),this.config.cachedData&&(this.config.cachedData.data=t)),e(t)}clearCache(){this.config.cachedData&&(this.config.cachedData.data=null)}}class o extends r{constructor(e){super(e),this.config=e,this.acceptsPartial=!1,this.config.batchUpdate="batchUpdate"in this.config&&this.config.batchUpdate}async create(e){throw Error("Not implemented")}updateBatch(e,t){const{serialize:s}=this.config,n=[],a=[...new Set([...Object.keys(e),...Object.keys(t)])];for(const s of a){e[s]||t[s]||n.push(this.config.queue.delete(`${this.config.path}/${s}`,this.options))}const r=s(e,t),o=Object.assign(Object.assign({},this.options),{body:r});return n.push(this.config.queue.request(this.config.httpMethod||i.POST,this.config.path,o)),Promise.all(n)}updateInternal(e,t){const{serialize:s}=this.config,a=[],r=Object.assign({},this.options),o=Object.keys(e),l=Object.keys(t),d=(0,n.XN)(o.concat(l));for(const n in d){const o=d[n],l=e[o]||t[o];if(l){const e={};e[o]=l;const n={},d=t[o];d&&(n[o]=d);const u=s(e,n);r.body=u,a.push(this.config.queue.request(this.config.httpMethod||i.POST,this.config.path,r))}else a.push(this.config.queue.delete(`${this.config.path}/${o}`,this.options))}return Promise.all(a)}async update(e,t){this.clearCache(),await(this.config.batchUpdate?this.updateBatch(e,t||{}):this.updateInternal(e,t||{}))}async delete(e){throw Error("Not implemented")}}},65794:e=>{e.exports="precision highp float;precision highp int;uniform mat4 viewMatrix;uniform vec3 cameraPosition;uniform vec3 opacity;uniform vec3 radius;uniform vec3 feather;uniform vec3 color;varying vec4 vCenter;varying vec4 vPosition;void main(){float fragRadius=length(vPosition.xyz-vCenter.xyz);vec3 featherStart=radius-feather;vec3 circleAlphaWithFeather=1.-max(fragRadius-featherStart,0.)/(feather*2.);gl_FragColor=vec4(color.rgb*opacity*circleAlphaWithFeather,1.);}"},59285:e=>{e.exports="precision highp float;precision highp int;uniform mat4 modelMatrix;uniform mat4 modelViewMatrix;uniform mat4 projectionMatrix;uniform mat4 viewMatrix;uniform mat3 normalMatrix;uniform vec3 cameraPosition;attribute vec3 position;attribute vec3 normal;attribute vec2 uv;attribute mat4 instanceMatrix;varying vec4 vCenter;varying vec4 vPosition;void main(){vPosition=instanceMatrix*vec4(position,1.);vCenter=instanceMatrix*vec4(0.,0.,0.,1.);gl_Position=projectionMatrix*modelViewMatrix*vPosition;}"},34468:e=>{e.exports="precision highp float;precision highp int;uniform mat4 viewMatrix;uniform vec3 cameraPosition;varying vec4 maskPosition;varying vec4 panoPosition;uniform samplerCube maskTexture;uniform samplerCube panoBlurredMap0;uniform samplerCube panoBlurredMap1;uniform samplerCube panoBlurredMap2;uniform samplerCube panoBlurredMap3;const vec4 SELECTED_OUTLINE_COLOR=vec4(1.,1.,1.,1.);const vec4 HOVER_COLOR=vec4(1.,1.,1.,1.);vec4 combineBlurs(vec4 mask,vec4 blurredColor0,vec4 blurredColor1,vec4 blurredColor2,vec4 blurredColor3){float maskAlpha=mask.r;float selectedAlpha=mask.g;float hoveredAlpha=mask.b;float targetSigma=maskAlpha*(4.*4.-1.);float blurRatio=log2(1.+targetSigma);float panoAlpha=max(1.-abs(blurRatio-0.)/1.,0.);float blurAlpha0=max(1.-abs(blurRatio-1.)/1.,0.);float blurAlpha1=max(1.-abs(blurRatio-2.)/1.,0.);float blurAlpha2=max(1.-abs(blurRatio-3.)/1.,0.);float blurAlpha3=max(1.-abs(blurRatio-4.)/1.,0.);float alpha=blurAlpha0+blurAlpha1+blurAlpha2+blurAlpha3;vec4 color=(panoAlpha*blurredColor0+blurAlpha0*blurredColor0+blurAlpha1*blurredColor1+blurAlpha2*blurredColor2+blurAlpha3*blurredColor3);color.a=alpha;float selectedMaskAlpha=smoothstep(0.65,0.75,selectedAlpha)*(1.-smoothstep(0.85,0.95,selectedAlpha));color=mix(color,SELECTED_OUTLINE_COLOR,selectedMaskAlpha);color=mix(color,HOVER_COLOR,hoveredAlpha*0.3);return color;}void main(){vec4 mask=textureCube(maskTexture,maskPosition.xyz);\n#ifdef DEBUG_BLUR_LEVELS\nmask=vec4(fract(gl_FragCoord.x/2048.),0.,0.,1.);\n#endif\nvec4 blurredColor0=textureCube(panoBlurredMap0,panoPosition.xyz);vec4 blurredColor1=textureCube(panoBlurredMap1,panoPosition.xyz);vec4 blurredColor2=textureCube(panoBlurredMap2,panoPosition.xyz);vec4 blurredColor3=textureCube(panoBlurredMap3,panoPosition.xyz);\n# ifdef DEBUG_BLUR_LEVELS\nif(gl_FragCoord.y>2000.){blurredColor0=vec4(1.,0.,0.,1.);blurredColor1=vec4(0.,1.,0.,1.);blurredColor2=vec4(0.,0.,1.,1.);blurredColor3=vec4(0.,1.,1.,1.);}\n#elif defined(DEBUG_BLUR_COLORS)\nblurredColor0=vec4(1.,0.,0.,1.);blurredColor1=vec4(0.,1.,0.,1.);blurredColor2=vec4(0.,0.,1.,1.);blurredColor3=vec4(0.,1.,1.,1.);\n#endif\ngl_FragColor=combineBlurs(mask,blurredColor0,blurredColor1,blurredColor2,blurredColor3);}"},77288:e=>{e.exports="precision highp float;precision highp int;uniform mat4 modelMatrix;uniform mat4 modelViewMatrix;uniform mat4 projectionMatrix;uniform mat4 viewMatrix;uniform mat3 normalMatrix;uniform vec3 cameraPosition;attribute vec3 position;attribute vec3 normal;attribute vec2 uv;varying vec4 maskPosition;varying vec4 panoPosition;uniform mat4 maskMatrix;uniform mat4 panoMatrix1;uniform mat4 panoMatrix2;void main(){vec4 worldPosition=modelMatrix*vec4(position,1.);maskPosition=maskMatrix*worldPosition;panoPosition=panoMatrix2*panoMatrix1*worldPosition;gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.);}"},5244:e=>{var t={kind:"Document",definitions:[{kind:"OperationDefinition",operation:"query",name:{kind:"Name",value:"GetVisionAssets"},variableDefinitions:[{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"modelId"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"model"},arguments:[{kind:"Argument",name:{kind:"Name",value:"id"},value:{kind:"Variable",name:{kind:"Name",value:"modelId"}}}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",alias:{kind:"Name",value:"objectBlur"},name:{kind:"Name",value:"asset"},arguments:[{kind:"Argument",name:{kind:"Name",value:"id"},value:{kind:"StringValue",value:"blurs/suggestions",block:!1}}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"status"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"contentType"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"filename"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"format"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"url"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"validUntil"},arguments:[],directives:[]},{kind:"InlineFragment",typeCondition:{kind:"NamedType",name:{kind:"Name",value:"BlurSuggestionAsset"}},directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"version"},arguments:[],directives:[]}]}}]}}]}}]}}],loc:{start:0,end:383}};t.loc.source={body:'# Fetches public output files from the Vision Catalog,\n# only available after platform 21.21.1 release\nquery GetVisionAssets($modelId: ID!) {\n  model(id: $modelId) {\n    objectBlur: asset(id: "blurs/suggestions") {\n      id\n      status\n      contentType\n      filename\n      format\n      url\n      validUntil\n      ... on BlurSuggestionAsset {\n          version\n      }\n    }\n  }\n}\n',name:"GraphQL request",locationOffset:{line:1,column:1}};function s(e,t){if("FragmentSpread"===e.kind)t.add(e.name.value);else if("VariableDefinition"===e.kind){var i=e.type;"NamedType"===i.kind&&t.add(i.name.value)}e.selectionSet&&e.selectionSet.selections.forEach((function(e){s(e,t)})),e.variableDefinitions&&e.variableDefinitions.forEach((function(e){s(e,t)})),e.definitions&&e.definitions.forEach((function(e){s(e,t)}))}var i={};function n(e,t){for(var s=0;s<e.definitions.length;s++){var i=e.definitions[s];if(i.name&&i.name.value==t)return i}}t.definitions.forEach((function(e){if(e.name){var t=new Set;s(e,t),i[e.name.value]=t}})),e.exports=t,e.exports.GetVisionAssets=function(e,t){var s={kind:e.kind,definitions:[n(e,t)]};e.hasOwnProperty("loc")&&(s.loc=e.loc);var a=i[t]||new Set,r=new Set,o=new Set;for(a.forEach((function(e){o.add(e)}));o.size>0;){var l=o;o=new Set,l.forEach((function(e){r.has(e)||(r.add(e),(i[e]||new Set).forEach((function(e){o.add(e)})))}))}return r.forEach((function(t){var i=n(e,t);i&&s.definitions.push(i)})),s}(t,"GetVisionAssets")},2942:e=>{var t={kind:"Document",definitions:[{kind:"OperationDefinition",operation:"query",name:{kind:"Name",value:"GetVisionCatalog"},variableDefinitions:[{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"modelId"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"model"},arguments:[{kind:"Argument",name:{kind:"Name",value:"id"},value:{kind:"Variable",name:{kind:"Name",value:"modelId"}}}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"assets"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"catalog"},arguments:[{kind:"Argument",name:{kind:"Name",value:"formats"},value:{kind:"ListValue",values:[{kind:"StringValue",value:"json",block:!1}]}}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"format"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"type"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"contentType"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"description"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"url"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"validUntil"},arguments:[],directives:[]}]}}]}}]}}]}}],loc:{start:0,end:290}};t.loc.source={body:'# Fetches Vision Catalog assets, restricted to staff users\nquery GetVisionCatalog($modelId: ID!) {\n  model(id: $modelId) {\n    assets {\n      catalog(formats: ["json"]) {\n        format\n        type\n        contentType\n        description\n        url\n        validUntil\n      }\n    }\n  }\n}\n',name:"GraphQL request",locationOffset:{line:1,column:1}};function s(e,t){if("FragmentSpread"===e.kind)t.add(e.name.value);else if("VariableDefinition"===e.kind){var i=e.type;"NamedType"===i.kind&&t.add(i.name.value)}e.selectionSet&&e.selectionSet.selections.forEach((function(e){s(e,t)})),e.variableDefinitions&&e.variableDefinitions.forEach((function(e){s(e,t)})),e.definitions&&e.definitions.forEach((function(e){s(e,t)}))}var i={};function n(e,t){for(var s=0;s<e.definitions.length;s++){var i=e.definitions[s];if(i.name&&i.name.value==t)return i}}t.definitions.forEach((function(e){if(e.name){var t=new Set;s(e,t),i[e.name.value]=t}})),e.exports=t,e.exports.GetVisionCatalog=function(e,t){var s={kind:e.kind,definitions:[n(e,t)]};e.hasOwnProperty("loc")&&(s.loc=e.loc);var a=i[t]||new Set,r=new Set,o=new Set;for(a.forEach((function(e){o.add(e)}));o.size>0;){var l=o;o=new Set,l.forEach((function(e){r.has(e)||(r.add(e),(i[e]||new Set).forEach((function(e){o.add(e)})))}))}return r.forEach((function(t){var i=n(e,t);i&&s.definitions.push(i)})),s}(t,"GetVisionCatalog")}}]);