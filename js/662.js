(self.webpackChunkmp_webgl=self.webpackChunkmp_webgl||[]).push([[662],{37721:(t,e,i)=>{"use strict";i.d(e,{U:()=>s});class s{constructor(t){this.map=new Map,t.forEach((t=>this.map.set(t.state,t.subs)))}renew(t){(this.map.get(t)||[]).forEach((t=>t.renew()))}cancel(t){if(t){(this.map.get(t)||[]).forEach((t=>t.cancel()))}else this.map.forEach((t=>t.forEach((t=>t.cancel()))))}update(t,e){this.map.set(t,e)}}},95512:(t,e,i)=>{"use strict";i.d(e,{y:()=>o});var s=i(19663);class o extends s.m{constructor(t){super(),this.payload={disable:t}}}},20217:(t,e,i)=>{"use strict";i.d(e,{C:()=>o,h:()=>a});var s=i(19663);class o extends s.m{constructor(t){super(),this.payload=t,this.id="DOLLHOUSE_VERTICAL_LIMITS"}}class a extends s.m{constructor(){super(),this.id="SNAP_DOLLHOUSE_UPPER_LIMIT"}}},61282:(t,e,i)=>{"use strict";i.d(e,{N2:()=>d,O8:()=>m,SI:()=>o,TD:()=>u,bC:()=>g,bp:()=>r,jX:()=>c,mP:()=>h,qj:()=>l,uQ:()=>a,v0:()=>p,zf:()=>n});var s=i(69505);const o=1e3/60,a=89*s.Ue,n=.001*s.Ue,r=10*s.Ue,d=20*s.Ue,l=.25,h=500,c=.1,u=.16,m=.08,p=Math.PI/1e3,g=.02},38613:(t,e,i)=>{"use strict";i.d(e,{h:()=>o});var s=i(67294);function o(t,e,i){const[o,a]=(0,s.useState)(null===t?i:t[e]);return(0,s.useEffect)((()=>{if(null===t)return;const i=t.onPropertyChanged(e,(t=>{a(t)}));return()=>i.cancel()}),[t,e,i]),o}},39564:(t,e,i)=>{"use strict";i.d(e,{t:()=>a});var s=i(67992),o=i(15637);class a extends s.V{constructor(t){super(),this.name="notes-data",this.notes=(0,o.q)(t)}iterate(t){for(const e of this.notes)t(e)}updateNote(t){this.notes.has(t.id)?this.notes.get(t.id).copy(t):this.notes.set(t.id,t)}updateNoteProperties(t,e){if(this.notes.has(t)){const i=this.notes.get(t);let s=!1;void 0!==e.resolved&&e.resolved!==i.resolved&&(i.resolved=e.resolved,s=!0),void 0!==e.color&&e.color!==i.color&&(i.color=e.color,s=!0),void 0!==e.anchorPosition&&e.anchorPosition!==i.anchorPosition&&(i.anchorPosition=e.anchorPosition,s=!0),void 0!==e.stemNormal&&e.stemNormal!==i.stemNormal&&(i.stemNormal=e.stemNormal,s=!0),void 0!==e.stemLength&&e.stemLength!==i.stemLength&&(i.stemLength=e.stemLength,s=!0),void 0!==e.stemEnabled&&e.stemEnabled!==i.stemEnabled&&(i.stemEnabled=e.stemEnabled,s=!0),void 0!==e.floorId&&e.floorId!==i.floorId&&(i.floorId=e.floorId,s=!0),void 0!==e.roomId&&e.roomId!==i.roomId&&(i.roomId=e.roomId,s=!0),s&&i.commit()}}removeNote(t){this.notes.has(t)&&(this.notes.delete(t),this.commit())}getNote(t){return this.notes.get(t)}getNoteProperties(t){const e=this.notes.get(t);if(!e)return null;return Object.assign({},e)}get collection(){return this.notes}}},72957:(t,e,i)=>{"use strict";i.r(e),i.d(e,{default:()=>X});var s=i(97542),o=i(89570),a=i(69170),n=i(35221),r=i(5823),d=i(80742),l=i(34029),h=i(26158),c=i(46391),u=i(54244),m=i(47309),p=i(63422),g=i(38399),v=i(71166),f=i(56163),w=i(76957),y=i(38127),S=i(12039),E=i(15004);class b extends f.K{constructor(t,e,i,s,o,a,d){super(t,e,s),this.room=o,this.title=a,this.id=this.room.id,this.icon=`icon-${(0,E.mX)(this.room.roomTypeIds)}`,this.typeId=r.SF.MODELROOM,this.layerId=p.gi,this.dateBucket=n.Z.OLDER,this.enabled=!0,this.onSelect=async()=>{super.onSelect(),await this.commandBinder.issueCommand(new S.SG(this.room)),await this.commandBinder.issueCommand(new y.et(this.id))},this.floorId=d,this.roomId=o.id;const l=i.tryGetProperty(h.F.UnitType,c.M.IMPERIAL);this.description=this.room.getMeasurementText(l)}}var I=i(57452),D=i(17788),C=i(22999),O=i(97998),A=i(78283);const M=new O.Z("MdsRoomBoundsDeserializer");class V{deserialize(t){var e,i,s,o,a,n,r,d,l,h,c,u,m,g,v;const f={version:0,floors:{}};for(const r of t.floors||[]){const t={edges:{},vertices:{},rooms:{}};f.floors[r.id]=t;for(const s of r.vertices||[])s?t.vertices[s.id]={x:s.position.x,y:s.position.y,layerId:null!==(i=null===(e=s.layer)||void 0===e?void 0:e.id)&&void 0!==i?i:p.gi}:M.warn("Found null vertex in floor vertices!");for(const e of r.edges||[]){if(!e||null===e.thickness||null===e.centerLineBias||null===e.vertices||2!==e.vertices.length){M.warn("Invalid edge!");continue}const i={vertices:e.vertices.map((t=>t.id)),thickness:e.thickness,bias:e.centerLineBias,openings:{},type:e.type||void 0,layerId:null!==(o=null===(s=e.layer)||void 0===s?void 0:s.id)&&void 0!==o?o:p.gi};t.edges[e.id]=i;for(const t of e.openings||[]){if(!t){M.warn("Found null opening!");continue}const e={height:t.height,lowerElevation:t.lowerElevation,relativePos:t.relativeCenter,type:t.type,width:t.width,layerId:null!==(n=null===(a=t.layer)||void 0===a?void 0:a.id)&&void 0!==n?n:p.gi};i.openings[t.id]=e}}}for(const e of t.rooms||[]){if(!e||!e.floor){M.warn("Found null room");continue}if(!f.floors[e.floor.id]){M.warn("Unable to find floor for room!");continue}const t=e.classifications||[].sort(((t,e)=>(t.confidence||0)-(e.confidence||0))),i=null===(r=e.dimensionEstimates)||void 0===r?void 0:r.units,s=(e.label||"").trim();f.floors[e.floor.id].rooms[e.id]={height:.1,lowerElevation:(null===(d=e.boundary)||void 0===d?void 0:d.lowerElevation)||0,edges:(null===(h=null===(l=e.boundary)||void 0===l?void 0:l.edges)||void 0===h?void 0:h.map((t=>t.id)))||[],classifications:t,label:s,width:this.ensureMetric("distance",null===(c=e.dimensionEstimates)||void 0===c?void 0:c.width,i),length:this.ensureMetric("distance",null===(u=e.dimensionEstimates)||void 0===u?void 0:u.depth,i),area:this.ensureMetric("area",null===(m=e.dimensionEstimates)||void 0===m?void 0:m.area,i),layerId:null!==(v=null===(g=e.layer)||void 0===g?void 0:g.id)&&void 0!==v?v:p.gi}}return f}ensureMetric(t,e,i){if(null!=e&&null!=i){const s=i===r.nL.IMPERIAL,o="area"===t?A.W3:A._F;return s?o(e):e}return NaN}}var R=i(16747),N=i(41999),T=i(39011);const L=new O.Z("MdsRoomBoundsStore");class P extends D.u{constructor(t){super(t),this.queuedMutations=[],this.seenRooms=new Map,this.lastUpdates=new Map,this.deserializer=new V}async read(t){var e,i;const s={modelId:this.getViewId()},o=await this.query(C.GetRoomBounds,s,t);return(null===(i=null===(e=null==o?void 0:o.data)||void 0===e?void 0:e.model)||void 0===i?void 0:i.floors)?this.deserializer.deserialize(o.data.model):null}async readClassifications(t){var e;return((null===(e=(await this.query(C.GetRoomClassifications,{},t)).data)||void 0===e?void 0:e.roomClassifications)||[]).reduce(((t,e)=>(e&&(t[e.id]=e),t)),{})}setReadOnly(t){this.config.readonly=t}queueAddNode(t){this.queuedMutations.push(`addBoundaryVertex(modelId: $modelId, id: "${t.id}", vertex: ${this.vertexDetailsFromNode(t)}) { id }`)}queueUpdateNode(t){this.updateEntity("node",t.id,`patchBoundaryVertex(modelId: $modelId, id: "${t.id}", vertex: ${this.vertexDetailsFromNode(t)}) { id }`)}vertexDetailsFromNode(t){return`{\n      floorId: "${t.floorId}",\n      position: { x: ${t.x} y: ${-t.z} }\n      ${this.layerId(t.layerId)}\n    }`}queueRemoveNode(t){this.queueDeleteRoomsAndBoundaryData("node",t.id,t.layerId)}queueAddWall(t){this.queuedMutations.push(`addBoundaryEdge(modelId: $modelId, id: "${t.id}", edge: ${this.edgeDetailsFromWall(t)}) { id }`)}queueUpdateWall(t){this.updateEntity("wall",t.id,`patchBoundaryEdge(modelId: $modelId, id: "${t.id}" edge: ${this.edgeDetailsFromWall(t)}) { id }`)}edgeDetailsFromWall(t){return`\n    {\n      floorId: "${t.floorId}" \n      vertices: ["${t.from.id}", "${t.to.id}"]\n      thickness: ${t.width} \n      units: ${r.nL.METRIC} \n      centerLineBias: ${t.bias}\n      type: ${t.type===R.d.SOLID?r.Pb.WALL:r.Pb.INVISIBLE}\n      ${this.layerId(t.layerId)}\n    }\n    `}queueRemoveWall(t){this.queueDeleteRoomsAndBoundaryData("wall",t.id,t.layerId)}queueAddOpening(t){this.queuedMutations.push(`addEdgeOpenings(modelId: $modelId, id: "${t.wallId}", openings: [${this.openingDetailsFromOpening(t)}]) { id }`)}queueUpdateOpening(t){this.updateEntity("opening",t.id,`patchEdgeOpening(modelId: $modelId, id: "${t.wallId}", opening: ${this.openingDetailsFromOpening(t)}) { id }`)}openingDetailsFromOpening(t){return`\n    {\n      id: "${t.id}" \n      relativeCenter: ${t.relativePos} \n      type: ${t.type} \n      width: ${t.width} \n      ${this.layerId(t.layerId)}\n      height: 0.1, \n      lowerElevation: 0.1\n    }\n    `}queueRemoveOpening(t){this.queuedMutations.push(`removeEdgeOpenings(\n        modelId: $modelId\n        id: "${t.wallId}"\n        openings: ["${t.id}"]\n        ${this.layerId(t.layerId)}\n      )`),this.clearEntityUpdate("opening",t.id)}queueAddRoom(t){this.queuedMutations.push(`addRoom(\n        modelId: $modelId,\n        id: "${t.id}",\n        room: ${this.getRoomDetailsFromRoom(t)}\n      ) { id }`)}queueUpdateRoom(t){const e=this.seenRooms.get(t.id);e&&e!==t&&this.clearEntityUpdate("room",t.id),this.seenRooms.set(t.id,t),this.updateEntity("room",t.id,`patchRoom(\n        modelId: $modelId,\n        id: "${t.id}",\n        room: ${this.getRoomDetailsFromRoom(t)}\n      ) { id }`)}getRoomDetailsFromRoom(t){return`\n    {\n      floorId: "${t.floorId}"\n      label: "${this.escapeUserString(t.name)}"\n      classifications: [${t.roomTypeIds.map((t=>`"${t}"`))}],\n      ${this.layerId(t.layerId)}\n      boundary: {\n        edges: [${Array.from(t.walls.values()).map((t=>`"${t.id}"`))}],\n        lowerElevation: 0.5,\n        height: 3,\n        units: ${r.nL.METRIC}\n      }\n      dimensionEstimates: {\n        room: "${t.id}",\n        area: ${Number.isNaN(t.area)?null:t.area},\n        areaIndoor: ${Number.isNaN(t.area)?null:t.area},\n        depth: ${Number.isNaN(t.length)?null:t.length}\n        width: ${Number.isNaN(t.width)?null:t.width}\n        units: ${r.nL.METRIC}\n      }\n    }\n    `}queueRemoveRoom(t){this.seenRooms.delete(t.id),this.queueDeleteRoomsAndBoundaryData("room",t.id,t.layerId)}queueRemoveLegacyRooms(t){const e=t.map((t=>`"${t}"`));this.queuedMutations.push(`deleteRoomsAndBoundaryData(\n      modelId: $modelId,\n      selectedData: {\n        ids: [${e.join(",")}],\n        type: ${r.TS.ROOM}\n      }\n    )`)}queueUpdateRoomAssociations(t){if(0===t.length)return;this.queuedMutations.push(`bulkPatchRoomData(\n        modelId: $modelId,\n        updatedRoomAssociations: [${t.map((t=>(t=>`{ ${Object.keys(t).map((e=>`${e}: ${JSON.stringify(t[e])}`)).join(",")} }`)(t)))}]\n      )`)}async submitQueuedMutations(){if(0===this.queuedMutations.length)return;const t=N.gql`
      mutation updateRoomBoundaries($modelId: ID!) {
        ${this.queuedMutations.map(((t,e)=>`op${e}: ${t}`)).join("\n")}
      }
    `;this.queuedMutations.length=0;for(const t of this.lastUpdates.values())t.clear();L.debug((0,T.S)(t)),await this.mutate(t,{modelId:this.getViewId()}),L.debug("mutation successful")}clearQueuedMutations(){this.queuedMutations.length=0;for(const t of this.lastUpdates.values())t.clear()}updateEntity(t,e,i){const s=this.lastUpdates.get(t)||new Map;this.lastUpdates.set(t,s);const o=s.get(e);void 0!==o?this.queuedMutations[o]=i:(this.queuedMutations.push(i),s.set(e,this.queuedMutations.length-1))}clearEntityUpdate(t,e){const i=this.lastUpdates.get(t);i&&i.delete(e)}queueDeleteRoomsAndBoundaryData(t,e,i){let s=r.TS.BOUNDARYVERTEX;switch(t){case"room":s=r.TS.ROOM;break;case"wall":s=r.TS.BOUNDARYEDGE}this.queuedMutations.push(`deleteRoomsAndBoundaryData(\n        modelId: $modelId,\n        selectedData: {\n          ids: ["${e}"],\n          type: ${s},\n          ${this.layerId(i)}\n        }\n      )`),this.clearEntityUpdate(t,e)}layerId(t){return t!==p.gi?`layerId: "${t}"`:""}escapeUserString(t){return t.replace(/\\/g,"\\\\").replace(/"/g,'\\"')}}var x=i(80008),F=i(85679),k=i(39564),B=i(92294),W=i(59512),H=i(53954),_=i(39693),U=i(96776),z=i(75668),G=i(28269),j=i(20241),$=i(635),q=i(79728),Y=i(10374);class Z extends s.Y{constructor(){super(...arguments),this.name="room_bound_data",this.associationSources=[],this.modifiedFloors=new Set,this.afterFinalize=async()=>{if(!this.writeBindings)throw new Error("Not permitted to write room bounds data");try{this.store.queueUpdateRoomAssociations(this.updateRoomAssociations()),await this.store.submitQueuedMutations()}catch(t){this.log.info("Error finalizing room bounds data",t),this.data.clearUndoBuffer();const e=await this.store.read();throw this.writeBindings.cancel(),this.data.load(e||{version:0,floors:{}}),this.data.commit(),this.writeBindings.renew(),t}},this.addRoom=t=>{this.roomData.get(t.id)||this.roomData.add(new j.d({id:t.id,floorId:t.floorId,meshSubgroup:-1})),this.addToModifiedFloors(t),this.data.legacyRoomIds.length&&(this.store.queueRemoveLegacyRooms(this.data.legacyRoomIds),this.data.legacyRoomIds.forEach((t=>this.roomData.remove(t))),this.data.legacyRoomIds.length=0),this.store.queueAddRoom(t)},this.removeRoom=t=>{this.roomData.get(t.id)&&this.roomData.remove(t.id),this.addToModifiedFloors(t),this.store.queueRemoveRoom(t)}}async init(t,e){const[i,s,n]=await Promise.all([e.market.waitForData(d.R),e.market.waitForData(G.Z),e.market.waitForData(u.pu)]);this.roomData=s,this.issueCommand=e.commandBinder.issueCommand;const c=i.getBaseModelView();if(!c)throw new Error("Unable to find view for RoomBound data");this.store=new P({viewId:c.id,context:i.mdsContext,readonly:!0,baseUrl:t.baseUrl});const p=await this.store.read(),f=await this.store.readClassifications();z.Ds.forEach((t=>{const e=t.join(z.Rt);f[e]={id:e,label:t.map((t=>f[t].label)).join(z.X9)}})),this.data=new I.Z(p,f),this.data.clearUndoBuffer(),this.data.resetHistory(),t.readonly||(this.writeBindings=new o.V(this.data.onWallsChanged({onAdded:t=>{this.addToModifiedFloors(t),this.store.queueAddWall(t)},onUpdated:t=>{this.addToModifiedFloors(t),this.store.queueUpdateWall(t)},onRemoved:t=>{this.addToModifiedFloors(t),this.store.queueRemoveWall(t)}}),this.data.onNodesChanged({onAdded:t=>{this.addToModifiedFloors(t),this.store.queueAddNode(t)},onUpdated:t=>{this.addToModifiedFloors(t),this.store.queueUpdateNode(t)},onRemoved:t=>{this.addToModifiedFloors(t),this.store.queueRemoveNode(t)}}),this.data.onRoomsChanged({onAdded:this.addRoom,onUpdated:t=>{this.addToModifiedFloors(t),this.store.queueUpdateRoom(t)},onRemoved:this.removeRoom}),this.data.onOpeningsChanged({onAdded:t=>{this.addToModifiedFloors(t),this.store.queueAddOpening(t)},onUpdated:t=>{this.addToModifiedFloors(t),this.store.queueUpdateOpening(t)},onRemoved:t=>{this.addToModifiedFloors(t),this.store.queueRemoveOpening(t)}}),this.data.afterFinalize((async()=>{await e.commandBinder.issueCommand(new $.VQ({dataTypes:[q.g.ROOM_BOUNDS],onCallback:this.afterFinalize,skipDirtyUpdate:!0}))}))),this.writeBindings.cancel()),await this.updateReadonly(n.application),this.bindings.push(e.subscribe(Y.bS,(t=>this.updateReadonly(t.application)))),await this.registerRoomAssociationSources(e),this.store.clearQueuedMutations(),async function(t,e){const[i,s,n,c,p]=await Promise.all([t.market.waitForData(u.pu),t.market.waitForData(d.R),t.market.waitForData(l.e),t.market.waitForData(w.i),t.getModuleBySymbol(a.y.LOCALE)]);let f=i.application===u.Mx.WORKSHOP;const y=(i,o,a,r=[])=>{const d=[];if(!f&&!n.tryGetProperty(m.hW,!1))return[];for(const a of e.rooms.values()){const r=(0,E.LN)(a.id,p,e);if(i(a.name)||i(r)){const e=c.getFloor(a.floorId);if(!e)throw new Error("Unable to find floor for room while generating search results.");d.push(new b(t.commandBinder,s,n,o,a,r,e.id))}}return d.sort(((t,e)=>t.title.localeCompare(e.title)))},S=t=>{},I=t=>new o.V(e.onChanged(t),n.onPropertyChanged(h.F.UnitType,t)),D={renew:()=>{t.commandBinder.issueCommandWhenBound(new v.c6({id:r.SF.MODELROOM,groupPhraseKey:g.Z.SHOWCASE.ROOMS.SEARCH_GROUP_HEADER,getSimpleMatches:y,registerChangeObserver:I,onSearchActivatedChanged:S,groupOrder:100,groupIcon:"edit-floorplan"}))},cancel:()=>{t.commandBinder.issueCommandWhenBound(new v.Pe(r.SF.MODELROOM))}},C=()=>{f=i.application===u.Mx.WORKSHOP,n.tryGetProperty(m.hW,!1)||f?D.renew():D.cancel()},O=i.onPropertyChanged("application",C),A=n.onPropertyChanged(m.hW,C);return C(),new o.V(D,O,A)}(e,this.data).then((t=>this.bindings.push(t))),e.market.register(this,I.Z,this.data)}dispose(t){super.dispose(t),this.writeBindings&&this.writeBindings.cancel()}async updateReadonly(t){const e=t===u.Mx.SHOWCASE;this.store.setReadOnly(e),this.writeBindings&&(e?this.writeBindings.cancel():(this.writeBindings.renew(),this.data.defaultLayerId=await this.issueCommand(new x.fj)))}addToModifiedFloors(t){this.modifiedFloors.add(t.floorId)}updateRoomAssociations(){const t=new Map;for(const e of this.associationSources)for(const i of e.getPositionId()){if(!i.floorId||!this.modifiedFloors.has(i.floorId))continue;const s=this.data.findRoomIdForPosition(i.position,i.floorId,i.roomId);if(s!=i.roomId){const o=t.get(s)||(s?{roomId:s}:{resetRoom:!0}),a=o[e.type]||[];a.push(i.id),o[e.type]=a,t.set(s,o),e.updateRoomForId(i.id,s)}}return this.modifiedFloors.clear(),Array.from(t.values())}async registerRoomAssociationSources(t){const e=await t.market.waitForData(l.e),i=await t.market.waitForData(F.n);if(this.associationSources.push({type:"mattertags",getPositionId:function*(){for(const t of i)yield{id:t.sid,roomId:t.roomId,floorId:t.floorId,position:t.anchorPosition}},updateRoomForId:(t,e)=>{const s=i.getTag(t);if(!s)throw new Error("Invalid tag id!");s.roomId=e||void 0}}),e.tryGetProperty(_.Mp,!1)){const e=await t.market.waitForData(k.t);this.associationSources.push({type:"notes",getPositionId:function*(){for(const t of e.collection.values)yield{id:t.id,roomId:t.roomId,floorId:t.floorId,position:t.anchorPosition}},updateRoomForId:(t,i)=>{const s=e.getNote(t);if(!s)throw new Error("Invalid note id!");s.roomId=i||void 0}})}const s=await t.market.waitForData(B.X);if(this.associationSources.push({type:"measurements",getPositionId:function*(){for(const t of s.groups())yield{id:t.info.sid,roomId:t.info.roomId,floorId:t.info.floorId,position:t.get(0)}},updateRoomForId:(t,e)=>{const i=s.getGroupInfoBySid(t);if(!i)throw new Error("Invalid measurement group id");i.info.roomId=e||void 0}}),e.tryGetProperty(U.QA,!1)){const e=await t.market.waitForData(W.h);this.associationSources.push({type:"objectAnnotations",getPositionId:function*(){for(const t of e.collection.values)yield{id:t.id,roomId:t.roomId,floorId:t.floorId,position:t.position}},updateRoomForId:(t,i)=>{const s=e.getObjectTag(t);if(!s)throw new Error("Invalid object detection id!");s.roomId=i||void 0}})}const o=await t.market.waitForData(H.Z);this.associationSources.push({type:"locations",getPositionId:function*(){for(const t of o.sweeps())yield{id:t.id,roomId:t.roomId||void 0,floorId:t.floorId||void 0,position:t.position}},updateRoomForId:(t,e)=>{const i=o.getSweep(t);if(!i)throw new Error("Invalid sweep id!");i.roomId=e||null}})}}const X=Z},66957:(t,e,i)=>{"use strict";i.d(e,{RE:()=>s,oE:()=>l,sO:()=>o});var s,o,a=i(34956),n=i(16747),r=i(80978),d=i(10513);!function(t){t[t.WALLS=0]="WALLS",t[t.DOORS=1]="DOORS",t[t.OPENINGS=2]="OPENINGS"}(s||(s={})),function(t){t[t.MOVE=0]="MOVE",t[t.START=1]="START",t[t.END=2]="END"}(o||(o={}));class l extends d.M.State{constructor(){super(...arguments),this.addType=s.WALLS,this.wallType=n.d.SOLID,this.wallOpeningType=r.u.DOOR,this.openingEditState=o.MOVE,this.cursor=a.C.ROOMBOUNDS_DEFAULT}}},65298:(t,e,i)=>{"use strict";i.d(e,{M:()=>d});var s=i(85893),o=i(66102),a=i(38399),n=i(46391),r=i(56064);function d({room:t}){const e=(0,o.b)(),i=(0,r.O)(),d=e.t(a.Z.SHOWCASE.ROOMS.ROOM_INFORMATION),l=e.t(a.Z.SHOWCASE.ROOMS.ROOM_AREA),h=e.t(a.Z.SHOWCASE.ROOMS.ROOM_DIMENSIONS),c=e.t(a.Z.SHOWCASE.ROOMS.ROOM_PERIMETER),u=i===n.M.IMPERIAL?"sq ft":"sq m",m=e.t(a.Z.SHOWCASE.ROOMS.QUANTITY_IN_UNITS,{units:u,quantity:t.getArea(i)}),p=t.getMeasurementText(i)||"n/a",g=i===n.M.IMPERIAL?"ft":"m",v=e.t(a.Z.SHOWCASE.ROOMS.QUANTITY_IN_UNITS,{units:g,quantity:t.getPerimeter(i)});return(0,s.jsxs)("div",Object.assign({className:"room-size-info"},{children:[(0,s.jsx)("div",Object.assign({className:"room-info-title"},{children:d})),(0,s.jsxs)("div",Object.assign({className:"area-info"},{children:[(0,s.jsxs)("div",Object.assign({className:"area-info-detail"},{children:[(0,s.jsx)("div",Object.assign({className:"p5"},{children:l})),(0,s.jsx)("div",Object.assign({className:"p3"},{children:m}))]})),(0,s.jsxs)("div",Object.assign({className:"area-info-detail"},{children:[(0,s.jsx)("div",Object.assign({className:"p5"},{children:h})),(0,s.jsx)("div",Object.assign({className:"p3"},{children:p}))]})),(0,s.jsxs)("div",Object.assign({className:"area-info-detail"},{children:[(0,s.jsx)("div",Object.assign({className:"p5"},{children:c})),(0,s.jsx)("div",Object.assign({className:"p3"},{children:v}))]}))]}))]}))}},16284:(t,e,i)=>{"use strict";i.d(e,{J1:()=>p,KO:()=>m,NY:()=>u,bN:()=>c,jE:()=>g,ji:()=>v});var s=i(67294);if(984==i.j)var o=i(10513);if(984==i.j)var a=i(45755);var n=i(38613);if(984==i.j)var r=i(57452);if(984==i.j)var d=i(66957);if(984==i.j)var l=i(16747);var h=i(60119);function c(){const t=(0,h.d)();return(null==t?void 0:t.editorState)||null}function u(){const t=c();return(0,n.h)(t,"toolState",o.M.ToolState.CLOSED)}function m(){const t=c();return(0,n.h)(t,"selected",null)}function p(){const t=c();return(0,n.h)(t,"addType",d.RE.WALLS)}function g(){const t=c();return(0,n.h)(t||null,"wallType",l.d.SOLID)}function v(){const t=(0,a.m)(r.Z),[e,i]=(0,s.useState)(t?t.availableUndos():0);return(0,s.useEffect)((()=>{if(!t)return()=>{};const e=t.onChanged((()=>i(t.availableUndos())));return i(t.availableUndos()),()=>e.cancel()}),[t]),e}},9074:(t,e,i)=>{"use strict";i.d(e,{_:()=>a});var s=i(93405),o=i(32683);function a(){const t=(0,s.F)();return t&&t instanceof o.J?t:null}},60119:(t,e,i)=>{"use strict";i.d(e,{d:()=>a});var s=i(45755),o=i(18544);const a=(0,s.u)(o.e)},93405:(t,e,i)=>{"use strict";i.d(e,{F:()=>a});var s=i(1358),o=i(16284);function a(){const t=(0,s.S)(),e=(0,o.KO)();return e&&t?t.getEntity(e):null}},28653:(t,e,i)=>{"use strict";i.r(e),i.d(e,{default:()=>ui});var s=i(69170),o=i(97542),a=i(34029),n=i(60975),r=i(76631),d=i(91380),l=i(50892),h=i(89549),c=i(59625),u=i(71776),m=i(38987),p=i(34956),g=i(39693),v=i(43736),f=i(92001),w=i(65019),y=i(41326),S=i(66917),E=i(10513),b=i(57452),I=i(47309),D=i(38127),C=i(90304),O=i(16747),A=i(2482),M=i(55248),V=i(81396),R=i(59370),N=i(2569);var T;!function(t){t[t.NONE=0]="NONE",t[t.LINE=1]="LINE",t[t.POINT=2]="POINT"}(T||(T={}));const L=(()=>{const t=new V.Vector2,e={target:new V.Vector3,closestLine:new V.Line3,orthoLine:new V.Line3,targetType:T.NONE};return(i,s,o,a)=>{e.target.copy(a),e.targetType=T.NONE;let n=Number.MIN_VALUE;const r=P(i,o);for(const t of r){const{dist:i,weight:o,closestPt:r}=F(t,a,s);i<15&&o>n&&(n=o,e.target.copy(r),e.closestLine.copy(t),e.targetType=T.LINE)}if(e.targetType===T.LINE){let n=Number.MIN_VALUE;const r=P(i,o);for(const i of r)if(k(i,e.closestLine)){const{dist:o,weight:r}=F(i,a,s);if(o<7.5&&r>n){(0,N.cB)(i.start.x,i.start.z,i.end.x,i.end.z,e.closestLine.start.x,e.closestLine.start.z,e.closestLine.end.x,e.closestLine.end.z,t)&&(n=r,e.target.set(t.x,0,t.y),e.orthoLine.copy(i),e.targetType=T.POINT)}}}return e}})(),P=(()=>{const t=new V.Line3(new V.Vector3,new V.Vector3),e=new V.Vector3,i=new V.Vector3,s=new V.Vector3,o=new V.Vector3(0,1,0);return function*(a,n){const r=a.getWallsForNode(n),d=a.getWallsForFloor(n.floorId);if(d)for(const a of d)if(!r.has(a)){const n=a.from.getVec3(e),r=a.to.getVec3(i);t.set(n,r),yield t,s.subVectors(r,n).normalize(),s.applyAxisAngle(o,Math.PI/2);const d=i.addVectors(n,s);t.set(n,d),yield t;const l=a.to.getVec3(e),h=i.addVectors(l,s);t.set(l,h),yield t}}})(),x=(()=>{const t=new V.Vector2,e=new V.Vector2,i=new V.Vector3;return(s,o,a)=>{const n=(0,R.q9)(s,o,t,i).screenPosition,r=(0,R.q9)(s,a,e,i).screenPosition;return n.distanceTo(r)}})(),F=(()=>{const t={dist:0,weight:0,closestPt:new V.Vector3};return(e,i,s)=>{const o=e.closestPointToPoint(i,!1,t.closestPt),a=x(s,o,i);t.dist=a;const n=x(s,e.start,o);return t.weight=Math.max(5-.0025*n,0),t}})(),k=(()=>{const t=new V.Vector3,e=new V.Vector3;return(i,s)=>(t.subVectors(i.end,i.start).normalize(),e.subVectors(s.end,s.start).normalize(),Math.abs(t.dot(e))<.1)})();var B=i(32597),W=i(80978),H=i(32683),_=i(66957);const U=(t,e,i,s=!1)=>{const o=new Set;o.add(t.id);const a=e.getNode(t.id),n=e.getWallsForNode(a);for(const t of n){o.add(t.id);const i=t.getOtherNode(a);1===e.getEdgeCountForNode(a)&&1===e.getEdgeCountForNode(i)&&o.add(i.id)}const r=s?t.getVec3():void 0;return i.getCurrentRoomBoundHit(o,r)};class z{constructor(t,e,i,s,o,a){this.editor=t,this.getCursorOrigin=e,this.data=i,this.cameraData=s,this.snappingAxesRenderer=o,this.keyboardState=a,this.readBindings=[],this.writeBindings=[],this.edgeStateOnDragStart={fromOffset:new V.Vector3,toOffset:new V.Vector3,initialGrabPt:new V.Vector3,dragDir:new V.Vector3,fromDirection:new V.Vector3,toDirection:new V.Vector3},this.openingStateOnDragStart={relativeStart:0,relativeEnd:0,wallLine:new V.Line3},this.onMoveStart=({target:t,placeOnly:e})=>{if(t&&e){const e=this.data.getEntity(t);e instanceof O.c?this.onWallMoveStart(e):e instanceof W.E&&this.onWallOpeningMoveStart(e)}},this.mover={onMove:(t,e)=>{const{data:i,editor:s}=this;if(!s.state.currentId)return;const o=s.state.toolState===E.M.ToolState.ADDING?i.getEntity(s.state.toId):i.getEntity(s.state.currentId),a=this.getCursorOrigin();o instanceof A.z?this.onMoveNode(o,a):o instanceof O.c?this.onMoveWall(o,a):o instanceof W.E&&this.onMoveWallOpening(o,a)}},this.mergePointAndStartNewWall=({target:t})=>{const{editor:e}=this;if(e.state.toolState===E.M.ToolState.ADDING&&t){const t=this.getCursorOrigin(),e=new V.Vector3,i=this.checkForNodeOrWallHit(this.editor.state.toId);if(this.data.finalizeHistory(),i)this.editor.discard(),this.editor.select(this.editor.state.toId),this.snappingAxesRenderer.hide();else{const i=this.data.getNode(this.editor.state.toId);this.tryApplySnapping(t,i,e),this.data.moveNode(this.editor.state.toId,e);const{wall:s,toId:o}=this.data.addTrailingEdgeToNode(this.editor.state.wallType,this.editor.state.toId,e,this.data.getLastWallWidth(this.editor.state.wallType));this.editor.add(s),this.editor.state.toId=o}}},this.finalizeMovePt=({target:t})=>{if(t){const e=this.data.getEntity(t);e instanceof A.z?this.checkForNodeOrWallHit(t):e instanceof O.c&&(this.checkForNodeOrWallHit(e.from.id,!1),this.checkForNodeOrWallHit(e.to.id,!1)),this.data.finalizeHistory(),this.snappingAxesRenderer.hide()}},this.killLastWall=({target:t})=>{const{data:e,editor:i}=this;i.state.toolState===E.M.ToolState.ADDING&&(this.clearHighlightedViews(),t&&this.data.undo(),e.finalizeHistory(),this.snappingAxesRenderer.hide())},this.onHoverChange=({target:t,previous:e})=>{if(this.editor.state.toolState===E.M.ToolState.ADDING)return;if(!t)return this.editor.clearAllDims(),this.editor.clearAllHighlights(),void(this.editor.state.selected&&this.setSelectedView(this.editor.state.selected));const i=this.data.getEntity(t);this.hoverView(i)},this.onSelectChange=({target:t})=>{this.editor.state.toolState!==E.M.ToolState.ADDING&&this.clearHighlightedViews(),this.highlightView(t),this.setSelectedView(t)},this.editableEntities=new M.C.EditorEntityAdapter(this.editor),this.editor.setValidator(this)}addEditableEntity(t,e){this.editableEntities.registerEntity(e,this,t)}removeEditableEntity(t){this.editableEntities.unregisterEntity(t)}activate(t){0===this.readBindings.length?this.readBindings.push(this.editor.subscribe(E.M.Events.CurrentChange,this.onSelectChange),this.editor.subscribe(E.M.Events.HoverChange,this.onHoverChange)):this.readBindings.forEach((t=>t.renew())),t||(0===this.writeBindings.length?this.writeBindings.push(this.editor.subscribe(E.M.Events.EditStart,this.onMoveStart),this.editor.subscribe(E.M.Events.AddConfirm,this.mergePointAndStartNewWall),this.editor.subscribe(E.M.Events.EditConfirm,this.finalizeMovePt),this.editor.subscribe(E.M.Events.AddDiscard,this.killLastWall),this.editor.subscribe(E.M.Events.CurrentChange,this.onSelectChange),this.editor.subscribe(E.M.Events.HoverChange,this.onHoverChange)):this.writeBindings.forEach((t=>t.renew())))}deactivate(){this.readBindings.forEach((t=>t.cancel())),this.writeBindings.forEach((t=>t.cancel()))}onWallMoveStart(t){const e=this.getCursorOrigin();t.from.getVec3(this.edgeStateOnDragStart.fromOffset),t.to.getVec3(this.edgeStateOnDragStart.toOffset),this.edgeStateOnDragStart.fromOffset.sub(e),this.edgeStateOnDragStart.toOffset.sub(e),this.edgeStateOnDragStart.initialGrabPt.copy(e),t.getDirection(this.edgeStateOnDragStart.dragDir),this.edgeStateOnDragStart.dragDir.normalize(),this.edgeStateOnDragStart.dragDir.applyAxisAngle(new V.Vector3(0,1,0),Math.PI/2);const i=this.edgeStateOnDragStart.dragDir,s=this.needsWallJoint(t,t.from,i),o=this.needsWallJoint(t,t.to,i);(s||o)&&this.data.addWallJoint(t.id,s?t.from.id:void 0,o?t.to.id:void 0),this.getWallDirection(t,t.from,i,this.edgeStateOnDragStart.fromDirection),this.getWallDirection(t,t.to,i,this.edgeStateOnDragStart.toDirection),i.dot(this.edgeStateOnDragStart.fromDirection)<0&&this.edgeStateOnDragStart.fromDirection.multiplyScalar(-1),i.dot(this.edgeStateOnDragStart.toDirection)<0&&this.edgeStateOnDragStart.toDirection.multiplyScalar(-1)}onWallOpeningMoveStart(t){const e=this.data.getWall(t.wallId),{wallLine:i}=this.openingStateOnDragStart;e.from.getVec3(i.start),e.to.getVec3(i.end);const s=t.width/this.openingStateOnDragStart.wallLine.distance()*.5;this.openingStateOnDragStart.relativeStart=t.relativePos-s,this.openingStateOnDragStart.relativeEnd=t.relativePos+s}onMoveNode(t,e){const i=new V.Vector3,s=this.tryApplySnapping(e,t,i);if(s){const{closestLine:t,orthoLine:e,targetType:i}=s;i===T.LINE||i===T.POINT?i===T.POINT?this.snappingAxesRenderer.showAt(t,e):this.snappingAxesRenderer.showAt(t):this.snappingAxesRenderer.hide()}else this.snappingAxesRenderer.hide();this.data.moveNode(t.id,i)}onMoveWall(t,e){const{initialGrabPt:i,dragDir:s,fromOffset:o,toOffset:a,fromDirection:n,toDirection:r}=this.edgeStateOnDragStart,d=e.clone().sub(i),l=s.dot(d),h=n.clone().multiplyScalar(l),c=i.clone().add(h).add(o),u=r.clone().multiplyScalar(l),m=i.clone().add(u).add(a);this.data.moveWall(t.id,c,m)}onMoveWallOpening(t,e){const{editor:i,openingStateOnDragStart:s}=this,{relativeStart:o,relativeEnd:a,wallLine:n}=s,r=n.closestPointToPointParameter(e,!0);switch(i.state.openingEditState){case _.sO.MOVE:const e=t.width/n.distance()*.5;r+e<1&&r-e>0&&this.data.editWallOpeningDetails(t.id,{relativePos:r});break;case _.sO.START:{const e=(a-r)*n.distance(),i=.5*(r+a);this.data.editWallOpeningDetails(t.id,{relativePos:i,width:e})}break;case _.sO.END:{const e=(r-o)*n.distance(),i=.5*(r+o);this.data.editWallOpeningDetails(t.id,{relativePos:i,width:e})}}}checkForNodeOrWallHit(t,e=!0){const i=this.data.getNode(t),s=U(i,this.data,this.editor,!0);if(s){if(s instanceof A.z)return this.data.mergeNodes(t,s.id),!0;if(s instanceof O.c){const o=new V.Vector3;if(e){const t=this.getCursorOrigin();this.tryApplySnapping(t,i,o)}else i.getVec3(o);return this.data.splitEdgeWithNode(s.id,t,s.getProjection(o)),!0}}return!1}clearHighlightedViews(){this.editor.clearAllHighlights()}hoverView(t){t instanceof H.J&&this.hoverRoom(t)}setSelectedView(t){if(!t)return void this.editor.clearAllDims();const e=this.data.getEntity(t);e instanceof O.c&&this.editor.highlight(e.from.id,e.to.id),e instanceof H.J&&(this.clearHighlightedViews(),this.dimAllRooms(),this.selectRoom(e))}dimAllRooms(){this.editor.clearAllDims();for(const[,t]of this.data.rooms)this.dimRoom(t)}highlightView(t){if(!t)return;const e=this.data.getEntity(t);e instanceof O.c&&this.editor.highlight(t,e.from.id,e.to.id)}selectRoom(t){const e=t.id;this.editor.clearDim(e);for(const e of t.walls)this.editor.clearDim(e.id);for(const e of t.points)this.editor.clearDim(e.id)}hoverRoom(t){const e=t.id;this.editor.clearDim(e);for(const e of t.walls)this.editor.clearDim(e.id);for(const e of t.points)this.editor.clearDim(e.id)}dimRoom(t){const e=t.id;this.editor.dim(e);for(const e of t.walls)this.editor.dim(e.id);for(const e of t.points)this.editor.dim(e.id)}isSnappingDisabled(){return this.keyboardState.isKeyHeld(B.R.ALT)||this.keyboardState.isKeyHeld(B.R.SHIFT)}tryApplySnapping(t,e,i){if(i.copy(t),!this.isSnappingDisabled()){const s=L(this.data,this.cameraData,e,t);return i.copy(s.target),s}return null}getAttachedWall(t,e){const i=this.data.getWallsForNode(e);if(i)for(const e of i)if(e!==t)return e;return null}getWallDirection(t,e,i,s){const o=this.getAttachedWall(t,e);if(!o)return void s.copy(i);o.getDirection(s).normalize().equals(C.fU.ZERO)&&s.copy(i)}needsWallJoint(t,e,i){const s=this.data.getWallsForNode(e);for(const e of s){if(e===t)continue;const s=i.dot(e.getDirection().normalize());if(Math.abs(s)<.8)return!0}return!1}validate(t,e){return!0}}var G,j=i(10374),$=i(35895),q=i(89570),Y=i(37721),Z=i(67678),X=i(80592),K=i(89553),Q=i(23612),J=i(86819),tt=i(82814),et=i(12039),it=i(94046),st=i(96154),ot=i(72996),at=i(97998),nt=i(15462),rt=i(23885),dt=i(12529);!function(t){t[t.BASE=dt.z.roomBounds]="BASE",t[t.OPENING_STENCIL=dt.z.roomBounds+1]="OPENING_STENCIL",t[t.ROOM=dt.z.roomBounds+2]="ROOM",t[t.EDGE=dt.z.roomBounds+3]="EDGE",t[t.HIGHLIGHTED_EDGE=dt.z.roomBounds+4]="HIGHLIGHTED_EDGE",t[t.OPENING_LINES=dt.z.roomBounds+5]="OPENING_LINES",t[t.NODE=dt.z.roomBounds+6]="NODE"}(G||(G={}));var lt=i(89557);const ht=100;class ct extends V.Mesh{constructor(t,e,i,s){super(e,i),this.roomBoundsId=t,this.cameraData=s,this.animation=new lt.z(0),this.prevColorState={opacity:1,innerColor:new V.Color,outerColor:new V.Color},this.pitchFactor=1,this.raycastEnabled=!0,this.opacity=1,this.selectState={active:!1,on:()=>{this.updateMaterial()},off:()=>{this.updateMaterial()}},this.hoverState={active:!1,on:()=>{this.updateMaterial()},off:()=>this.updateMaterial()},this.highlightState={active:!1,on:()=>this.updateMaterial(),off:()=>this.updateMaterial()},this.dimState={active:!1,on:()=>this.updateMaterial(),off:()=>this.updateMaterial()},this.name=t,this.renderOrder=G.BASE}updateMaterial(){let t=this.colors.baseState;this.dimState.active&&(t=this.colors.dimState),this.hoverState.active&&(t=this.colors.hoverState),(this.highlightState.active||this.selectState.active)&&(t=this.colors.selectState);t!==this.targetColorScheme&&(this.targetColorScheme=t)}tickAnimations(t){this.animation.tick(t)}dispose(){}raycast(t,e){const i=[];super.raycast(t,i),i.length>0&&e.push(i[0])}setPitchFactor(t){this.pitchFactor=t,this.raycastEnabled=(0,R.Eb)(this.pitchFactor)}}var ut=i(57216),mt=i.n(ut),pt=i(4014),gt=i.n(pt),vt=i(45313),ft=i.n(vt),wt=i(56413),yt=i.n(wt),St=i(27706),Et=i.n(St),bt=i(73403),It=i.n(bt),Dt=i(78596);const Ct={uniforms:{outlineColor:{type:"v4",value:nt.I.BLACK},baseColor:{type:"v4",value:nt.I.SINE},outlinePct:{type:"f",value:.8},radius:{type:"f",value:Dt.pp},opacity:{type:"f",value:1}},vertexShader:mt(),fragmentShader:gt()},Ot={uniforms:{outlineColor:{type:"v3",value:nt.I.WHITE},color:{type:"v3",value:nt.I.WHITE},lineStart:{type:"v3",value:new V.Vector3},lineEnd:{type:"v3",value:new V.Vector3},width:{type:"f",value:1},selectedWidth:{type:"f",value:.01},opacity:{type:"f",value:1}},vertexShader:ft(),fragmentShader:yt()},At={uniforms:{baseColor:{type:"v4",value:nt.I.WHITE},isDoor:{type:"f",value:1},opacity:{type:"f",value:1}},vertexShader:Et(),fragmentShader:It()};var Mt=i(93411),Vt=i(67944);const Rt={baseState:{opacity:1,innerColor:nt.I.MIRROR,outerColor:nt.I.PORTAL},hoverState:{opacity:1,innerColor:nt.I.MIRROR,outerColor:nt.I.PORTAL},selectState:{opacity:1,innerColor:nt.I.MP_BRAND,outerColor:nt.I.WHITE},dimState:{opacity:1,innerColor:nt.I.MIRROR,outerColor:nt.I.PORTAL}};class Nt extends V.RawShaderMaterial{constructor(){super({fragmentShader:Ct.fragmentShader,vertexShader:Ct.vertexShader,uniforms:V.UniformsUtils.clone(Ct.uniforms),name:"HandleMaterial",transparent:!0,depthTest:!1,extensions:{derivatives:!0}})}}class Tt extends ct{constructor(t,e){const i=new Float32Array([-1,0,-1,1,0,-1,1,0,1,-1,0,1]),s=new V.BufferGeometry;s.setAttribute("position",new V.Float32BufferAttribute(i,3)),s.setIndex([0,2,1,0,3,2]),super(t,s,new Nt,e),this.targetRadius=.3,this.prevRadius=.3,this.renderOrder=G.NODE,this.colors=Rt,this.animation.onChanged((()=>this.onAnimationChange())),this.onBeforeRender=()=>{this.material.uniforms.opacity.value=this.opacity*(1-this.pitchFactor)}}onAnimationChange(){const t=this.prevColorState,e=this.targetColorScheme;this.material.uniforms.outlineColor.value.lerpColors(t.outerColor,e.outerColor,this.animation.value),this.material.uniforms.baseColor.value.lerpColors(t.innerColor,e.innerColor,this.animation.value),this.opacity=(0,Mt.t)(t.opacity,e.opacity,this.animation.value);const i=(0,Mt.t)(this.prevRadius,this.targetRadius,this.animation.value);this.setRadius(i)}setPitchFactor(t){super.setPitchFactor(t),this.visible=this.pitchFactor<1}raycast(t,e){const i=[];if(super.raycast(t,i),i.length>0){const s=i[0].point,o=t.ray.origin.distanceTo(this.position),a=(0,Vt._U)(o,this.cameraData.pose.projection.asThreeMatrix4(),this.cameraData.width),n=Dt.Nh*a;s.distanceTo(this.position)<Dt.pp+n&&e.push(i[0])}}updateMaterial(){this.prevRadius=this.material.uniforms.radius.value,this.targetRadius=Dt.pp+(this.hoverState.active?Dt.XG:0)+(this.selectState.active?Dt.XG:0),super.updateMaterial(),this.prevColorState.innerColor.copy(this.material.uniforms.baseColor.value),this.prevColorState.outerColor.copy(this.material.uniforms.outlineColor.value),this.prevColorState.opacity=this.material.opacity,this.animation.modifyAnimation(0,1,ht,rt.hl)}setRadius(t){this.material.uniforms.radius.value=t}updatePosition(t){this.position.copy(t)}}class Lt extends V.RawShaderMaterial{constructor(){super({fragmentShader:At.fragmentShader,vertexShader:At.vertexShader,uniforms:V.UniformsUtils.clone(At.uniforms),name:"OpeningMaterial",depthTest:!1,transparent:!0,stencilFunc:V.AlwaysStencilFunc,stencilWrite:!1})}}const Pt=new V.BoxGeometry(1,1,1);class xt extends ct{constructor(t,e,i){super(t,Pt.clone(),new Lt,i),this.floorId=e,this.onEdgePositionChanged=(()=>{const t=new V.Vector3;return(e,i,s,o)=>{t.subVectors(i,e),this.scale.set(t.length(),.05,s),this.stencilPrepass&&this.stencilPrepass.scale.set(t.length(),.05,s);const a=Math.atan2(i.x-e.x,i.z-e.z)+Math.PI/2;this.rotation.y=a,this.stencilPrepass&&(this.stencilPrepass.rotation.y=a);const n=t.addVectors(i,e).multiplyScalar(.5);this.position.copy(n),this.stencilPrepass&&this.stencilPrepass.position.copy(n),this.startHandle.position.copy(e),this.endHandle.position.copy(i);const r=o===W.u.DOOR?1:0;this.material.uniforms.isDoor.value=r,this.stencilPrepass&&(this.stencilPrepass.material.uniforms.isDoor.value=r)}})(),this.renderOrder=G.OPENING_LINES,this.startHandle=new Wt(t,i,this),this.endHandle=new Ht(t,i,this),this.animation.onChanged((()=>{this.material.uniforms.baseColor.value.lerpColors(nt.I.WHITE,nt.I.NEPTUNE,this.animation.value)}))}setPitchFactor(t){super.setPitchFactor(t),this.visible=this.pitchFactor<1,this.startHandle.setPitchFactor(t),this.endHandle.setPitchFactor(t),this.stencilPrepass&&this.stencilPrepass.setPitchFactor(t)}updateMaterial(){const t=this.selectState.active||this.hoverState.active||this.highlightState.active;this.animation.modifyAnimation(this.animation.value,t?1:0,ht,rt.hl)}tickAnimations(t){super.tickAnimations(t),this.startHandle.tickAnimations(t),this.endHandle.tickAnimations(t)}}class Ft extends xt{constructor(t,e,i){super(t,e,i),this.floorId=e,this.stencilPrepass=new kt(t,e,i)}}class kt extends xt{constructor(t,e,i){super(t,e,i),this.floorId=e,this.renderOrder=G.OPENING_STENCIL,this.material.colorWrite=!1,this.material.stencilRef=1,this.material.stencilFail=V.ReplaceStencilOp,this.material.stencilZFail=V.ReplaceStencilOp,this.material.stencilZPass=V.ReplaceStencilOp,this.material.stencilFunc=V.AlwaysStencilFunc,this.material.stencilWrite=!0}raycast(t,e){}}class Bt extends Tt{constructor(t,e,i){super(t,e),this.parentOpeningView=i}}class Wt extends Bt{}class Ht extends Bt{}var _t=i(16782),Ut=i(92826),zt=i(49827),Gt=i(69505),jt=i(96139),$t=i(27990);function qt(t,e,i){const s=function(t){return t/180*Math.PI}(e||0);if(!i||0===i[0]&&0===i[1])return Yt(t,s);return Yt(t.map(((t,e)=>t-i[e])),s).map(((t,e)=>t+i[e]))}function Yt(t,e){return[t[0]*Math.cos(e)-t[1]*Math.sin(e),t[0]*Math.sin(e)+t[1]*Math.cos(e)]}function Zt(t){return function(t){const e=t[0],i=t[t.length-1];return e[0]===i[0]&&e[1]===i[1]}(t)?t:[...t,t[0]]}function Xt(t){return Math.sqrt(Math.pow(t[1][0]-t[0][0],2)+Math.pow(t[1][1]-t[0][1],2))}function Kt(t,e,i=0){const s=Xt(e);return function(t,e,i=0){return Math.abs((s=t,o=e[0],a=e[1],(s[0]-a[0])*(o[1]-a[1])-(s[1]-a[1])*(o[0]-a[0])))<=i;var s,o,a}(t,e,i)&&Xt([e[0],t])<=s&&Xt([e[1],t])<=s}function Qt(t,e){const[[i,s],[o,a]]=t,[[n,r],[d,l]]=e;if(i===n&&s===r)return!0;if(o===d&&a===l)return!0;if(Kt(t[0],e)||Kt(t[1],e))return!0;if(Kt(e[0],t)||Kt(e[1],t))return!0;const h=(l-r)*(o-i)-(d-n)*(a-s);if(0===h)return!1;const c=s-r,u=i-n,m=((d-n)*c-(l-r)*u)/h,p=((o-i)*c-(a-s)*u)/h;return m>0&&m<1&&p>0&&p<1}function Jt(t,e){let i=!1;const s=Zt(e);for(let e=0,o=s.length-1;e<o;e++){const o=s[e],a=s[e+1];if(Qt(t,[o,a])||Kt(o,t)&&Kt(a,t)){i=!0;break}}return i}function te(t,e){let i=t[0],s=t[1],o=!1;for(let t=0,a=e.length-1;t<e.length;a=t++){const n=e[t][0],r=e[t][1],d=e[a][0],l=e[a][1];r>s!=l>s&&i<(d-n)*(s-r)/(l-r)+n&&(o=!o)}return o}function ee(t,e){let i=!0;const s=Zt(t);for(let t=0,o=s.length-1;t<o;t++){const o=s[t];if(!te(o,e)){i=!1;break}if(Jt([o,s[t+1]],e)){i=!1;break}}return i}const ie={baseState:{innerColor:nt.I.LENS_GRAY,outerColor:nt.I.WHITE,opacity:0},hoverState:{innerColor:nt.I.NEPTUNE,outerColor:nt.I.WHITE,opacity:.5},selectState:{innerColor:nt.I.NEPTUNE,outerColor:nt.I.WHITE,opacity:0},dimState:{innerColor:nt.I.LENS_GRAY,outerColor:nt.I.WHITE,opacity:.5}};class se extends ct{constructor(t,e,i,s){const o=t.points.map((t=>new V.Vector2(t.x,t.z))),a=new V.ShapeGeometry(new V.Shape(o));a.rotateX(Math.PI/2),a.translate(0,i,0);const n=new V.MeshBasicMaterial({color:nt.I.LENS_GRAY,depthTest:!1,side:V.DoubleSide,transparent:!0,opacity:0,blending:V.CustomBlending,blendEquation:V.AddEquation,blendSrc:V.SrcAlphaFactor,blendDst:V.DstColorFactor});super(t.id,a,n,s),this.renderOrder=G.ROOM,this.add(e),this.label=e,e.opacity=1,this.prevLabelOpacity=1,this.targetLabelOpacity=1,this.room=t,this.calculateMaxLabelSize(),this.updateLabelPosition(t,i),this.colors=ie,this.animation.onChanged((()=>{const t=this.prevColorState;this.material.color.lerpColors(t.innerColor,this.targetColorScheme.innerColor,this.animation.value);const e=(0,Mt.t)(t.opacity,this.targetColorScheme.opacity,this.animation.value);this.opacity=e;const i=(0,Mt.t)(this.prevLabelOpacity,this.targetLabelOpacity,this.animation.value);this.label.opacity=i})),this.onBeforeRender=()=>{this.material.opacity=this.opacity*(1-this.pitchFactor)}}dispose(){this.label.dispose(),super.dispose()}updateGeo(t,e){const i=t.points.map((t=>new V.Vector2(t.x,t.z))),s=new V.ShapeGeometry(new V.Shape(i));s.rotateX(Math.PI/2),s.translate(0,e,0),this.geometry.dispose(),this.geometry=s,this.geometry.computeBoundingBox(),this.calculateMaxLabelSize(),this.updateLabelPosition(t,e),this.updateLabelElipsis()}updateLabelBillboard(){const{position:t,rotation:e,projection:i}=this.cameraData.pose,{height:s}=this.cameraData,o=this.cameraData.isOrtho()?this.cameraData.zoom():1,a=this.cameraData.aspect(),n=(0,N.dS)(64-jt.R.LABEL_SIZE,0,64,.02,.1);this.label.quaternion.copy(e),this.label.scaleBillboard(t,e,i,o,s,a,n),this.updateLabelElipsis()}updateMaterial(){super.updateMaterial(),this.hoverState.active&&(this.targetColorScheme=this.colors.hoverState),this.material.blending=this.hoverState.active?V.CustomBlending:V.NormalBlending;const t=this.material;this.prevColorState.innerColor.copy(t.color),this.prevColorState.opacity=t.opacity;const e=this.dimState.active;this.prevLabelOpacity=this.label.opacity,this.targetLabelOpacity=e?.5:1,this.animation.modifyAnimation(0,1,ht,rt.hl)}updateLabelPosition(t,e){this.label.position.copy(t.getViewCenter().clone().add(new V.Vector3(0,e,0)))}updateText(t,e){this.labelText=t,this.areaText=e,this.updateLabelElipsis()}updateLabelElipsis(){let t=this.areaText,e=this.labelText;if(!t||!e)return;let i=!1;const s=this.cameraData.pose.position.distanceTo(this.room.getViewCenter()),o=(0,Vt._U)(s,this.cameraData.pose.projection.asThreeMatrix4(),this.cameraData.width),a=(new V.Euler).setFromQuaternion(this.cameraData.pose.rotation).z,n=Gt.MN*a,r=this.room.getViewCenter(),d=[r.x,r.z],l=function(t,e,i){let s=[];for(let o=0,a=t.length;o<a;o++)s[o]=qt(t[o],e,i);return s}(this.maxLabelPolygon,n,d);let h=Number.MAX_SAFE_INTEGER,c=Number.MIN_SAFE_INTEGER;l.forEach((([t,e])=>{h=Math.min(h,t),c=Math.max(c,t)}));const u=Math.abs(c-h)/o,m=ee(this.getLabelPolygon(),this.roomPolygon),p=Math.round((u-5)/9);if(!m||p<this.labelText.length){e=this.labelText.substring(0,p-3)+"...",i=!0}i&&(t=""),this.label.text=e+(t.length>0?"\n"+t:"")}calculateMaxLabelSize(){const t=.01,e=this.room.getViewCenter(),i=this.room.points.map((t=>[t.x,t.z]));i.push(i[0]);const s=e.x,o=e.z,a=[];a.push([s-t,o-t]),a.push([s+t,o-t]),a.push([s+t,o+t]),a.push([s-t,o+t]),a.push(a[0]);const n=a;for(;ee(n,i);)n[0][0]-=t,n[1][0]+=t,n[2][0]+=t,n[4][0]-=t;for(n[0][0]+=t,n[1][0]-=t,n[2][0]-=t,n[4][0]+=t;ee(n,i);)n[0][1]-=t,n[1][1]-=t,n[2][1]+=t,n[4][1]+=t;n[0][1]+=t,n[1][1]+=t,n[2][1]-=t,n[4][1]-=t,this.maxLabelPolygon=n,this.roomPolygon=i}getLabelPolygon(){const t=this.cameraData.pose.position.distanceTo(this.room.getViewCenter()),e=(0,Vt._U)(t,this.cameraData.pose.projection.asThreeMatrix4(),this.cameraData.width),i=(0,$t.hJ)(this.labelText.length,0,0),s=this.room.getViewCenter(),o=s.x,a=s.z,n=.5*i.width*e,r=.5*i.height*e,d=new V.Vector3;d.set(o-n,0,a-r),d.applyQuaternion(this.cameraData.pose.rotation);const l=[];return l.push([o-n,a-r]),l.push([o+n,a-r]),l.push([o+n,a+r]),l.push([o-n,a+r]),l.map((t=>(d.set(t[0],0,t[1]),d.applyQuaternion(this.cameraData.pose.rotation),[d.x,0,d.z]))),l.push(l[0]),l}}class oe{constructor(){this.primary=new V.Vector3,this.bevel=new V.Vector3}set(t,e,i){this.primary.set(t,e,i),this.bevel.set(t,e,i)}copy(t,e){this.primary.copy(t),e?this.bevel.copy(e):this.bevel.copy(t)}}const ae=(()=>{const t={fromLeft:new oe,fromRight:new oe,toLeft:new oe,toRight:new oe};return(e,i)=>{de(e,t);const s=i.getWallNeighbors(e,"from"),o=i.getWallNeighbors(e,"to");return s&&(ne(e,s.left,"from","left",t.fromLeft),ne(e,s.right,"from","right",t.fromRight)),o&&(ne(e,o.left,"to","left",t.toLeft),ne(e,o.right,"to","right",t.toRight)),t}})(),ne=(()=>{const t=new V.Vector3,e=new V.Vector3,i=new V.Vector3,s=new V.Vector3,o=new V.Vector3,a=new V.Vector3,n=new V.Vector3,r=new V.Vector2,d=new V.Vector2,l=new V.Vector2,h=new V.Vector3,c=new V.Vector3;return(u,m,p,g,v)=>{const f=u.getDirection(t).normalize(),w=u[p],y="from"===p?-1:1,S=m.getOtherNode(w).getVec3(e).sub(w.getVec3(i)).normalize().multiplyScalar(y),E=f.dot(S);if(Math.acos(E)*Gt.MN<5)return;u.getBiasAdjustmentVec(h),m.getBiasAdjustmentVec(c);const b="left"===g?Math.PI/2:-Math.PI/2,I=f.applyAxisAngle(C.fU.UP,b).multiplyScalar(u.width/2).add(h),D=S.applyAxisAngle(C.fU.UP,b).multiplyScalar(m.width/2).add(c);u.from.getVec3(s).add(I),u.to.getVec3(o).add(I),m.from.getVec3(a).add(D),m.to.getVec3(n).add(D);if((0,N.cB)(s.x,s.z,o.x,o.z,a.x,a.z,n.x,n.z,r)){const t=re(w,u,m,r,l),e=t.x>0&&t.y>0,i=t.x<0&&t.y<0;if(t.x<u.length&&t.y<m.length)if(e)v.set(r.x,0,r.y);else{d.set(w.x+h.x+c.x,w.z+h.z+c.z).distanceTo(r)>1.2*Math.max(u.width,m.width)&&i?le(w,u,m,I,D,v):v.set(r.x,0,r.y)}}}})(),re=(()=>{const t=new V.Vector3,e=new V.Vector3,i=new V.Vector3,s=new V.Vector3;return(o,a,n,r,d)=>{let l=a.getOtherNode(o);return o.getVec3(i),l.getVec3(t).sub(i),l=n.getOtherNode(o),l.getVec3(e).sub(i),s.set(r.x,0,r.y).sub(i),d.set(t.dot(s)/t.length(),e.dot(s)/e.length()),d}})(),de=(()=>{const t=new V.Vector3,e=new V.Vector3,i=new V.Vector3,s=new V.Vector3;return(o,a)=>{const n=o.width;o.getBiasAdjustmentVec(i),o.getNormal(t).multiplyScalar(-n/2).add(i),o.getNormal(e).multiplyScalar(n/2).add(i);const r=o.from.getVec3(s).add(e);a.fromRight.copy(r);const d=o.to.getVec3(s).add(e);a.toRight.copy(d);const l=o.to.getVec3(s).add(t);a.toLeft.copy(l);const h=o.from.getVec3(s).add(t);a.fromLeft.copy(h)}})(),le=(()=>{const t=new V.Vector3,e=new V.Vector3,i=new V.Vector3,s=new V.Vector3,o=new V.Vector3;return(a,n,r,d,l,h)=>{const c=n.getOtherNode(a),u=r.getOtherNode(a);a.getVec3(e),c.getVec3(t).sub(e).normalize().multiplyScalar(-n.width/2),u.getVec3(i).sub(e).normalize().multiplyScalar(-r.width/2),s.copy(e).add(d).add(t),o.copy(e).add(l).add(i),h.copy(s,o)}})();var he,ce=i(10840);!function(t){t[t.PIXELS=0]="PIXELS",t[t.METERS=1]="METERS"}(he||(he={}));class ue extends V.Mesh{constructor(t,e,i){const s=new Float32Array([-9999,-9999,-9999,9999,9999,9999,-9999,-9999,-9999,9999,9999,9999,9999,9999,9999,-9999,-9999,-9999]),o=new Float32Array([1,1,0,0,-1,-1]),a=new Float32Array([0,1,0,1,0,1]),n=new V.BufferGeometry;n.setAttribute("position",new V.Float32BufferAttribute(s,3)),n.setAttribute("offsetDirection",new V.Float32BufferAttribute(o,1)),n.setAttribute("t",new V.Float32BufferAttribute(a,1)),n.setIndex([0,2,1,2,3,1,2,4,3,4,5,3]);let r={},d={};(null==i?void 0:i.dashUnits)===he.METERS&&(r={WORLDSPACE_DASH:!0},d={derivatives:!0});super(n,new V.RawShaderMaterial({uniforms:V.UniformsUtils.clone(ce.T.screenline.uniforms),side:V.FrontSide,vertexShader:ce.T.screenline.vertexShader,fragmentShader:ce.T.screenline.fragmentShader,transparent:!0,depthTest:i.depthTest,depthWrite:i.depthWrite,depthFunc:i.depthFunc,defines:r,extensions:d})),this.updateEndpoints(t,e),this.geometry.computeBoundingBox(),this.geometry.computeBoundingSphere(),this.renderOrder=dt.z.lines,this.onBeforeRender=t=>{t.getSize(this.material.uniforms.screenSize.value)},this.material.uniforms.dashed.value=+i.dashed,this.material.uniforms.dashSize.value=i.dashSize,this.material.uniforms.gapSize.value=i.gapSize,this.material.uniforms.lineWidth.value=i.lineWidth,this.material.uniforms.color.value.copy(i.color),this.material.uniforms.opacity.value=i.opacity}updateEndpoints(t,e){this.material.uniforms.start.value.copy(t),this.material.uniforms.end.value.copy(e)}opacity(t){this.material.uniforms.opacity.value=t}color(t){this.material.uniforms.color.value.copy(t)}}var me=i(72119);const pe={baseState:{innerColor:nt.I.WHITE,outerColor:nt.I.WHITE,opacity:1},hoverState:{innerColor:nt.I.WHITE,outerColor:nt.I.NEPTUNE,opacity:1},selectState:{innerColor:nt.I.WHITE,outerColor:nt.I.NEPTUNE,opacity:1},dimState:{innerColor:nt.I.WHITE,outerColor:nt.I.WHITE,opacity:.5}};class ge extends ct{constructor(t,e,i){const s=new Float32Array([0,0,0,1,0,0,1,0,1,0,0,1,-1,0,1,-1,0,0,1,0,2,-1,0,2,-1,0,-1,1,0,-1]),o=new V.BufferGeometry;o.setAttribute("position",new V.Float32BufferAttribute(s,3)),o.setIndex([0,1,2,0,2,3,0,3,4,0,4,5,3,2,6,3,7,4,0,9,1,0,5,8]);super(t,o,new V.RawShaderMaterial({uniforms:V.UniformsUtils.clone(Ot.uniforms),vertexShader:Ot.vertexShader,fragmentShader:Ot.fragmentShader,transparent:!0,depthTest:!1,stencilRef:1,stencilFail:V.KeepStencilOp,stencilZFail:V.KeepStencilOp,stencilZPass:V.KeepStencilOp,stencilFunc:V.GreaterStencilFunc,stencilWrite:!0,extensions:{derivatives:!0}}),e),this.label=i,this.line3=new V.Line3(new V.Vector3,new V.Vector3),this.widthCache=.1,this.updateMaterial=()=>{super.updateMaterial();const t=this.material.uniforms;this.prevColorState.innerColor.copy(t.color.value),this.prevColorState.outerColor.copy(t.outlineColor.value),this.prevColorState.opacity=t.opacity.value;const e=this.selectState.active||this.highlightState.active,i=this.hoverState.active;this.renderOrder=e||i?G.HIGHLIGHTED_EDGE:G.EDGE,this.animation.modifyAnimation(0,1,ht,rt.hl)},this.raycast=(()=>{const t=new V.Vector3,e=new V.Vector2,i=new V.Vector2;return(s,o)=>{const a=this.line3.closestPointToPoint(s.ray.origin,!0,t);e.set(a.x,a.z),i.set(s.ray.origin.x,s.ray.origin.z);const n=e.distanceTo(i),r=s.ray.origin.distanceTo(this.line3.start),d=(0,Vt._U)(r,this.cameraData.pose.projection.asThreeMatrix4(),this.cameraData.width),l=Dt.Nh*d;n<.5*this.widthCache+l&&o.push({distance:r,object:this,point:a.clone()})}})(),this.onEdgePositionChanged=(()=>{const t=new V.Vector3,e=new V.Vector3,i=new V.Vector3,s=new V.Vector3,o=new V.Vector3,a=new V.Vector3,n=new V.Vector3;return(r,d)=>{var l;const h=r.getWall(this.roomBoundsId),c=(null===(l=d.floors.getFloor(h.floorId))||void 0===l?void 0:l.bottom)||0;h.from.getVec3(t),h.to.getVec3(e);const u=this.geometry.getAttribute("position");h.getBiasAdjustmentVec(n),i.set(t.x,t.y+c,t.z),s.set(e.x,e.y+c,e.z),o.addVectors(i,n),a.addVectors(s,n),this.line3.start.copy(o),this.line3.end.copy(a),this.material.uniforms.lineStart.value.copy(o),this.material.uniforms.lineEnd.value.copy(a),this.material.uniforms.width.value=h.width,this.widthCache=h.width,u.setXYZ(0,i.x,i.y,i.z),u.setXYZ(3,s.x,s.y,s.z);const{fromLeft:m,fromRight:p,toLeft:g,toRight:v}=ae(h,r);u.setXYZ(1,p.primary.x,p.primary.y+c,p.primary.z),u.setXYZ(2,v.primary.x,v.primary.y+c,v.primary.z),u.setXYZ(4,g.primary.x,g.primary.y+c,g.primary.z),u.setXYZ(5,m.primary.x,m.primary.y+c,m.primary.z),u.setXYZ(9,p.bevel.x,p.bevel.y+c,p.bevel.z),u.setXYZ(6,v.bevel.x,v.bevel.y+c,v.bevel.z),u.setXYZ(7,g.bevel.x,g.bevel.y+c,g.bevel.z),u.setXYZ(8,m.bevel.x,m.bevel.y+c,m.bevel.z),u.needsUpdate=!0,this.perspectiveLine.updateEndpoints(i,s),this.occlusionLine.updateEndpoints(i,s),this.geometry.computeBoundingBox(),this.geometry.computeBoundingSphere()}})(),this.getLinePositions=(()=>{const t=new V.Vector3,e=new V.Vector3,i=new V.Vector3,s=new V.Vector3,o=new V.Vector3;return()=>{const a=(0,$t.Ko)(t,e,this.cameraData),n=(0,$t.hJ)(this.label.text.length),r=a.pixelDistance>n.width&&this.labelVisible;this.labelOpacityAnimation.modifyAnimation(this.labelOpacityAnimation.value,r?1:0,150);const d=this.cameraData.isOrtho(),l=d?Math.abs(this.label.position.y-this.cameraData.pose.position.y):this.cameraData.pose.position.distanceTo(this.label.position);t.copy(this.material.uniforms.lineStart.value),e.copy(this.material.uniforms.lineEnd.value),i.addVectors(t,e).multiplyScalar(.5),d?(o.subVectors(e,t),o.applyAxisAngle(C.fU.UP,.5*Math.PI).normalize()):o.copy(C.fU.UP);const h=(0,Vt._U)(l,this.cameraData.pose.projection.asThreeMatrix4(),this.cameraData.width),c=d?2:10;return s.copy(i),s.addScaledVector(o,.5*this.widthCache+.5*this.label.unscaledHeight*this.label.scale.x+h*c),{start:t,end:e,center:i,labelPosition:s,lineRotation:a.rotation}}})(),this.renderOrder=G.EDGE,this.geometry.computeBoundingBox(),this.geometry.computeBoundingSphere();const a={dashed:!1,dashSize:1,gapSize:1,lineWidth:1,color:nt.I.WHITE,dashUnits:he.METERS,depthWrite:!1,depthTest:!0,depthFunc:V.LessDepth,opacity:1},n={dashed:!0,dashSize:.08,gapSize:.04,lineWidth:1,color:nt.I.WHITE,dashUnits:he.METERS,depthWrite:!1,depthTest:!0,depthFunc:V.GreaterDepth,opacity:1};this.occlusionLine=new ue(new V.Vector3,new V.Vector3,n),this.perspectiveLine=new ue(new V.Vector3,new V.Vector3,a),this.add(this.perspectiveLine),this.add(this.occlusionLine),this.colors=pe,this.material.uniforms.selectedWidth.value=.03;const r=nt.I.WHITE.clone();this.animation.onChanged((()=>{const t=this.prevColorState,e=this.targetColorScheme;this.material.uniforms.outlineColor.value.lerpColors(t.outerColor,e.outerColor,this.animation.value);this.material.uniforms.color.value.lerpColors(t.innerColor,e.innerColor,this.animation.value);const i=(0,Mt.t)(t.opacity,e.opacity,this.animation.value);this.opacity=i,r.copy(nt.I.WHITE).multiplyScalar(this.opacity),this.occlusionLine.color(r),this.perspectiveLine.color(r)})),this.labelOpacityAnimation=new lt.z(0),this.onBeforeRender=()=>{this.material.depthTest=1===this.pitchFactor,this.material.uniforms.opacity.value=(1-this.pitchFactor)*this.opacity,this.occlusionLine.opacity(this.pitchFactor),this.perspectiveLine.opacity(this.pitchFactor),this.updateLabelBillboard()}}tickAnimations(t){super.tickAnimations(t),this.labelOpacityAnimation.tick(t)}updateLabel(t){const{start:e,end:i}=this.getLinePositions(),s=e.distanceTo(i),o=(0,$t.up)(s,t);this.label.text=o}updateLabelBillboard(){const{labelPosition:t,lineRotation:e}=this.getLinePositions(),{label:i}=this;i.opacity=this.labelOpacityAnimation.value,i.setPosition(t),i.setOrientation(this.cameraData.pose.rotation,e);const{position:s,projection:o}=this.cameraData.pose,a=this.cameraData.aspect(),{height:n}=this.cameraData,r=this.cameraData.zoom(),d=(0,Vt.mY)(o,s,i.position,n,me.Hn.SCALE),l=(0,Vt.Pp)(o)?0:((0,zt.uZ)(a,1,2.5)+r)*me.Hn.SCALE_ASPECT,h=1+me.Hn.SCALE_NDC-l,c=Math.max(Math.min(1/d*h,3),.001);i.scaleFactor=c}setLabelVisible(t){t!==this.labelVisible&&(this.labelVisible=t)}}const ve=new at.Z("room-bounds-editor"),fe=t=>{const e=ve.debug;return(0,$.k1)((()=>e(`${t}.renew()`)),(()=>e(`${t}.cancel()`)),!1)};class we extends E.M.DragAndDrop{constructor(t,e,i,s,o,a,n,r,d){super(new _.oE),this.getCursorOrigin=t,this.input=e,this.raycaster=i,this.messageBus=s,this.data=o,this.floorsViewData=a,this.cameraPoseData=n,this.commandBinder=r,this.allViewsComparator=ot.s.is((t=>this.state.toolState===E.M.ToolState.READ_ONLY||this.state.toolState===E.M.ToolState.SELECTED_READ_ONLY?t instanceof se:t instanceof ct)),this.draggableViewsComparator=ot.s.is((t=>(t instanceof ge||t instanceof Ft||t instanceof Tt)&&!!t.raycastEnabled)),this.addPoint=t=>{if(t.button!==_t.M.PRIMARY)return;const e=this.getCurrentRoomBoundHit(),i=this.getCursorOrigin(),s={x:i.x,z:i.z};switch(this.data.finalizeHistory(),this.state.addType){case _.RE.WALLS:{const{wallType:t}=this.state,o=this.data.getLastWallWidth(t);if(e)if(e instanceof A.z){const{wall:i,toId:a}=this.data.addTrailingEdgeToNode(t,e.id,s,o);this.state.toId=a,this.add(i)}else if(e instanceof O.c){const a=e.getProjection(i),{newTrailingWall:n,newNodeToId:r}=this.data.addTrailingEdgeToEdge(t,e.id,a,s,o);this.add(n.id),this.state.toId=r}else{if(!(e instanceof H.J||e instanceof W.E))throw new Error("Trying to add a new Edge on an invalid object type");this.addFirstFloatingPoint(s)}else this.addFirstFloatingPoint(s)}break;case _.RE.DOORS:case _.RE.OPENINGS:{const t=this.state.tempHoverPreviewEntityId;t&&(this.data.finalizeHistory(),setTimeout((()=>this.select(t)),1),this.state.tempHoverPreviewEntityId=null)}}},this.moveTemporaryPreview=()=>{const t=new V.Line3;return(()=>{const e=this.state.tempHoverPreviewEntityId;if(e){if(this.state.addType!==_.RE.DOORS&&this.state.addType!==_.RE.OPENINGS)return void this.deleteTemporaryPreview();const i=this.data.getOpening(e),s=this.data.getWall(i.wallId).getLine3(t),o=this.getCursorOrigin(),a=s.closestPointToPointParameter(o,!0),n=i.width/s.distance()*.5;a+n<1&&a-n>0&&this.data.editWallOpeningDetails(e,{relativePos:a})}})()},this.mergePointAndStartNewWall=t=>{this.tryCommit()},this.updateCursor=(t=!1)=>{const{toolState:e,toId:i}=this.state;let s=p.C.ROOMBOUNDS_DEFAULT;if((e===E.M.ToolState.ADDING||e===E.M.ToolState.WAIT_FOR_ADD)&&(s=p.C.ROOMBOUNDS_PLACE_NODE,i))try{const t=this.data.getNode(i),e=U(t,this.data,this);e&&(e instanceof O.c||e instanceof A.z)&&(s=p.C.ROOMBOUNDS_FINISH_ROOM)}catch(t){}this.state.dragging&&(s=p.C.ROOMBOUNDS_MOVING),this.state.cursor!==s&&(this.state.cursor=s,this.state.commit())};const l=[this.subscribe(E.M.Events.StateChange,(async({target:t})=>{this.inputStates||(this.inputStates=this.bindInputToEditorStates(d)),this.inputStates.cancel(),this.inputStates.renew(t)})),this.subscribe(E.M.Events.CurrentChange,(()=>this.updateCursor())),this.subscribe(E.M.Events.ValidChange,(()=>this.updateCursor())),this.subscribe(E.M.Events.HoverChange,(()=>this.updateCursor())),this.input.registerHandler(Z.mE,(()=>this.updateCursor()))];l.forEach((t=>t.cancel())),this.bindings.push(...l)}exit(){super.exit(),this.inputStates&&this.inputStates.cancel()}bindInputToEditorStates(t){const e=new q.V(this.input.registerPriorityHandler(X._t,tt.S,(()=>!0)),this.input.registerPriorityHandler(X._t,it.i,(()=>!0)));e.cancel();const i=()=>this.setEnabled(!1),s=()=>this.setEnabled(!0),o=()=>this.exit(),a=new q.V((0,$.k1)((()=>this.messageBus.subscribe(st.oR,i)),(()=>this.messageBus.unsubscribe(st.oR,i)),!1),(0,$.k1)((()=>this.messageBus.subscribe(st.NR,s)),(()=>this.messageBus.unsubscribe(st.NR,s)),!1),(0,$.k1)((()=>this.messageBus.subscribe(j.bS,o)),(()=>this.messageBus.unsubscribe(j.bS,o)),!1),this.cameraPoseData.onChanged((()=>{this.state.toolState!==E.M.ToolState.CLOSED&&this.setEnabled(this.cameraPoseData.pitchFactor()<1)}))),n=new q.V(this.input.registerUnfilteredHandler(K.e,(t=>{t.key===B.R.ESCAPE&&this.discard(),t.key===B.R.RETURN&&this.tryCommit()})));n.cancel();const r=new Ut.r(t,"keydown",(t=>{"KeyZ"===t.code&&(t.ctrlKey||t.metaKey)&&this.commandBinder.issueCommand(new D.o3)}));r.cancel();const d=new q.V(this.input.registerMeshHandler(Q.z,this.allViewsComparator,((t,e)=>this.hover(e.roomBoundsId,e))),this.input.registerMeshHandler(Q.A,this.allViewsComparator,(()=>this.unhover())));d.cancel();const l=this.input.registerUnfilteredHandler(K.e,(t=>{t.key===B.R.ESCAPE&&this.deselect()}));l.cancel();const h=this.input.registerUnfilteredHandler(K.e,(t=>{if(t.key===B.R.DELETE||t.key===B.R.BACKSPACE){const{currentId:t}=this.state;t&&(this.discard(),this.data.deleteEntity(t),this.data.finalizeHistory())}}));h.cancel();const c=new q.V(this.input.registerPriorityHandler(J.R,tt.S,(()=>(this.deselect(),!0))),this.input.registerPriorityHandler(J.R,it.i,(()=>(this.deselect(),!0))));c.cancel();const u=new q.V(this.input.registerMeshHandler(J.R,this.allViewsComparator,this.onToggleSelectInput.bind(this)),this.input.registerMeshHandler(X.u4,this.allViewsComparator,this.onToggleSelectInput.bind(this)),this.input.registerMeshHandler(X._t,this.draggableViewsComparator,this.onToggleSelectInput.bind(this)));u.cancel();const m=this.input.registerUnfilteredHandler(J.R,this.addPoint),p=this.input.registerUnfilteredHandler(J.R,this.mergePointAndStartNewWall),g=new q.V(this.input.registerMeshHandler(X.u4,this.draggableViewsComparator,this.placeOnDrag.bind(this)),this.input.registerMeshHandler(X.Zv,this.draggableViewsComparator,this.onDragEnd.bind(this)));g.cancel();const v=this.input.registerUnfilteredHandler(Z.mE,(t=>this.move(t)));v.cancel();const f=this.input.registerUnfilteredHandler(Z.er,this.dropOnPointerUp.bind(this));f.cancel();const w=this.input.registerUnfilteredHandler(Z.mE,this.moveTemporaryPreview.bind(this));w.cancel();const y=this.input.registerUnfilteredHandler(Z.er,(t=>{t.button===_t.M.PRIMARY&&this.updateCursor(!0)})),S=(0,$.k1)((()=>{this.commandBinder.issueCommand(new et.ZK)}),(()=>{this.commandBinder.issueCommand(new et.Lp)}),!1),b=new q.V(a,d,u,fe("ToolState.READ_ONLY -> bindings")),I=new q.V(a,d,u,g,y,r,fe("ToolState.IDLE -> bindings")),C=new q.V(a,n,d,w,m,S,fe("ToolState.WAIT_FOR_ADD -> bindings")),O=new q.V(a,n,v,d,p,S,r,fe("ToolState.ADDING -> bindings")),A=[a,u,d,y,l,c],M=[g,r,h],V=new q.V(...A,...M,fe("ToolState.SELECTED -> bindings")),R=new q.V(...A,fe("ToolState.SELECTED_READ_ONLY -> bindings")),N=new q.V(a,e,n,d,fe("ToolState.PLACING -> (base) bindings")),T=new q.V(...A,...M,fe("ToolState.EDITING -> bindings"));return new Y.U([{state:E.M.ToolState.DISABLED,subs:[a]},{state:E.M.ToolState.READ_ONLY,subs:[b]},{state:E.M.ToolState.IDLE,subs:[I]},{state:E.M.ToolState.WAIT_FOR_ADD,subs:[C]},{state:E.M.ToolState.ADDING,subs:[O]},{state:E.M.ToolState.SELECTED,subs:[V]},{state:E.M.ToolState.SELECTED_READ_ONLY,subs:[R]},{state:E.M.ToolState.EDITING,subs:[T]},{state:E.M.ToolState.PLACING,subs:[N,v,f]}])}getCurrentRoomBoundHit(t,e){let i=[];if(null==e)i=this.input.getCurrentRayHits();else{const t=e.clone().add(new V.Vector3(0,1e3,0));i=this.raycaster.picking.cast(t,C.fU.DOWN)}let s=i.filter((t=>t.object instanceof ct&&!!t.object.raycastEnabled)).map((t=>t.object.roomBoundsId));return t&&(s=s.filter((e=>!t.has(e)))),s.length>0?this.data.getEntity(s[0]):null}onToggleSelectInput(t,e){this.updateOpeningEditState(e);const i=e.roomBoundsId;i&&setTimeout((()=>{if(e.parent){if(this.state.selected===i)t instanceof J.R&&(this.discard(),this.deselect());else{const t=this.state.toolState;t!==E.M.ToolState.EDITING&&t!==E.M.ToolState.PLACING||this.discard(),this.select(i),t!==E.M.ToolState.READ_ONLY&&t!==E.M.ToolState.SELECTED_READ_ONLY&&this.edit(i),this.hover(i)}}}),0)}hover(t,e){super.hover(t),e&&this.handleOpeningHover(e),this.state.tempHoverPreviewEntityId&&this.state.tempHoverPreviewEntityId!==t&&this.deleteTemporaryPreview();const i=this.state.toolState===E.M.ToolState.ADDING||this.state.toolState===E.M.ToolState.WAIT_FOR_ADD,s=this.state.addType===_.RE.DOORS||this.state.addType===_.RE.OPENINGS;if(i&&s){const t=this.getCurrentRoomBoundHit(),e=this.getCursorOrigin(),i=this.addOpeningOrDoor(t,e);i&&(this.state.tempHoverPreviewEntityId=i)}}handleOpeningHover(t){const e=t=>{t.hoverState.active=!1,t.hoverState.off()};if(t instanceof Ft)e(t.startHandle),e(t.endHandle);else if(t instanceof Bt){e(t instanceof Wt?t.parentOpeningView.endHandle:t.parentOpeningView.startHandle)}}placeOnDrag(t,e){if(t instanceof X._t&&t.buttons!==_t.r.PRIMARY||t instanceof X.u4&&t.pointer.buttons!==_t.r.PRIMARY)return;this.updateOpeningEditState(e);const i=e.roomBoundsId;this.state.selected!==i&&this.select(i),this.place(i),this.state.dragging=!0}onDragEnd(t){this.state.dragging=!1}updateOpeningEditState(t){this.state.openingEditState=t instanceof Wt?_.sO.START:t instanceof Ht?_.sO.END:_.sO.MOVE}dropOnPointerUp(t){if(t.down)this.updateCursor(!0);else{!1!==this.state.pendingValid?this.tryCommit():this.discard()}}addOpeningOrDoor(t,e){if(!(t instanceof O.c))return null;const i=t.getProjection(e)/t.length,s=Math.min(.9*t.length,.9144),o=s/t.length*.5,a=(0,zt.uZ)(i,o,1-o);return this.data.addWallOpening({wallId:t.id,type:this.state.addType===_.RE.DOORS?W.u.DOOR:W.u.OPENING,relativePos:a,width:s})}deleteTemporaryPreview(){this.state.tempHoverPreviewEntityId&&this.data.tryGetEntity(this.state.tempHoverPreviewEntityId)&&(this.data.deleteEntity(this.state.tempHoverPreviewEntityId),this.state.tempHoverPreviewEntityId=null)}addFirstFloatingPoint(t){if(!this.floorsViewData.currentFloorId)throw new Error("Expected a floor when adding point.");const{wall:e,toId:i}=this.data.addFloatingEdge(this.state.wallType,t,Object.assign({},t),this.data.getLastWallWidth(this.state.wallType),this.floorsViewData.currentFloorId);this.add(e),this.state.toId=i}}var ye=i(26158),Se=i(69739),Ee=i(56159),be=i(46391),Ie=i(15004);class De extends Tt{}class Ce{constructor(t,e,i,s,o,a,n,r,d,l,h,c){this.scene=t,this.input=e,this.inputManager=i,this.editor=s,this.data=o,this.floorsViewData=a,this.roomLabelMaker=n,this.wallLabelMaker=r,this.cameraData=d,this.locale=l,this.engine=h,this.settingsData=c,this.currentFloorId="",this.cameraDirty=!1,this.rootObjects={},this.viewMap=new Map,this.nodeMap=new Map,this.roomMap=new Map,this.openingMap=new Map,this.hideCurrentFloorViews=()=>{if(this.currentFloorId){const t=this.rootObjects[this.currentFloorId];for(const e of t.children)e instanceof ct&&this.unregisterViewToInput(e);this.scene.remove(t)}},this.showCurrentFloorViews=()=>{var t;const e=(null===(t=this.floorsViewData.singleFloor)||void 0===t?void 0:t.id)||this.floorsViewData.currentFloorId;if(e){const t=this.rootObjects[e];this.scene.add(t);for(const e of t.children)e instanceof ct&&this.registerViewToInput(e);this.currentFloorId=e}},this.updateOpeningView=(()=>{const t=new V.Vector3,e=new V.Vector3,i=new V.Vector3,s=new V.Vector3,o=new V.Vector3,a=new V.Vector3;return n=>{var r;const d=this.data.getWall(n.wallId),l=(null===(r=this.floorsViewData.floors.getFloor(d.floorId))||void 0===r?void 0:r.bottom)||0;a.set(0,l,0),d.getBiasAdjustmentVec(o),d.from.getVec3(i).add(o).add(a),d.to.getVec3(s).add(o).add(a),e.subVectors(s,i).normalize(),t.copy(i),t.lerp(s,n.relativePos),i.copy(t).addScaledVector(e,-.5*n.width),s.copy(t).addScaledVector(e,.5*n.width);const h=this.openingMap.get(n.id);if(!h)throw new Error("Unable to find view for opening while updating");h.onEdgePositionChanged(i,s,d.width,n.type)}})(),this.onMove=({target:t})=>{t&&this.toggleLabelChildrenForView(t,!0)},this.onMoveEnd=({target:t})=>{t&&this.toggleLabelChildrenForView(t,!1)},this.onSelect=({target:t,previous:e})=>{e&&this.toggleViewWallLabel(e,!1),t&&this.toggleViewWallLabel(t,!0)},this.onHover=({target:t,previous:e})=>{e&&this.toggleViewWallLabel(e,!1),t&&this.toggleViewWallLabel(t,!0)},this.floorsViewData.floors.iterate((t=>{this.rootObjects[t.id]=new V.Object3D})),this.bindings=[this.data.onWallsChanged({onRemoved:t=>this.removeViewForWall(t),onUpdated:t=>this.updateWallView(t),onAdded:t=>this.makeWallView(t)}),this.data.onNodesChanged({onRemoved:t=>this.removeViewForNode(t),onUpdated:t=>this.updateNodeView(t),onAdded:t=>this.makeNodeView(t)}),this.data.onRoomsChanged({onRemoved:t=>this.removeViewForRoom(t),onUpdated:t=>this.updateRoomView(t),onAdded:t=>this.makeRoomView(t)}),this.data.onOpeningsChanged({onRemoved:t=>this.removeViewForOpening(t),onUpdated:t=>this.updateOpeningView(t),onAdded:t=>this.makeOpeningView(t)}),this.editor.subscribe(E.M.Events.Move,this.onMove),this.editor.subscribe(E.M.Events.EditConfirm,this.onMoveEnd),this.editor.subscribe(E.M.Events.SelectChange,this.onSelect),this.editor.subscribe(E.M.Events.HoverChange,this.onHover),this.engine.subscribe(Ee.S,this.hideCurrentFloorViews),this.engine.subscribe(Se.P,this.showCurrentFloorViews),d.onChanged((()=>this.cameraDirty=!0)),this.settingsData.onPropertyChanged(ye.F.UnitType,(t=>{for(const t of this.data.rooms.values())this.updateRoomView(t);for(const t of this.data.walls.values())this.updateWallView(t)}))],this.bindings.forEach((t=>t.cancel()))}init(){}render(t){const e=this.cameraData.pose.pitchFactor();for(const i of[this.viewMap,this.nodeMap,this.roomMap,this.openingMap])for(const s of i.values())s.tickAnimations(t),s.setPitchFactor(e)}dispose(){}beforeRender(){this.cameraDirty&&(this.cameraDirty=!1,this.updateLabels())}activate(t,e={readonly:!1}){if(!e.readonly)for(const[t,e]of this.data.nodes)this.makeNodeView(e);for(const[t,e]of this.data.walls)this.makeWallView(e);for(const[t,e]of this.data.rooms)this.makeRoomView(e);for(const[t,e]of this.data.wallOpenings)this.makeOpeningView(e);this.bindings.forEach((t=>t.renew())),this.showCurrentFloorViews()}deactivate(){this.bindings.forEach((t=>t.cancel()));for(const t in this.rootObjects){const e=this.rootObjects[t];this.scene.remove(e);for(const t of e.children.slice())t instanceof ct&&(t.dispose(),this.unregisterViewToInput(t)),e.remove(t)}}getRoomBoundView(t){const e=this.viewMap.get(t)||this.nodeMap.get(t);if(e)return e;throw new Error(`View for id: ${t} doesn't exist`)}updateLabels(){for(const t of this.roomMap.values())t.updateLabelBillboard()}registerViewToInput(...t){var e;for(const i of t)(null===(e=i.parent)||void 0===e?void 0:e.parent)&&(this.input.registerMesh(i,!1),this.inputManager.addEditableEntity(i,i.roomBoundsId))}unregisterViewToInput(...t){for(const e of t)this.input.unregisterMesh(e),this.inputManager.removeEditableEntity(e.roomBoundsId)}makeNodeView(t){var e;const i=new De(t.id,this.cameraData),s=(null===(e=this.floorsViewData.floors.getFloor(t.floorId))||void 0===e?void 0:e.bottom)||0;i.updatePosition(new V.Vector3(t.x,s,t.z)),this.nodeMap.set(t.id,i),this.rootObjects[t.floorId].add(i),this.registerViewToInput(i)}updateNodeView(t){var e;const i=this.nodeMap.get(t.id);if(i){const s=(null===(e=this.floorsViewData.floors.getFloor(t.floorId))||void 0===e?void 0:e.bottom)||0;i.updatePosition(new V.Vector3(t.x,s,t.z))}}removeViewForNode(t){const e=this.nodeMap.get(t.id);e&&(this.rootObjects[t.floorId].remove(e),this.nodeMap.delete(t.id),e.dispose(),this.unregisterViewToInput(e))}makeWallView(t){const e=this.wallLabelMaker.createLabel();e.setRenderOrder(dt.z.labels),e.opacity=0;const i=new ge(t.id,this.cameraData,e);this.viewMap.set(t.id,i),this.rootObjects[t.floorId].add(i),this.rootObjects[t.floorId].add(e),this.updateWallView(t),i.updateLabelBillboard(),this.registerViewToInput(i)}updateWallView(t){const e=this.viewMap.get(t.id);e&&(e.onEdgePositionChanged(this.data,this.floorsViewData),e.updateLabel(this.getUnits()))}removeViewForWall(t){const e=this.viewMap.get(t.id);e&&(this.rootObjects[t.floorId].remove(e),this.rootObjects[t.floorId].remove(e.label),this.viewMap.delete(t.id),e.dispose(),this.unregisterViewToInput(e))}makeRoomView(t){var e;const i=this.rootObjects[t.floorId];this.roomMap.has(t.id)&&this.removeViewForRoom(t);const s=this.roomLabelMaker.makeLabel(),o=(null===(e=this.floorsViewData.floors.getFloor(t.floorId))||void 0===e?void 0:e.bottom)||0,a=new se(t,s,o,this.cameraData);i.add(a),this.roomMap.set(t.id,a),this.registerViewToInput(a),this.updateRoomView(t)}updateRoomView(t){var e;const i=this.roomMap.get(t.id);if(!i)throw new Error("Unable to find view for room while updating.");const s=(null===(e=this.floorsViewData.floors.getFloor(t.floorId))||void 0===e?void 0:e.bottom)||0;i.updateGeo(t,s),i.updateLabelBillboard();const o=this.getUnits();let a=`${t.getArea(o)} ${o===be.M.IMPERIAL?"sq ft":"sq m"}`;a+="\n"+t.getMeasurementText(o),i.updateText((0,Ie.LN)(t.id,this.locale,this.data),a)}removeViewForRoom(t){const e=this.roomMap.get(t.id);if(!e)throw new Error("Unable to find view for room while deleting.");this.rootObjects[t.floorId].remove(e),this.roomMap.delete(t.id),e.dispose(),this.input.unregisterMesh(e),this.inputManager.removeEditableEntity(t.id)}makeOpeningView(t){const e=this.data.getWall(t.wallId),i=new Ft(t.id,e.floorId,this.cameraData);this.rootObjects[e.floorId].add(i,i.stencilPrepass,i.startHandle,i.endHandle),this.openingMap.set(t.id,i),this.registerViewToInput(i,i.startHandle,i.endHandle),this.updateOpeningView(t)}removeViewForOpening(t){const e=this.openingMap.get(t.id);if(!e)throw new Error("Unable to find view for opening while deleting.");this.rootObjects[e.floorId].remove(e,e.stencilPrepass,e.startHandle,e.endHandle),this.openingMap.delete(t.id),e.dispose(),this.unregisterViewToInput(e,e.startHandle,e.endHandle)}toggleLabelChildrenForView(t,e){if(this.viewMap.has(t)){const i=this.data.getWall(t);this.toggleViewWallLabel(i.to.id,e),this.toggleViewWallLabel(i.from.id,e)}else this.toggleViewWallLabel(t,e)}toggleViewWallLabel(t,e){if(this.viewMap.has(t)){const i=this.viewMap.get(t);if(i){const t=i.hoverState.active,s=i.selectState.active||i.highlightState.active,o=t||s||e;i.setLabelVisible(o)}}if(this.roomMap.has(t)){const i=this.data.getRoom(t);if(i)for(const t of i.walls)this.toggleViewWallLabel(t.id,e)}if(this.nodeMap.has(t)){const i=this.data.getNode(t);if(i){const t=this.data.getWallsForNode(i);for(const i of t)this.toggleViewWallLabel(i.id,e)}}}getUnits(){return this.settingsData.tryGetProperty(ye.F.UnitType,be.M.IMPERIAL)}}var Oe=i(18544),Ae=i(85893),Me=i(67294),Ve=i(33558),Re=i(38399),Ne=i(9074),Te=i(47457),Le=i(68072),Pe=i(65298),xe=i(66102),Fe=i(1358);function ke({room:t}){const e=(0,Fe.S)(),i=(0,xe.b)(),s=(0,Ie.LN)(t.id,i,e);return(0,Ae.jsx)("div",Object.assign({className:"room-title"},{children:s}))}function Be(){const{locale:t,commandBinder:e}=(0,Me.useContext)(Ve.I),i=(0,Ne._)();return(0,Ae.jsxs)(Le.J,Object.assign({open:!!i},{children:[(0,Ae.jsx)("div",Object.assign({className:"detail-panel-header"},{children:(0,Ae.jsx)(Te.zx,{label:t.t(Re.Z.CLOSE),className:"return-btn",icon:"close",size:Te.qE.SMALL,variant:Te.Wu.TERTIARY,onClick:async function(){i&&e.issueCommand(new D.pZ(i.id))}})})),(0,Ae.jsxs)("div",Object.assign({className:"room-view"},{children:[i&&(0,Ae.jsx)(ke,{room:i}),i&&(0,Ae.jsx)(Pe.M,{room:i})]}))]}))}class We{constructor(){}renderPanel(){return(0,Ae.jsx)(Be,{})}}var He=i(40964);class _e{constructor(t,e,i){this.engine=t,this.toolsData=e,this.viewData=i,this.bindings=[],this.selectionChanged=async t=>{if(this.toolsData.activeToolName===r.w1.ROOM_BOUNDS)return;const e=this.viewData.getSelectedRoom(t);this.toolsData.activeToolName===r.w1.ROOM_VIEW!==!!e&&(await this.engine.commandBinder.issueCommand(new h.tT(r.w1.ROOM_VIEW,!!e)),this.engine.broadcast(e?new He.ro:new He.A))},this.bindings.push(this.viewData.editorState.onPropertyChanged("selected",this.selectionChanged))}async activate(){}async deactivate(){}async dispose(){this.bindings.forEach((t=>t.cancel()))}}var Ue=i(38042),ze=i(79727),Ge=i(33324),je=i(9037);const $e=.5;class qe{constructor(t){this.axis=new Ye(t),this.orthoAxis=new Ye(t)}showAt(t,e){this.axis.setPosition(t),this.axis.show(),e?(this.orthoAxis.setPosition(e),this.orthoAxis.show()):this.orthoAxis.hide()}hide(){this.axis.hide(),this.orthoAxis.hide()}dispose(){this.axis.dispose(),this.orthoAxis.dispose()}}class Ye{constructor(t){this.scene=t,this.setPosition=(()=>{const t=new V.Vector3,e=new V.Vector3,i=new V.Vector3,s=new V.Vector3;return o=>{i.subVectors(o.end,o.start).normalize(),s.copy(i).applyAxisAngle(C.fU.UP,Math.PI/2),t.copy(o.start).addScaledVector(i,-1e3),e.copy(o.start).addScaledVector(i,1e3),this.alignedAxis.updateEndpoints(t,e),t.copy(o.start).addScaledVector(s,$e),e.copy(o.start).addScaledVector(i,$e).addScaledVector(s,$e),this.angleIndictorLine1.updateEndpoints(t,e),t.copy(o.start).addScaledVector(s,-1e3),e.copy(o.start).addScaledVector(s,1e3),this.orthoAxis.updateEndpoints(t,e),t.copy(o.start).addScaledVector(i,$e),e.copy(o.start).addScaledVector(s,$e).addScaledVector(i,$e),this.angleIndictorLine2.updateEndpoints(t,e)}})();const e={dashed:!1,dashSize:1,gapSize:1,lineWidth:1,color:nt.I.MP_BRAND,dashUnits:he.PIXELS,depthWrite:!1,depthTest:!1,depthFunc:V.AlwaysDepth,opacity:1},i={dashed:!0,dashSize:5,gapSize:2,lineWidth:1,color:nt.I.MP_BRAND,dashUnits:he.PIXELS,depthWrite:!1,depthTest:!1,depthFunc:V.AlwaysDepth,opacity:1};this.alignedAxis=new ue(new V.Vector3,new V.Vector3,i),this.orthoAxis=new ue(new V.Vector3,new V.Vector3,i),this.angleIndictorLine1=new ue(new V.Vector3,new V.Vector3,e),this.angleIndictorLine2=new ue(new V.Vector3,new V.Vector3,e),this.scene.add(this.alignedAxis),this.scene.add(this.orthoAxis),this.scene.add(this.angleIndictorLine1),this.scene.add(this.angleIndictorLine2),this.hide()}show(){this.alignedAxis.visible=!0,this.orthoAxis.visible=!0,this.angleIndictorLine1.visible=!0,this.angleIndictorLine2.visible=!0}hide(){this.alignedAxis.visible=!1,this.orthoAxis.visible=!1,this.angleIndictorLine1.visible=!1,this.angleIndictorLine2.visible=!1}dispose(){this.scene.remove(this.alignedAxis),this.scene.remove(this.orthoAxis),this.scene.remove(this.angleIndictorLine1),this.scene.remove(this.angleIndictorLine2)}}var Ze=i(71166),Xe=i(5823),Ke=i(79307),Qe=i(39642),Je=i(95512),ti=i(20217),ei=i(61282);var ii,si=i(42147),oi=i(90654),ai=i(50190),ni=i(23254),ri=i(54244),di=i(64918),li=i(55450),hi=i(18596);!function(t){t[t.INACTIVE=0]="INACTIVE",t[t.ACTIVE_EDIT=1]="ACTIVE_EDIT",t[t.ACTIVE_READ_ONLY=2]="ACTIVE_READ_ONLY"}(ii||(ii={}));const ci=[r.w1.ROOM_BOUNDS,r.w1.SEARCH,r.w1.LAYERS,r.w1.ROOM_VIEW];class ui extends o.Y{constructor(){super(...arguments),this.name="room_bound",this.state=ii.INACTIVE,this.disabledAssets={[f.U]:!1,[v.s]:!1,[u.re]:!1,[g.Mp]:!1},this.activate=async()=>{await this.tryDeactivate(),this.state=ii.ACTIVE_EDIT,this.disableUnrelatedAssets.toggle(!0),this.floorsViewData.onlyShowActiveFloor.value=!0,await this.commandBinder.issueCommand(new Ze.Xv(Xe.SF.MODELROOM)),await this.commandBinder.issueCommand(new ti.C({phiUpperLimitDegrees:90,phiLowerLimitDegrees:ei.bp*Gt.MN,noTransition:!0})),await this.commandBinder.issueCommand(new si.Nb),await this.commandBinder.issueCommand(new Je.y(!0)),await this.cameraData.transition.promise,await this.commandBinder.issueCommand(new y._i(y.BD.DOLLHOUSE,di.n.FadeToBlack,this.getStartCameraPose(),li.DEFAULT_TRANSITION_TIME/2)),await this.commandBinder.issueCommand(new S.M),await this.commandBinder.issueCommand(new Ge.tR),await this.commandBinder.issueCommand(new Ge.TS),await this.commandBinder.issueCommand(new ti.h),this.updateCursor(),this.editor.start(),this.renderer.activate(this.engine,{readonly:!1}),this.inputManager.activate(!1)},this.activateReadOnly=async()=>{this.state!==ii.ACTIVE_READ_ONLY&&(await this.tryDeactivate(),this.state=ii.ACTIVE_READ_ONLY,this.editor.startReadOnly(),this.renderer.activate(this.engine,{readonly:!0}),this.inputManager.activate(!0),await this.cameraData.transition.promise,this.updateCursor())},this.deactivateReadOnly=async()=>{this.state===ii.ACTIVE_READ_ONLY&&(this.editor.exit(),this.renderer.deactivate(),this.inputManager.deactivate(),this.state=ii.INACTIVE)},this.deactivate=async()=>{this.editor.exit(),this.renderer.deactivate(),this.inputManager.deactivate(),this.disableUnrelatedAssets.toggle(!1),this.snappingAxesRenderer.hide(),await this.commandBinder.issueCommand(new Ze.Xv(!1)),await this.commandBinder.issueCommand(new S.I),await this.commandBinder.issueCommand(new ti.C({noTransition:!0})),await this.commandBinder.issueCommand(new si.qK),await this.commandBinder.issueCommand(new Ge.LW),await this.commandBinder.issueCommand(new Je.y(!1)),await this.commandBinder.issueCommand(new Ge.Md),await this.commandBinder.issueCommand(new m.u(p.C.DEFAULT)),this.floorsViewData.onlyShowActiveFloor.value=!1,this.state=ii.INACTIVE},this.tryDeactivate=async()=>{this.state===ii.ACTIVE_EDIT?await this.deactivate():this.state===ii.ACTIVE_READ_ONLY&&await this.deactivateReadOnly()},this.select=async t=>{t&&(await this.updateShowcaseVisibility(),this.state!==ii.INACTIVE&&this.editor.select(t))},this.unselect=async t=>{t&&(await this.updateShowcaseVisibility(),this.state!==ii.INACTIVE&&this.editor.deselect())},this.undo=async()=>{await this.ensureValidViewMode();const t=this.editor.state.selected;!(this.editor.state.toolState===E.M.ToolState.SELECTED||this.editor.state.toolState===E.M.ToolState.EDITING)&&this.editor.discard(),this.data.undo();!(t&&this.data.tryGetEntity(t))&&this.editor.discard()},this.editWall=t=>{const e=this.editor.state;e.toolState===E.M.ToolState.EDITING&&e.currentId&&this.editor.tryCommit(),this.editor.edit(t)},this.finishEdit=()=>{this.editor.tryCommit()},this.cancelEdit=async()=>{await this.ensureValidViewMode(),this.editor.discard()},this.exitEdit=()=>{this.editor.discard()},this.deleteEntity=async t=>{await this.ensureValidViewMode();const e=this.editor.state,i=t.id||e.currentId;i&&(this.editor.discard(),this.data.deleteEntity(i),this.data.finalizeHistory())},this.addEntity=async({addState:t,wallType:e})=>{await this.ensureValidViewMode();const i=this.editor.state.toolState;i!==E.M.ToolState.IDLE&&i!==E.M.ToolState.SELECTED&&this.editor.discard(),this.editor.state.addType=t,void 0!==e&&(this.editor.state.wallType=e),this.editor.waitForAdd()},this.updateCursor=()=>{this.commandBinder.issueCommand(new m.u(this.editor.state.cursor))}}async init(t,e){this.commandBinder=e.commandBinder,this.engine=e;const[i,o,r,l,h,u,m,p,g,v,f]=await Promise.all([e.getModuleBySymbol(s.y.INPUT),e.getModuleBySymbol(s.y.RAYCASTER),e.market.waitForData(b.Z),e.getModuleBySymbol(s.y.WEBGL_RENDERER),e.market.waitForData(a.e),e.market.waitForData(ze.c),e.market.waitForData(je.M),e.getModuleBySymbol(s.y.LOCALE),e.market.waitForData(ni.O),e.market.waitForData(ri.pu),e.market.waitForData(d.t)]);this.data=r,this.floorsViewData=u,this.cameraData=m,this.viewmodeData=g,this.applicationData=v,this.toolsData=f,this.settingsData=h,this.disableUnrelatedAssets=new n.u(h,this.disabledAssets),this.snappingAxesRenderer=new qe(l.getScene());const y=new V.Vector3,S=()=>{var t;const e=i.getCurrentPointerRay();return y.set(0,0,0),u.currentFloor&&e.intersectPlane(null===(t=u.currentFloor)||void 0===t?void 0:t.groundPlane,y),y};this.editor=new we(S,i,o,e.msgBus,r,this.floorsViewData,m.pose,e.commandBinder,t.rootNode);const E=h.tryGetProperty(c.gx.RoomBounds,!1);this.viewData=new Oe.e(this.data,this.editor.state,E),this.addToolPanel(),this.inputManager=new z(this.editor,S,r,m,this.snappingAxesRenderer,i.keyboardState);const I=new Ke.$(h.tryGetProperty(Qe.Q,!1),h.tryGetProperty("assetBasePath",""));I.setRenderLayer(e.claimRenderLayer("labels"));const C=new oi.uc({assetBasePath:h.tryGetProperty("assetBasePath",""),color:"black",background:!0,backgroundColor:"#ffffff",backgroundColliderType:ai.H,disableDepth:!0});this.renderer=new Ce(l.getScene(),i,this.inputManager,this.editor,this.data,this.floorsViewData,I,C,m,p,e,h),e.addComponent(this,this.renderer),this.renderer.deactivate(),this.bindings.push(e.commandBinder.addBinding(D.Yx,this.activate),e.commandBinder.addBinding(D.Rc,this.deactivate),e.commandBinder.addBinding(D.et,(async t=>this.select(t.id))),e.commandBinder.addBinding(D.pZ,(async t=>this.unselect(t.id))),e.commandBinder.addBinding(D.Os,(async t=>this.toggleVisibilityByViewer(t.visible))),this.editor.state.onPropertyChanged("cursor",this.updateCursor),g.currentModeObservable.onChanged((()=>this.updateShowcaseVisibility())),this.toolsData.onToolChanged((()=>this.updateShowcaseVisibility())),e.subscribe(j.pB,(t=>{this.updateShowcaseVisibility(),t.application===ri.Mx.SHOWCASE&&this.addToolPanel()}))),t.readonly||this.bindings.push(e.commandBinder.addBinding(D.pd,(async t=>this.deleteEntity(t))),e.commandBinder.addBinding(D.o3,(async()=>this.undo())),e.commandBinder.addBinding(D.vQ,this.addEntity),e.commandBinder.addBinding(D.mB,(async t=>this.editWall(t.id))),e.commandBinder.addBinding(D.DE,(async()=>this.finishEdit())),e.commandBinder.addBinding(D._j,this.cancelEdit),e.commandBinder.addBinding(D.bw,(async()=>this.exitEdit())),e.commandBinder.addBinding(D.Km,(async t=>this.editRoomName(t.id,t.name))),e.commandBinder.addBinding(D.c8,(async t=>this.editRoomTypes(t.id,t.roomTypeIds))),h.onPropertyChanged(c.gx.RoomBounds,(()=>this.updateShowcaseAvailability())),h.onPropertyChanged(w.dF,(()=>this.updateShowcaseAvailability()))),e.market.register(this,Oe.e,this.viewData),this.updateShowcaseAvailability(),async function(t){const e=await t.market.waitForData(a.e),i=await t.getModuleBySymbol(s.y.SETTINGS),o=(t,s,o)=>{i.registerSetting("Room Bounds"+t,t+s+"Inner",o.innerColor,!0),e.onPropertyChanged(t+s+"Inner",(t=>o.innerColor=t)),i.registerSetting("Room Bounds"+t,t+s+"Outer",o.outerColor,!0),e.onPropertyChanged(t+s+"Outer",(t=>o.outerColor=t)),i.registerSetting("Room Bounds"+t,t+s+"Opacity",o.opacity,!0),e.onPropertyChanged(t+s+"Opacity",(t=>o.opacity=t))},n=(t,e)=>{o(t,"Base",e.baseState),o(t,"Hover",e.hoverState),o(t,"Select",e.selectState),o(t,"Dim",e.dimState)};n("Node",Rt),n("Edge",pe),n("Room",ie),i.registerButton("Room Bounds Export","Export colors",(()=>{const t={Node:Rt,Edge:pe,Room:ie},e=JSON.stringify(t);navigator.clipboard.writeText(e)})),i.registerButton("Room Bounds Export","Import colors",(async()=>{const t=(t,e,i)=>{s(t.baseState,e.baseState,i,"Base"),s(t.hoverState,e.hoverState,i,"Hover"),s(t.selectState,e.selectState,i,"Select"),s(t.dimState,e.dimState,i,"Dim")},s=(t,e,s,o)=>{t.innerColor=new V.Color(e.innerColor),t.outerColor=new V.Color(e.outerColor),t.opacity=e.opacity;const a=s+o;i.updateSetting(a+"Inner",t.innerColor),i.updateSetting(a+"Outer",t.outerColor),i.updateSetting(a+"Opacity",t.opacity)},o=await navigator.clipboard.readText(),a=JSON.parse(o);a&&(t(Rt,a.Node,"Node"),t(pe,a.Edge,"Edge"),t(ie,a.Room,"Room")),e.setDirty(!0),e.commit()}))}(e)}dispose(t){super.dispose(t),t.market.unregister(this,Oe.e)}toggleVisibilityByViewer(t){this.viewData.visibleInShowcase=t,this.viewData.commit(),this.updateShowcaseVisibility()}async updateShowcaseAvailability(){const t=this.settingsData.tryGetProperty(c.gx.RoomBounds,!1),e=this.settingsData.tryGetProperty(w.dF,!1);this.settingsData.setProperty(I.hW,t&&e),this.updateShowcaseVisibility()}async updateShowcaseVisibility(){const{application:t}=this.applicationData,e=t===ri.Mx.SHOWCASE,i=t===ri.Mx.WORKSHOP,s=this.settingsData.tryGetProperty(I.hW,!1),o=e&&this.viewData.visibleInShowcase&&s||i,a=null==this.toolsData.activeToolName||ci.includes(this.toolsData.activeToolName),n=this.viewmodeData.isFloorplan();o&&n&&a?await this.activateReadOnly():await this.deactivateReadOnly()}async addToolPanel(){if(!this.toolsData.getTool(r.w1.ROOM_VIEW)){const t=new _e(this.engine,this.toolsData,this.viewData),e=new l.U({id:r.w1.ROOM_VIEW,panel:!0,enabled:!0,dimmed:!1,manager:t,ui:new We,analytic:"rooms"});await this.engine.commandBinder.issueCommand(new h.MV([e]))}}editRoomName(t,e){this.data.getRoom(t).name!==e&&(this.data.setRoomDetails(t,e),this.data.finalizeHistory())}editRoomTypes(t,e){const i=this.data.getRoom(t).classifications.map((t=>t.id));(0,Ue.E8)(e,i)||(this.data.setRoomDetails(t,void 0,e),this.data.finalizeHistory())}getStartCameraPose(){const t=this.floorsViewData.currentFloor||this.floorsViewData.getFloor(this.floorsViewData.bottomFloorId),e=t.bottom,i=t.boundingBox.getCenter(new V.Vector3);i.y=e;const s=t.boundingBox.max.clone();s.y=e;const o=i.distanceTo(s)/Math.tan(hi.oR.fov/2*Gt.Ue),a=C.Hk.DOWNWARD.clone().multiply((new V.Quaternion).setFromAxisAngle(C.fU.RIGHT,45*Gt.Ue)),n=C.fU.FORWARD.clone().applyQuaternion(a).multiplyScalar(-1*o);return{position:i.clone().add(n),rotation:a}}async ensureValidViewMode(){this.cameraData.pose.autoOrthoApplied&&await this.engine.commandBinder.issueCommand(new ti.h)}}},20241:(t,e,i)=>{"use strict";i.d(e,{d:()=>s});class s{constructor(t){this.tags=[],t&&Object.assign(this,t)}}},55248:(t,e,i)=>{"use strict";i.d(e,{C:()=>s});var s,o=i(10513);!function(t){const e={[o.M.Events.HoverChange.type]:"hoverState",[o.M.Events.SelectChange.type]:"selectState",[o.M.Events.ValidChange.type]:"validState",[o.M.Events.Move.type]:"mover",[o.M.Events.HighlightAdd.type]:"highlightState",[o.M.Events.HighlightClear.type]:"highlightState",[o.M.Events.DimAdd.type]:"dimState",[o.M.Events.DimClear.type]:"dimState"};t.EditorEntityAdapter=class{constructor(t){this.editor=t,this.bindings=[],this.entities=new Map,this.bindings.push(this.editor.subscribe(o.M.Events.HoverChange,(t=>this.bindTargetedCallback(o.M.Events.HoverChange.type,t))),this.editor.subscribe(o.M.Events.SelectChange,(t=>this.bindTargetedCallback(o.M.Events.SelectChange.type,t))),this.editor.subscribe(o.M.Events.ValidChange,(t=>this.bindTargetedCallback(o.M.Events.ValidChange.type,t))),this.editor.subscribe(o.M.Events.HighlightAdd,(t=>this.bindTargetedCallback(o.M.Events.HighlightAdd.type,t))),this.editor.subscribe(o.M.Events.HighlightClear,(t=>this.bindClearCallback(o.M.Events.HighlightClear.type,t))),this.editor.subscribe(o.M.Events.DimAdd,(t=>this.bindTargetedCallback(o.M.Events.DimAdd.type,t))),this.editor.subscribe(o.M.Events.DimClear,(t=>this.bindClearCallback(o.M.Events.DimClear.type,t))),this.editor.subscribe(o.M.Events.Move,(t=>this.bindMoveCallback(t))))}registerEntity(t,...e){let i=this.entities.get(t);i||(i=[]),i.push(...e),this.entities.set(t,i)}unregisterEntity(t){return this.entities.delete(t)}bindTargetedCallback(t,i){let s=null,a=null;o.M.Events.hasTargetAndPrev(i)?(s=i.target,a=i.previous):o.M.Events.hasTarget(i)&&(s=i.target);const n=e[t];if(!n)throw Error(`implement targetted callback for ${t}`);(this.entities.get(a)||[]).forEach((t=>{n in t&&(t[n].active=!1,t[n].off())})),(this.entities.get(s)||[]).forEach((t=>{n in t&&(t[n].active=!0,t[n].on())}))}bindMoveCallback(t){(this.entities.get(t.target)||[]).forEach((e=>{e.mover&&t.target&&e.mover.onMove(t.target,t.ev)}))}bindClearCallback(t,i){let s=null;const a=e[t];o.M.Events.hasTarget(i)&&(s=i.target),(this.entities.get(s)||[]).forEach((t=>{a in t&&(t[a].active=!1,t[a].off())}))}}}(s||(s={}))},10513:(t,e,i)=>{"use strict";i.d(e,{M:()=>c});var s=i(75287),o=i(89570),a=i(2224),n=i(97998),r=i(37082),d=i(13693),l=i(98010);const h=new n.Z("editor");var c;!function(t){let e,i;t.DragAndDrop=class{constructor(t=new n){this.state=t,this.events=new d.Y,this.bindings=[],this.validator=null,this.state.commit(),this.bindings.push(this.state.onPropertyChanged("toolState",(()=>{h.debug("toolState:",{from:this.state.previousToolState,to:this.state.toolState},this.state),this.events.broadcast(new i.StateChange(this.state.toolState,this.state.previousToolState))})),this.onSelectedChanged(((t,e)=>{this.events.broadcast(new i.SelectChange(t,e))})),this.onHoveredChanged(((t,e)=>{this.events.broadcast(new i.HoverChange(t,e))})),this.state.onCurrentIdChanged(((t,e)=>{this.events.broadcast(new i.CurrentChange(t,e))}))),this.bindings.forEach((t=>t.cancel()))}subscribe(t,e){return this.events.subscribe(t,e)}setState(t){t!==this.state.toolState&&(this.state.previousToolState=this.state.toolState,this.state.toolState=t,this.state.commit())}start(){if(this.state.toolState!==e.CLOSED)throw new c("Editor already started");this.bindings.forEach((t=>t.renew())),this.setState(e.IDLE),this.events.broadcast(new i.Start)}startReadOnly(){if(this.state.toolState!==e.CLOSED)throw new c("Editor already started");this.bindings.forEach((t=>t.renew())),this.setState(e.READ_ONLY)}setEnabled(t){if(this.state.toolState===e.CLOSED)throw new c("Editor not started");if(t)this.state.toolState===e.DISABLED&&this.setState(e.IDLE);else switch(this.state.toolState){case e.DISABLED:break;case e.IDLE:this.setState(e.DISABLED);break;default:this.unhover({commit:!1}),this.deselect({commit:!1}),this.discard(),this.setState(e.DISABLED)}}exit(){this.state.toolState!==e.CLOSED&&(this.state.toolState!==e.DISABLED&&(this.unhover({commit:!1}),this.deselect({commit:!1}),this.discard()),this.setState(e.CLOSED),this.bindings.forEach((t=>t.cancel())),this.events.broadcast(new i.Exit))}setValidator(t){this.validator=t}onDiscard(t){this.state.onBeforeDiscard=t||null}edit(t){if(this.assertActive(),null!==this.state.pendingEdit)throw h.error(`Trying to edit asset ${t}, but currently editing ${this.state.pendingEdit}`),new c("Edit in progress");this.state.pendingEdit=t,this.setState(e.EDITING),this.events.broadcast(new i.EditStart(t,!1))}waitForAdd(){if(this.assertActive(),null!==this.state.pendingAdd)throw h.error(`Entering wait for add state, but already adding ${this.state.pendingAdd}`),new c("Add in progress");null!==this.state.selected&&(h.debug(`Entering the wait for add state, deselecting previous ${this.state.selected}`),this.deselect({commit:!1})),this.events.broadcast(new i.WaitForAddStart),this.setState(e.WAIT_FOR_ADD)}add(t){if(this.assertActive(),null!==this.state.pendingAdd)throw h.error(`Trying to add new asset ${t}, but already adding ${this.state.pendingAdd}`),new c("Add in progress");null!==this.state.selected&&(h.debug(`Add ${t} called, deselecting previous ${this.state.selected}`),this.deselect({commit:!1})),this.state.pendingAdd=t,this.events.broadcast(new i.AddStart(t)),this.setState(e.ADDING)}place(t){this.assertActive();const{pendingAdd:s,pendingEdit:o}=this.state,a=s||o;a&&t===a||(this.state.pendingEdit=t),this.setState(e.PLACING),this.events.broadcast(new i.EditStart(t,!0))}move(t){this.assertActive(),this.validate(t);const{pendingAdd:e,pendingEdit:s,selected:o}=this.state,a=e||s||o;a&&this.events.broadcast(new i.Move(a,t)),this.state.ndcPosition.value=t.clientPosition}highlight(...t){this.assertActive();for(const e of t)this.state.highlighted.add(e),this.events.broadcast(new i.HighlightAdd(e))}clearAllHighlights(){this.assertActive();for(const t of this.state.highlighted)this.events.broadcast(new i.HighlightClear(t));this.state.highlighted.clear()}dim(t){this.assertActive(),this.state.dimmed.add(t),this.events.broadcast(new i.DimAdd(t))}clearDim(t){this.assertActive(),this.state.dimmed.delete(t),this.events.broadcast(new i.DimClear(t))}clearAllDims(){this.assertActive();for(const t of this.state.dimmed)this.events.broadcast(new i.DimClear(t));this.state.dimmed.clear()}select(t,i){this.assertActive(),this.state.pendingAdd||this.state.pendingEdit||(this.state.previousSelected=this.state.selected,this.state.selected=t,this.state.commit(),i&&i.transitionTo?this.setState(i.transitionTo):this.state.isReadonly()?this.setState(e.SELECTED_READ_ONLY):this.setState(e.SELECTED))}toggleSelect(t){this.state.selected===t?this.deselect():this.select(t)}deselect(t={commit:!0}){this.assertActive(),this.state.pendingAdd||this.state.pendingEdit||null!==this.state.selected&&(this.state.previousSelected=this.state.selected,this.state.selected=null,t.commit&&this.state.commit(),t&&t.transitionTo?this.setState(t.transitionTo):this.state.toolState===e.SELECTED_READ_ONLY?this.setState(e.READ_ONLY):this.setState(e.IDLE))}hover(t){this.assertActive(),t!==this.state.hovered&&(this.state.previousHovered=this.state.hovered,this.state.hovered=t,this.state.commit())}unhover(t={commit:!0}){this.state.hovered&&(this.state.previousHovered=this.state.hovered,this.state.hovered=null,t.commit&&this.state.commit())}tryCommit(){this.assertActive();const t=this.state.pendingAdd,e=this.state.pendingEdit;if(!1===this.state.pendingValid)return h.warn("nop, pendingValid",this.state.pendingValid),!1;let s=!1;const o=this.state.selected,a=this.state.pendingAdd||this.state.pendingEdit;if(a){const n=null===this.state.pendingValid||!0===this.state.pendingValid;n&&(this.state.pendingAdd=null,this.state.pendingEdit=null,this.state.pendingValid=null,this.state.onBeforeDiscard=null,e&&this.events.broadcast(new i.EditConfirm(e)),t&&this.events.broadcast(new i.AddConfirm(t)),this.state.pendingAdd||this.state.pendingEdit||o!==this.state.selected||this.select(a)),s=n}return s}discard(){const s=this.state.pendingAdd||this.state.pendingEdit,o=this.state.pendingAdd,a=this.state.pendingEdit;s&&(this.state.onBeforeDiscard&&this.state.onBeforeDiscard(),a&&(this.state.pendingEdit=null,this.events.broadcast(new i.EditDiscard(a))),o&&(this.state.pendingAdd=null,this.events.broadcast(new i.AddDiscard(o))),this.events.broadcast(new t.Events.ValidChange(null,null)),this.state.pendingValid=null,this.state.onBeforeDiscard=null),this.unhover({commit:!1}),this.deselect({commit:!1}),this.state.isReadonly()?this.setState(e.READ_ONLY):this.state.toolState!==e.IDLE&&this.setState(e.IDLE),this.state.commit()}validate(e){const i=this.state.pendingAdd||this.state.pendingEdit||this.state.selected;if(i){const s=this.state.pendingValid;let o=!0;this.validator?(o=this.validator.validate(i,e),this.state.pendingValid=o):this.state.pendingValid=null,null!==this.state.pendingValid&&s!==this.state.pendingValid&&this.events.broadcast(new t.Events.ValidChange(o?i:null,o?null:i))}}assertActive(){if(this.state.toolState===t.ToolState.CLOSED)throw new c("Editor closed");if(this.state.toolState===t.ToolState.DISABLED)throw new c("Editor disabled")}onSelectedChanged(t){return this.state.onPropertyChanged("selected",(()=>t(this.state.selected,this.state.previousSelected)))}onHoveredChanged(t){return this.state.onPropertyChanged("hovered",(()=>t(this.state.hovered,this.state.previousHovered)))}},function(t){t.CLOSED="CLOSED",t.READ_ONLY="READ_ONLY",t.DISABLED="DISABLED",t.IDLE="IDLE",t.SELECTED="SELECTED",t.SELECTED_READ_ONLY="SELECTED_READ_ONLY",t.WAIT_FOR_ADD="WAIT_FOR_ADD",t.ADDING="ADDING",t.EDITING="EDITING",t.PLACING="PLACING"}(e=t.ToolState||(t.ToolState={}));class n extends s.T{constructor(){super(...arguments),this.toolState=e.CLOSED,this.previousToolState=e.CLOSED,this.pendingAdd=null,this.pendingEdit=null,this.selected=null,this.previousSelected=null,this.hovered=null,this.previousHovered=null,this.highlighted=new Set,this.dimmed=new Set,this.ndcPosition=new r.f(null),this.onBeforeDiscard=null,this.pendingValid=null}get currentId(){return this.pendingAdd||this.pendingEdit||this.selected||null}onCurrentIdChanged(t,e=!1){let i=this.currentId;const s=()=>{this.currentId!==i&&(t(this.currentId,i),i=this.currentId)},a=new o.V(this.onPropertyChanged("selected",s),this.onPropertyChanged("pendingAdd",s),this.onPropertyChanged("pendingEdit",s));return e?a.renew():a.cancel(),a}isReadonly(){return this.toolState===e.READ_ONLY||this.toolState===e.SELECTED_READ_ONLY}}t.State=n;class c extends a.y{constructor(t="invalid state"){super(t),this.name="invalid state"}}t.EditorException=c,function(t){class e extends l.v0{}e.type="edit",t.EditEvent=e;class i extends e{constructor(t){super(),this.target=t}}i.type="editt",t.EditTarget=i;class s extends e{constructor(t,e){super(),this.target=t,this.previous=e}}s.type="edittp",t.EditTargetAndPrev=s;class o extends e{constructor(t,e){super(),this.target=t,this.previous=e}}o.type="toolchange",t.StateChange=o;class a extends e{}a.type="editorstart",t.Start=a;class n extends e{}n.type="editorexit",t.Exit=n;class r extends e{}r.type="waitforaddstart",t.WaitForAddStart=r;class d extends i{}d.type="addstart",t.AddStart=d;class h extends i{constructor(t,e){super(t),this.placeOnly=e}}h.type="editstart",t.EditStart=h;class c extends i{}c.type="addconfirm",t.AddConfirm=c;class u extends i{}u.type="adddiscard",t.AddDiscard=u;class m extends i{}m.type="editconfirm",t.EditConfirm=m;class p extends i{}p.type="editdiscard",t.EditDiscard=p;class g extends i{}g.type="delete",t.Delete=g;class v extends i{constructor(t,e){super(t),this.target=t,this.ev=e}}v.type="move",t.Move=v;class f extends s{}f.type="target",t.CurrentChange=f;class w extends s{}w.type="hover",t.HoverChange=w;class y extends s{}y.type="select",t.SelectChange=y;class S extends i{}S.type="highlight",t.HighlightAdd=S;class E extends i{}E.type="highlightclear",t.HighlightClear=E;class b extends i{}b.type="dim",t.DimAdd=b;class I extends i{}I.type="dimclear",t.DimClear=I;class D extends s{}D.type="valid",t.ValidChange=D,t.hasTarget=function(t){return t instanceof i},t.hasTargetAndPrev=function(t){return t instanceof s}}(i=t.Events||(t.Events={}))}(c||(c={}))},4014:t=>{t.exports="#define ANTIALIAS_WIDTH  1.0\nprecision highp float;uniform vec3 outlineColor;uniform vec3 baseColor;uniform float radius;uniform float opacity;uniform float outlinePct;varying vec3 vPosition;void main(){float fragRadius=length(vPosition.xz);float outlineRadius=radius*outlinePct;float smoothAmt=fwidth(fragRadius)*ANTIALIAS_WIDTH;float mixAmt=smoothstep(outlineRadius-smoothAmt,outlineRadius,fragRadius);gl_FragColor=vec4(mix(baseColor,outlineColor,mixAmt),1.);gl_FragColor.a=opacity*(1.-smoothstep(radius-smoothAmt,radius,fragRadius));}"},57216:t=>{t.exports="precision highp float;uniform mat4 projectionMatrix;uniform mat4 modelViewMatrix;attribute vec3 position;varying vec3 vPosition;void main(){vPosition=position;gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.);}"},73403:t=>{t.exports="precision highp float;uniform vec3 baseColor;uniform float isDoor;varying vec3 vPosition;void main(){const float lineWidth=0.15;if(isDoor>0.){const float startZ=0.15;const float endZ=startZ+lineWidth;float alpha=(abs(vPosition.z)>startZ&&abs(vPosition.z)<endZ)?1.:0.;gl_FragColor=vec4(baseColor,alpha);}else{float alpha=(abs(vPosition.z)<lineWidth*0.5)?1.:0.;gl_FragColor=vec4(baseColor,alpha);}}"},27706:t=>{t.exports="precision highp float;uniform mat4 projectionMatrix;uniform mat4 modelViewMatrix;attribute vec3 position;varying vec3 vPosition;void main(){vPosition=position;gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.);}"},56413:t=>{t.exports="#define ANTIALIAS_WIDTH  1.0\nprecision highp float;uniform float selectedWidth;uniform vec3 outlineColor;uniform vec3 color;uniform float opacity;uniform float width;uniform vec3 lineStart;uniform vec3 lineEnd;varying vec3 vWorldPos;float distanceBetween(vec2 l1,vec2 l2,vec2 p){float D=length(l2-l1);float N=abs((l2.x-l1.x)*(l1.y-p.y)-(l1.x-p.x)*(l2.y-l1.y));return N/D;}void main(){float distanceToLine=distanceBetween(lineStart.xz,lineEnd.xz,vWorldPos.xz);float aaWidth=fwidth(distanceToLine)*ANTIALIAS_WIDTH;float lineLerp=smoothstep(selectedWidth-aaWidth,selectedWidth,distanceToLine);float halfWidth=width*0.5;float aaOpacity=smoothstep(halfWidth,halfWidth-aaWidth,distanceToLine);gl_FragColor=mix(vec4(outlineColor,opacity*aaOpacity),vec4(color,opacity*aaOpacity),lineLerp);if(gl_FragColor.a<0.01){discard;}}"},45313:t=>{t.exports="precision highp float;uniform mat4 projectionMatrix;uniform mat4 modelViewMatrix;attribute vec3 position;varying vec3 vWorldPos;void main(){vWorldPos=position;gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.);}"},22999:t=>{var e={kind:"Document",definitions:[{kind:"OperationDefinition",operation:"query",name:{kind:"Name",value:"GetRoomBounds"},variableDefinitions:[{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"modelId"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"model"},arguments:[{kind:"Argument",name:{kind:"Name",value:"id"},value:{kind:"Variable",name:{kind:"Name",value:"modelId"}}}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"floors"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"layer"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]}]}},{kind:"Field",name:{kind:"Name",value:"vertices"},arguments:[{kind:"Argument",name:{kind:"Name",value:"includeUsed"},value:{kind:"BooleanValue",value:!0}}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"layer"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]}]}},{kind:"Field",name:{kind:"Name",value:"position"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"x"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"y"},arguments:[],directives:[]}]}}]}},{kind:"Field",name:{kind:"Name",value:"edges"},arguments:[{kind:"Argument",name:{kind:"Name",value:"includeUsed"},value:{kind:"BooleanValue",value:!0}}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"layer"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]}]}},{kind:"Field",name:{kind:"Name",value:"type"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"vertices"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]}]}},{kind:"Field",name:{kind:"Name",value:"centerLineBias"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"thickness"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"openings"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"width"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"relativeCenter"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"type"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"height"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"lowerElevation"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"layer"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]}]}}]}}]}}]}},{kind:"Field",name:{kind:"Name",value:"rooms"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"layer"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]}]}},{kind:"Field",name:{kind:"Name",value:"floor"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]}]}},{kind:"Field",name:{kind:"Name",value:"classifications"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"confidence"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"label"},arguments:[],directives:[]}]}},{kind:"Field",name:{kind:"Name",value:"boundary"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"edges"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]}]}},{kind:"Field",name:{kind:"Name",value:"lowerElevation"},arguments:[],directives:[]}]}},{kind:"Field",name:{kind:"Name",value:"dimensionEstimates"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"area"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"areaIndoor"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"width"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"depth"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"units"},arguments:[],directives:[]}]}},{kind:"Field",name:{kind:"Name",value:"label"},arguments:[],directives:[]}]}}]}}]}},{kind:"OperationDefinition",operation:"query",name:{kind:"Name",value:"GetRoomClassifications"},variableDefinitions:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"roomClassifications"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"label"},arguments:[],directives:[]}]}}]}}],loc:{start:0,end:967}};e.loc.source={body:"query GetRoomBounds($modelId: ID!) {\n  model(id: $modelId) {\n    floors {\n      id\n      layer { id }\n      vertices(includeUsed: true) {\n        id\n        layer { id }\n        position {\n          x\n          y\n        }\n      }\n      edges(includeUsed: true) {\n        id\n        layer { id }\n        type\n        vertices { id }\n        centerLineBias\n        thickness\n        openings {\n          id\n          width\n          relativeCenter\n          type\n          height\n          lowerElevation\n          layer { id }\n        }\n      }\n    }\n    rooms {\n      id\n      layer { id }\n      floor { id }\n      classifications {\n        id\n        confidence\n        label\n      }\n      boundary {\n        edges { id }\n        lowerElevation\n      }\n      dimensionEstimates {\n        area\n        areaIndoor\n        width\n        depth\n        units\n      }\n      label\n    }\n  }\n}\n\nquery GetRoomClassifications {\n   roomClassifications {\n    id\n    label\n  }\n}",name:"GraphQL request",locationOffset:{line:1,column:1}};function i(t,e){if("FragmentSpread"===t.kind)e.add(t.name.value);else if("VariableDefinition"===t.kind){var s=t.type;"NamedType"===s.kind&&e.add(s.name.value)}t.selectionSet&&t.selectionSet.selections.forEach((function(t){i(t,e)})),t.variableDefinitions&&t.variableDefinitions.forEach((function(t){i(t,e)})),t.definitions&&t.definitions.forEach((function(t){i(t,e)}))}var s={};function o(t,e){for(var i=0;i<t.definitions.length;i++){var s=t.definitions[i];if(s.name&&s.name.value==e)return s}}function a(t,e){var i={kind:t.kind,definitions:[o(t,e)]};t.hasOwnProperty("loc")&&(i.loc=t.loc);var a=s[e]||new Set,n=new Set,r=new Set;for(a.forEach((function(t){r.add(t)}));r.size>0;){var d=r;r=new Set,d.forEach((function(t){n.has(t)||(n.add(t),(s[t]||new Set).forEach((function(t){r.add(t)})))}))}return n.forEach((function(e){var s=o(t,e);s&&i.definitions.push(s)})),i}e.definitions.forEach((function(t){if(t.name){var e=new Set;i(t,e),s[t.name.value]=e}})),t.exports=e,t.exports.GetRoomBounds=a(e,"GetRoomBounds"),t.exports.GetRoomClassifications=a(e,"GetRoomClassifications")}}]);